databaseChangeLog:
  - changeSet:
      id: 0001-create-help-table
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: CREATE EXTENSION IF NOT EXISTS "vector";
        - createTable:
            tableName: help_content
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: message
                  type: TEXT
                  constraints:
                    nullable: false
  - changeSet:
      id: 0002-insert-initial-help-message
      author: ai-advent
      context: local,prod
      changes:
        - insert:
            tableName: help_content
            columns:
              - column:
                  name: message
                  value: 'AI Advent Challenge: explore available endpoints via /help.'
  - changeSet:
      id: 0003-update-help-message-api-prefix
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            sql: >
              UPDATE help_content
              SET message = 'AI Advent Challenge: explore available endpoints via /api/help.'
              WHERE message = 'AI Advent Challenge: explore available endpoints via /help.';
  - changeSet:
      id: 0004-create-chat-tables
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: CREATE EXTENSION IF NOT EXISTS "pgcrypto";
        - createTable:
            tableName: chat_session
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - createTable:
            tableName: chat_message
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: role
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: content
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: sequence_number
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: chat_message
            baseColumnNames: session_id
            referencedTableName: chat_session
            referencedColumnNames: id
            constraintName: fk_chat_message_session
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: chat_message
            columnNames: session_id, sequence_number
            constraintName: uq_chat_message_session_sequence
        - createIndex:
            tableName: chat_message
            indexName: idx_chat_message_session_sequence
            columns:
              - column:
                  name: session_id
              - column:
                  name: sequence_number
  - changeSet:
      id: 0005-create-chat-memory-window
      author: ai-advent
      context: local,prod
      changes:
        - createTable:
            tableName: chat_memory_message
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: message_order
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: role
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: content
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: metadata
                  type: TEXT
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: chat_memory_message
            baseColumnNames: session_id
            referencedTableName: chat_session
            referencedColumnNames: id
            constraintName: fk_chat_memory_session
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: chat_memory_message
            columnNames: session_id, message_order
            constraintName: uq_chat_memory_session_order
        - createIndex:
            tableName: chat_memory_message
            indexName: idx_chat_memory_session_order
            columns:
              - column:
                  name: session_id
              - column:
                  name: message_order
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              INSERT INTO chat_memory_message (id, session_id, message_order, role, content, metadata, created_at)
              SELECT gen_random_uuid(), session_id, message_order, role, content, metadata, created_at
              FROM (
                SELECT
                  cm.session_id,
                  cm.role,
                  cm.content,
                  '{}' AS metadata,
                  cm.created_at,
                  ROW_NUMBER() OVER (PARTITION BY cm.session_id ORDER BY cm.sequence_number ASC) AS message_order,
                  ROW_NUMBER() OVER (PARTITION BY cm.session_id ORDER BY cm.sequence_number DESC) AS rn
                FROM chat_message cm
              ) latest
              WHERE latest.rn <= 20
              ORDER BY latest.session_id, latest.message_order;
  - changeSet:
      id: 0006-extend-chat-message-with-provider
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: chat_message
            columns:
              - column:
                  name: provider
                  type: VARCHAR(64)
              - column:
                  name: model
                  type: VARCHAR(128)
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              UPDATE chat_message
              SET provider = COALESCE(provider, 'z.ai'),
                  model = COALESCE(model, 'glm-4.6');
