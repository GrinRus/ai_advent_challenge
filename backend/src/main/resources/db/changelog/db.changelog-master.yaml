databaseChangeLog:
  - changeSet:
      id: 0001-create-help-table
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: CREATE EXTENSION IF NOT EXISTS "vector";
        - createTable:
            tableName: help_content
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: message
                  type: TEXT
                  constraints:
                    nullable: false
  - changeSet:
      id: 0002-insert-initial-help-message
      author: ai-advent
      context: local,prod
      changes:
        - insert:
            tableName: help_content
            columns:
              - column:
                  name: message
                  value: 'AI Advent Challenge: explore available endpoints via /help.'
  - changeSet:
      id: 0003-update-help-message-api-prefix
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            sql: >
              UPDATE help_content
              SET message = 'AI Advent Challenge: explore available endpoints via /api/help.'
              WHERE message = 'AI Advent Challenge: explore available endpoints via /help.';
  - changeSet:
      id: 0004-create-chat-tables
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: CREATE EXTENSION IF NOT EXISTS "pgcrypto";
        - createTable:
            tableName: chat_session
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - createTable:
            tableName: chat_message
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: role
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: content
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: sequence_number
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: chat_message
            baseColumnNames: session_id
            referencedTableName: chat_session
            referencedColumnNames: id
            constraintName: fk_chat_message_session
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: chat_message
            columnNames: session_id, sequence_number
            constraintName: uq_chat_message_session_sequence
        - createIndex:
            tableName: chat_message
            indexName: idx_chat_message_session_sequence
            columns:
              - column:
                  name: session_id
              - column:
                  name: sequence_number
  - changeSet:
      id: 0005-create-chat-memory-window
      author: ai-advent
      context: local,prod
      changes:
        - createTable:
            tableName: chat_memory_message
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: message_order
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: role
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: content
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: metadata
                  type: TEXT
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: chat_memory_message
            baseColumnNames: session_id
            referencedTableName: chat_session
            referencedColumnNames: id
            constraintName: fk_chat_memory_session
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: chat_memory_message
            columnNames: session_id, message_order
            constraintName: uq_chat_memory_session_order
        - createIndex:
            tableName: chat_memory_message
            indexName: idx_chat_memory_session_order
            columns:
              - column:
                  name: session_id
              - column:
                  name: message_order
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              INSERT INTO chat_memory_message (id, session_id, message_order, role, content, metadata, created_at)
              SELECT gen_random_uuid(), session_id, message_order, role, content, metadata, created_at
              FROM (
                SELECT
                  cm.session_id,
                  cm.role,
                  cm.content,
                  '{}' AS metadata,
                  cm.created_at,
                  ROW_NUMBER() OVER (PARTITION BY cm.session_id ORDER BY cm.sequence_number ASC) AS message_order,
                  ROW_NUMBER() OVER (PARTITION BY cm.session_id ORDER BY cm.sequence_number DESC) AS rn
                FROM chat_message cm
              ) latest
              WHERE latest.rn <= 20
              ORDER BY latest.session_id, latest.message_order;
  - changeSet:
      id: 0006-extend-chat-message-with-provider
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: chat_message
            columns:
              - column:
                  name: provider
                  type: VARCHAR(64)
              - column:
                  name: model
                  type: VARCHAR(128)
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              UPDATE chat_message
              SET provider = COALESCE(provider, 'z.ai'),
                  model = COALESCE(model, 'glm-4.6');
  - changeSet:
      id: 0007-add-structured-payload-to-chat-message
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: chat_message
            columns:
              - column:
                  name: structured_payload
                  type: JSONB
        - createIndex:
            tableName: chat_message
            indexName: idx_chat_message_session_created_at
            columns:
              - column:
                  name: session_id
              - column:
                  name: created_at
  - changeSet:
      id: 0008-add-usage-cost-to-chat-message
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: chat_message
            columns:
              - column:
                  name: prompt_tokens
                  type: BIGINT
              - column:
                  name: completion_tokens
                  type: BIGINT
              - column:
                  name: total_tokens
                  type: BIGINT
              - column:
                  name: input_cost
                  type: NUMERIC(19, 8)
              - column:
                  name: output_cost
                  type: NUMERIC(19, 8)
              - column:
                  name: currency
                  type: VARCHAR(8)

  - changeSet:
      id: 0009-create-flow-orchestration-tables
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: CREATE EXTENSION IF NOT EXISTS "pgcrypto";
        - createTable:
            tableName: agent_definition
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: identifier
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: display_name
                  type: VARCHAR(256)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: is_active
                  type: BOOLEAN
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - createTable:
            tableName: agent_version
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: agent_definition_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: provider_type
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: provider_id
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: model_id
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: system_prompt
                  type: TEXT
              - column:
                  name: default_options
                  type: JSONB
              - column:
                  name: tool_bindings
                  type: JSONB
              - column:
                  name: cost_profile
                  type: JSONB
              - column:
                  name: sync_only
                  type: BOOLEAN
                  defaultValueBoolean: true
                  constraints:
                    nullable: false
              - column:
                  name: max_tokens
                  type: INT
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: published_at
                  type: TIMESTAMP WITH TIME ZONE
        - addForeignKeyConstraint:
            baseTableName: agent_version
            baseColumnNames: agent_definition_id
            referencedTableName: agent_definition
            referencedColumnNames: id
            constraintName: fk_agent_version_definition
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: agent_version
            columnNames: agent_definition_id, version
            constraintName: uq_agent_version_definition_version
        - createTable:
            tableName: agent_capability
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: agent_version_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: capability
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: payload
                  type: JSONB
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: agent_capability
            baseColumnNames: agent_version_id
            referencedTableName: agent_version
            referencedColumnNames: id
            constraintName: fk_agent_capability_version
            onDelete: CASCADE
        - createTable:
            tableName: flow_definition
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: name
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: is_active
                  type: BOOLEAN
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: definition
                  type: JSONB
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: updated_by
                  type: VARCHAR(128)
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: published_at
                  type: TIMESTAMP WITH TIME ZONE
        - addUniqueConstraint:
            tableName: flow_definition
            columnNames: name, version
            constraintName: uq_flow_definition_name_version
        - createIndex:
            tableName: flow_definition
            indexName: idx_flow_definition_active
            columns:
              - column:
                  name: is_active
        - createTable:
            tableName: flow_definition_history
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_definition_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: definition
                  type: JSONB
                  constraints:
                    nullable: false
              - column:
                  name: change_notes
                  type: TEXT
              - column:
                  name: created_by
                  type: VARCHAR(128)
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_definition_history
            baseColumnNames: flow_definition_id
            referencedTableName: flow_definition
            referencedColumnNames: id
            constraintName: fk_flow_definition_history_definition
            onDelete: CASCADE
        - createTable:
            tableName: flow_session
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_definition_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: flow_definition_version
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: current_step_id
                  type: VARCHAR(128)
              - column:
                  name: state_version
                  type: BIGINT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: current_memory_version
                  type: BIGINT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: launch_parameters
                  type: JSONB
              - column:
                  name: shared_context
                  type: JSONB
              - column:
                  name: telemetry
                  type: JSONB
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: started_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: completed_at
                  type: TIMESTAMP WITH TIME ZONE
        - addForeignKeyConstraint:
            baseTableName: flow_session
            baseColumnNames: flow_definition_id
            referencedTableName: flow_definition
            referencedColumnNames: id
            constraintName: fk_flow_session_definition
        - createIndex:
            tableName: flow_session
            indexName: idx_flow_session_status
            columns:
              - column:
                  name: status
        - createTable:
            tableName: flow_step_execution
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: step_id
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: step_name
                  type: VARCHAR(256)
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: attempt
                  type: INT
                  defaultValueNumeric: 1
                  constraints:
                    nullable: false
              - column:
                  name: agent_version_id
                  type: UUID
              - column:
                  name: prompt
                  type: TEXT
              - column:
                  name: input_payload
                  type: JSONB
              - column:
                  name: output_payload
                  type: JSONB
              - column:
                  name: usage
                  type: JSONB
              - column:
                  name: cost
                  type: JSONB
              - column:
                  name: error_code
                  type: VARCHAR(64)
              - column:
                  name: error_message
                  type: TEXT
              - column:
                  name: started_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: completed_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_step_execution
            baseColumnNames: flow_session_id
            referencedTableName: flow_session
            referencedColumnNames: id
            constraintName: fk_flow_step_execution_session
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: flow_step_execution
            baseColumnNames: agent_version_id
            referencedTableName: agent_version
            referencedColumnNames: id
            constraintName: fk_flow_step_execution_agent_version
        - createIndex:
            tableName: flow_step_execution
            indexName: idx_flow_step_execution_session_step
            columns:
              - column:
                  name: flow_session_id
              - column:
                  name: step_id
        - createTable:
            tableName: flow_memory_version
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: channel
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: data
                  type: JSONB
                  constraints:
                    nullable: false
              - column:
                  name: parent_version_id
                  type: BIGINT
              - column:
                  name: created_by_step_id
                  type: UUID
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_memory_version
            baseColumnNames: flow_session_id
            referencedTableName: flow_session
            referencedColumnNames: id
            constraintName: fk_flow_memory_session
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: flow_memory_version
            columnNames: flow_session_id, channel, version
            constraintName: uq_flow_memory_session_channel_version
        - createIndex:
            tableName: flow_memory_version
            indexName: idx_flow_memory_session_channel_version
            columns:
              - column:
                  name: flow_session_id
              - column:
                  name: channel
              - column:
                  name: version
                  descending: true
        - createTable:
            tableName: flow_event
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: flow_step_execution_id
                  type: UUID
              - column:
                  name: event_type
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
              - column:
                  name: payload
                  type: JSONB
              - column:
                  name: cost
                  type: NUMERIC(19, 8)
              - column:
                  name: tokens_prompt
                  type: INT
              - column:
                  name: tokens_completion
                  type: INT
              - column:
                  name: trace_id
                  type: VARCHAR(128)
              - column:
                  name: span_id
                  type: VARCHAR(128)
              - column:
                  name: usage_source
                  type: VARCHAR(32)
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_event
            baseColumnNames: flow_session_id
            referencedTableName: flow_session
            referencedColumnNames: id
            constraintName: fk_flow_event_session
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: flow_event
            baseColumnNames: flow_step_execution_id
            referencedTableName: flow_step_execution
            referencedColumnNames: id
            constraintName: fk_flow_event_step_execution
        - createIndex:
            tableName: flow_event
            indexName: idx_flow_event_session_created_at
            columns:
              - column:
                  name: flow_session_id
              - column:
                  name: created_at
        - createIndex:
            tableName: flow_event
            indexName: idx_flow_event_step_created_at
            columns:
              - column:
                  name: flow_step_execution_id
              - column:
                  name: created_at
        - createTable:
            tableName: flow_job
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_session_id
                  type: UUID
              - column:
                  name: flow_step_execution_id
                  type: UUID
              - column:
                  name: payload
                  type: JSONB
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: retry_count
                  type: INT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: scheduled_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: locked_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: locked_by
                  type: VARCHAR(128)
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_job
            baseColumnNames: flow_session_id
            referencedTableName: flow_session
            referencedColumnNames: id
            constraintName: fk_flow_job_session
        - addForeignKeyConstraint:
            baseTableName: flow_job
            baseColumnNames: flow_step_execution_id
            referencedTableName: flow_step_execution
            referencedColumnNames: id
            constraintName: fk_flow_job_step_execution
        - createIndex:
            tableName: flow_job
            indexName: idx_flow_job_status_scheduled
            columns:
              - column:
                  name: status
              - column:
                  name: scheduled_at

  - changeSet:
      id: 0010-add-agent-audit-fields
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: agent_definition
            columns:
              - column:
                  name: created_by
                  type: VARCHAR(128)
              - column:
                  name: updated_by
                  type: VARCHAR(128)
        - addColumn:
            tableName: agent_version
            columns:
              - column:
                  name: created_by
                  type: VARCHAR(128)
              - column:
                  name: updated_by
                  type: VARCHAR(128)
  - changeSet:
      id: 0011-add-flow-session-launch-overrides
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: flow_session
            columns:
              - column:
                  name: launch_overrides
                  type: JSONB
  - changeSet:
      id: 0012-create-flow-interaction-tables
      author: ai-advent
      context: local,prod
      changes:
        - createTable:
            tableName: flow_interaction_request
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: flow_step_execution_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: chat_session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: agent_version_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: type
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: title
                  type: VARCHAR(512)
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: payload_schema
                  type: JSONB
              - column:
                  name: suggested_actions
                  type: JSONB
              - column:
                  name: due_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_interaction_request
            baseColumnNames: flow_session_id
            referencedTableName: flow_session
            referencedColumnNames: id
            constraintName: fk_flow_interaction_session
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: flow_interaction_request
            baseColumnNames: flow_step_execution_id
            referencedTableName: flow_step_execution
            referencedColumnNames: id
            constraintName: fk_flow_interaction_step_execution
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: flow_interaction_request
            baseColumnNames: agent_version_id
            referencedTableName: agent_version
            referencedColumnNames: id
            constraintName: fk_flow_interaction_agent_version
        - createIndex:
            tableName: flow_interaction_request
            indexName: idx_flow_interaction_session_status
            columns:
              - column:
                  name: flow_session_id
              - column:
                  name: status
        - createIndex:
            tableName: flow_interaction_request
            indexName: idx_flow_interaction_step
            columns:
              - column:
                  name: flow_step_execution_id
        - createTable:
            tableName: flow_interaction_response
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: request_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: chat_session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: responded_by
                  type: UUID
              - column:
                  name: payload
                  type: JSONB
              - column:
                  name: source
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_interaction_response
            baseColumnNames: request_id
            referencedTableName: flow_interaction_request
            referencedColumnNames: id
            constraintName: fk_flow_interaction_response_request
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: flow_interaction_response
            columnNames: request_id
            constraintName: uq_flow_interaction_response_request
        - createIndex:
            tableName: flow_interaction_response
            indexName: idx_flow_interaction_response_request
            columns:
              - column:
                  name: request_id
  - changeSet:
      id: 0013-add-flow-session-chat-session-id
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: flow_session
            columns:
              - column:
                  name: chat_session_id
                  type: UUID
        - createIndex:
            tableName: flow_session
            indexName: idx_flow_session_chat_session_id
            columns:
              - column:
                  name: chat_session_id
  - changeSet:
      id: 0014-add-interaction-request-reference-to-step
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: flow_step_execution
            columns:
              - column:
                  name: interaction_request_id
                  type: UUID
        - addForeignKeyConstraint:
            baseTableName: flow_step_execution
            baseColumnNames: interaction_request_id
            referencedTableName: flow_interaction_request
            referencedColumnNames: id
            constraintName: fk_flow_step_execution_interaction
            onDelete: SET NULL
        - addUniqueConstraint:
            tableName: flow_step_execution
            columnNames: interaction_request_id
            constraintName: uq_flow_step_execution_interaction
  - changeSet:
      id: 0015-create-chat-memory-summary
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: chat_session
            columns:
              - column:
                  name: summary_until_order
                  type: INT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: summary_metadata
                  type: JSONB
        - createTable:
            tableName: chat_memory_summary
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: source_start_order
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: source_end_order
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: summary_text
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: token_count
                  type: BIGINT
              - column:
                  name: language
                  type: VARCHAR(16)
              - column:
                  name: metadata
                  type: JSONB
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: chat_memory_summary
            baseColumnNames: session_id
            referencedTableName: chat_session
            referencedColumnNames: id
            constraintName: fk_chat_memory_summary_session
            onDelete: CASCADE
        - createIndex:
            tableName: chat_memory_summary
            indexName: idx_chat_memory_summary_session_range
            columns:
              - column:
                  name: session_id
              - column:
                  name: source_start_order
              - column:
                  name: source_end_order
  - changeSet:
      id: 0016-create-flow-memory-summary
      author: ai-advent
      context: local,prod
      changes:
        - createTable:
            tableName: flow_memory_summary
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: channel
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: step_id
                  type: VARCHAR(128)
              - column:
                  name: agent_version_id
                  type: UUID
              - column:
                  name: attempt_start
                  type: INT
              - column:
                  name: attempt_end
                  type: INT
              - column:
                  name: source_version_start
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: source_version_end
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: summary_text
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: token_count
                  type: BIGINT
              - column:
                  name: language
                  type: VARCHAR(16)
              - column:
                  name: metadata
                  type: JSONB
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_memory_summary
            baseColumnNames: flow_session_id
            referencedTableName: flow_session
            referencedColumnNames: id
            constraintName: fk_flow_memory_summary_session
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: flow_memory_summary
            baseColumnNames: agent_version_id
            referencedTableName: agent_version
            referencedColumnNames: id
            constraintName: fk_flow_memory_summary_agent_version
        - createIndex:
            tableName: flow_memory_summary
            indexName: idx_flow_memory_summary_session_channel
            columns:
              - column:
                  name: flow_session_id
              - column:
                  name: channel
        - createIndex:
            tableName: flow_memory_summary
            indexName: idx_flow_memory_summary_step_attempt
            columns:
              - column:
                  name: step_id
              - column:
                  name: attempt_start
              - column:
                  name: attempt_end
  - changeSet:
      id: 0017-extend-flow-memory-version-metadata
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: flow_memory_version
            columns:
              - column:
                  name: source_type
                  type: VARCHAR(32)
              - column:
                  name: step_id
                  type: VARCHAR(128)
              - column:
                  name: step_attempt
                  type: INT
              - column:
                  name: agent_version_id
                  type: UUID
  - changeSet:
      id: 20240608-agent-invocation-options
      author: codex
      context: local,prod
      changes:
        - addColumn:
            tableName: agent_version
            columns:
              - column:
                  name: agent_invocation_options
                  type: JSONB
                  defaultValueComputed: "'{}'::jsonb"
                  constraints:
                    nullable: false
        - dropColumn:
            tableName: agent_version
            columnName: default_options
        - dropColumn:
            tableName: agent_version
            columnName: tool_bindings
        - dropColumn:
            tableName: agent_version
            columnName: cost_profile
        - createTable:
            tableName: tool_schema_version
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: tool_code
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: request_schema
                  type: JSONB
              - column:
                  name: response_schema
                  type: JSONB
              - column:
                  name: schema_checksum
                  type: VARCHAR(64)
              - column:
                  name: examples
                  type: JSONB
              - column:
                  name: mcp_server
                  type: VARCHAR(128)
              - column:
                  name: mcp_tool_name
                  type: VARCHAR(128)
              - column:
                  name: transport
                  type: VARCHAR(64)
              - column:
                  name: auth_scope
                  type: VARCHAR(128)
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addUniqueConstraint:
            tableName: tool_schema_version
            columnNames: tool_code, version
            constraintName: uq_tool_schema_version_code_version
        - createTable:
            tableName: tool_definition
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: code
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: display_name
                  type: VARCHAR(160)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: provider_hint
                  type: VARCHAR(64)
              - column:
                  name: call_type
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: tags
                  type: JSONB
              - column:
                  name: capabilities
                  type: JSONB
              - column:
                  name: cost_hint
                  type: VARCHAR(128)
              - column:
                  name: icon_url
                  type: VARCHAR(256)
              - column:
                  name: default_timeout_ms
                  type: BIGINT
              - column:
                  name: schema_version_id
                  type: UUID
        - addForeignKeyConstraint:
            baseTableName: tool_definition
            baseColumnNames: schema_version_id
            referencedTableName: tool_schema_version
            referencedColumnNames: id
            constraintName: fk_tool_definition_schema_version
            onDelete: SET NULL
        - sql:
            splitStatements: false
            sql: |
              TRUNCATE TABLE flow_event,
                              flow_step_execution,
                              flow_job,
                              flow_memory_version,
                              flow_session,
                              flow_definition_history,
                              flow_definition,
                              agent_capability,
                              agent_version,
                              agent_definition
              RESTART IDENTITY CASCADE;
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('openai-gpt-4o', 1, '{}'::jsonb, '{}'::jsonb, 'checksum-openai-gpt-4o-v1', '[]'::jsonb, NULL, NULL, 'https', NULL),
                ('perplexity-research', 1, '{"type":"object","properties":{"query":{"type":"string"},"locale":{"type":"string"}},"required":["query"]}'::jsonb, '{"type":"object","properties":{"answer":{"type":"string"},"sources":{"type":"array","items":{"type":"object","properties":{"title":{"type":"string"},"url":{"type":"string"}}}}}}'::jsonb, 'checksum-perplexity-v1', '[]'::jsonb, 'perplexity', 'perplexity_research', 'stdio', 'perplexity');

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('openai-gpt-4o', 'OpenAI GPT-4o', 'General purpose chat completion model', 'openai', 'AUTO', '["llm","chat"]'::jsonb, '["completion"]'::jsonb, 'See OpenAI pricing', NULL, 30000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'openai-gpt-4o' AND version = 1)),
                ('perplexity-research', 'Perplexity Research', 'Live research via MCP server', 'perplexity', 'AUTO', '["research","search"]'::jsonb, '["web-search"]'::jsonb, 'Usage billed by Perplexity', NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'perplexity-research' AND version = 1));

              INSERT INTO agent_definition (id, identifier, display_name, description, is_active, created_at, updated_at, updated_by)
              VALUES
                (gen_random_uuid(), 'demo-openai-chat', 'Demo OpenAI Chat', 'Sample agent using OpenAI GPT-4o', true, now(), now(), 'seed'),
                (gen_random_uuid(), 'demo-researcher', 'Demo Researcher', 'Research agent leveraging Perplexity MCP tool', true, now(), now(), 'seed');

              WITH defs AS (
                SELECT id, identifier FROM agent_definition
              )
              INSERT INTO agent_version (
                id,
                agent_definition_id,
                version,
                status,
                provider_type,
                provider_id,
                model_id,
                system_prompt,
                agent_invocation_options,
                sync_only,
                max_tokens,
                created_by,
                updated_by,
                created_at,
                published_at)
              VALUES
                (gen_random_uuid(),
                 (SELECT id FROM defs WHERE identifier = 'demo-openai-chat'),
                 1,
                 'PUBLISHED',
                 'OPENAI',
                 'openai',
                 'gpt-4o',
                 'You are a helpful assistant that answers concisely.',
                 '{"provider":{"type":"OPENAI","id":"openai","modelId":"gpt-4o","mode":"SYNC"},"prompt":{"templateId":null,"system":null,"variables":[],"generation":{"temperature":0.2,"topP":0.9,"maxOutputTokens":800}},"memoryPolicy":{"channels":["shared","conversation"],"retentionDays":14,"maxEntries":100,"summarizationStrategy":"TAIL_WITH_SUMMARY","overflowAction":"TRIM_OLDEST"},"retryPolicy":{"maxAttempts":3,"initialDelayMs":250,"multiplier":2.0,"retryableStatuses":[429,500,502,503,504],"timeoutMs":30000,"overallDeadlineMs":90000,"jitterMs":100},"advisorSettings":{"telemetry":{"enabled":true},"audit":{"enabled":true,"redactPii":true},"routing":{"enabled":false}},"tooling":{"bindings":[]},"costProfile":{"inputPer1KTokens":0.01,"outputPer1KTokens":0.03,"currency":"USD"}}'::jsonb,
                 true,
                 1200,
                 'seed',
                 'seed',
                 now(),
                 now()),
                (gen_random_uuid(),
                 (SELECT id FROM defs WHERE identifier = 'demo-researcher'),
                 1,
                 'PUBLISHED',
                 'OPENAI',
                 'openai',
                 'gpt-4o-mini',
                 'You are an analyst that performs web research and summarizes findings.',
                 '{"provider":{"type":"OPENAI","id":"openai","modelId":"gpt-4o-mini","mode":"SYNC"},"prompt":{"templateId":null,"system":null,"variables":[],"generation":{"temperature":0.1,"topP":0.9,"maxOutputTokens":900}},"memoryPolicy":{"channels":["shared","conversation"],"retentionDays":30,"maxEntries":200,"summarizationStrategy":"TAIL_WITH_SUMMARY","overflowAction":"TRIM_OLDEST"},"retryPolicy":{"maxAttempts":4,"initialDelayMs":300,"multiplier":2.0,"retryableStatuses":[429,500,502,503,504],"timeoutMs":45000,"overallDeadlineMs":120000,"jitterMs":150},"advisorSettings":{"telemetry":{"enabled":true},"audit":{"enabled":true,"redactPii":true},"routing":{"enabled":false}},"tooling":{"bindings":[{"toolCode":"perplexity-research","schemaVersion":1,"executionMode":"AUTO"}]},"costProfile":{"inputPer1KTokens":0.008,"outputPer1KTokens":0.028,"currency":"USD","latencyFee":0.001}}'::jsonb,
                 true,
                 1400,
                 'seed',
                 'seed',
                 now(),
                 now());

              WITH openai_agent AS (
                SELECT id FROM agent_version
                WHERE version = 1
                  AND agent_definition_id = (SELECT id FROM agent_definition WHERE identifier = 'demo-openai-chat')
              ),
              researcher_agent AS (
                SELECT id FROM agent_version
                WHERE version = 1
                  AND agent_definition_id = (SELECT id FROM agent_definition WHERE identifier = 'demo-researcher')
              )
              INSERT INTO flow_definition (id, name, version, status, definition, is_active, created_at, updated_at, updated_by)
              SELECT
                gen_random_uuid(),
                'demo-lead-qualify',
                1,
                'PUBLISHED',
                jsonb_build_object(
                  'schemaVersion', 1,
                  'metadata', jsonb_build_object('title', 'Demo Lead Qualification', 'description', 'Example flow that gathers lead context and performs research.'),
                  'startStepId', 'gather_context',
                  'syncOnly', true,
                  'launchParameters', jsonb_build_array(jsonb_build_object('name','company','label','Company','type','string','required', true)),
                  'memory', jsonb_build_object('shared', jsonb_build_object('enabled', true)),
                  'steps', jsonb_build_array(
                      jsonb_build_object(
                        'id','gather_context',
                        'name','Gather Context',
                        'agentVersionId', (SELECT id FROM openai_agent),
                        'prompt','Capture the lead details and summarize them.',
                        'overrides', jsonb_build_object('maxTokens', 600),
                        'memoryWrites', jsonb_build_array(jsonb_build_object('channel','shared','mode','AGENT_OUTPUT')),
                        'transitions', jsonb_build_object('onSuccess', jsonb_build_object('next','perform_research'))
                      ),
                      jsonb_build_object(
                        'id','perform_research',
                        'name','Perform Research',
                        'agentVersionId', (SELECT id FROM researcher_agent),
                        'prompt','Use the research tool to find latest mentions and summarize findings.',
                        'memoryReads', jsonb_build_array(jsonb_build_object('channel','shared','limit',5)),
                        'memoryWrites', jsonb_build_array(jsonb_build_object('channel','shared','mode','AGENT_OUTPUT')),
                        'transitions', jsonb_build_object('onSuccess', jsonb_build_object('complete', true))
                      )
                  )
                ),
                true,
                now(),
                now(),
                'seed'
              FROM openai_agent, researcher_agent;
  - changeSet:
      id: 0095-add-blueprint-schema-version-columns
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: flow_definition
            columns:
              - column:
                  name: blueprint_schema_version
                  type: INT
                  defaultValueNumeric: 1
        - addColumn:
            tableName: flow_definition_history
            columns:
              - column:
                  name: blueprint_schema_version
                  type: INT
                  defaultValueNumeric: 1
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              UPDATE flow_definition
              SET blueprint_schema_version =
                COALESCE((definition ->> 'schemaVersion')::INT, 1);
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              UPDATE flow_definition_history
              SET blueprint_schema_version =
                COALESCE((definition ->> 'schemaVersion')::INT, 1);
        - addNotNullConstraint:
            tableName: flow_definition
            columnName: blueprint_schema_version
            columnDataType: INT
        - addNotNullConstraint:
            tableName: flow_definition_history
            columnName: blueprint_schema_version
            columnDataType: INT
  - changeSet:
      id: 0096-update-perplexity-tools
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              DELETE FROM tool_definition WHERE code = 'perplexity-research';
              DELETE FROM tool_schema_version WHERE tool_code = 'perplexity-research';

              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('perplexity_search', 1,
                 '{"type":"object","properties":{"query":{"type":"string","description":"Search query string"},"max_results":{"type":"integer","minimum":1,"maximum":20},"max_tokens_per_page":{"type":"integer","minimum":256,"maximum":2048},"country":{"type":"string","description":"ISO 3166-1 alpha-2 country code"}},"required":["query"]}'::jsonb,
                 '{"type":"object","properties":{"summary":{"type":"string"},"items":{"type":"array","items":{"type":"object","properties":{"title":{"type":"string"},"snippet":{"type":"string"},"url":{"type":"string","format":"uri"},"score":{"type":"number"},"publishedAt":{"type":"string","format":"date-time"}}}},"sources":{"type":"array","items":{"type":"object","properties":{"title":{"type":"string"},"url":{"type":"string","format":"uri"}}}}}}'::jsonb,
                 'checksum-perplexity-search-v1', '[]'::jsonb, 'perplexity', 'perplexity_search', 'stdio', 'perplexity'),
                ('perplexity_deep_research', 1,
                 '{"type":"object","properties":{"query":{"type":"string","description":"Primary research question"},"focus":{"type":"string","description":"Optional focus area to steer the research"},"max_iterations":{"type":"integer","minimum":1,"maximum":5}},"required":["query"]}'::jsonb,
                 '{"type":"object","properties":{"summary":{"type":"string"},"sections":{"type":"array","items":{"type":"object","properties":{"heading":{"type":"string"},"content":{"type":"string"},"sources":{"type":"array","items":{"type":"object","properties":{"title":{"type":"string"},"url":{"type":"string","format":"uri"}}}}}}},"sources":{"type":"array","items":{"type":"object","properties":{"title":{"type":"string"},"url":{"type":"string","format":"uri"}}}}}}'::jsonb,
                 'checksum-perplexity-deep-research-v1', '[]'::jsonb, 'perplexity', 'perplexity_research', 'stdio', 'perplexity');

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('perplexity_search', 'Perplexity Search', 'Real-time web search powered by Perplexity. Returns ranked results with snippet summaries.', 'perplexity', 'AUTO', '["research","search"]'::jsonb, '["web-search"]'::jsonb, 'Billed per search via Perplexity Search API', NULL, 120000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'perplexity_search' AND version = 1)),
                ('perplexity_deep_research', 'Perplexity Deep Research', 'Long-running deep research reports using Perplexity sonar-deep-research.', 'perplexity', 'AUTO', '["research","analysis"]'::jsonb, '["deep-research"]'::jsonb, 'Billed per session via Perplexity API (Sonar Deep Research)', NULL, 300000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'perplexity_deep_research' AND version = 1));

              UPDATE agent_definition
              SET identifier = 'perplexity-research',
                  display_name = 'Perplexity Research',
                  description = 'Perplexity-powered research agent template',
                  updated_at = now()
              WHERE identifier = 'demo-researcher';

              UPDATE agent_version
              SET system_prompt = 'You are a meticulous research analyst. Use the Perplexity MCP tools to gather up-to-date insights and always cite the numbered sources returned by the tool.',
                  agent_invocation_options = '{"provider":{"type":"OPENAI","id":"openai","modelId":"gpt-4o-mini","mode":"SYNC"},"prompt":{"system":"You are a meticulous research analyst. Leverage the Perplexity MCP tooling to collect current information, then provide a concise brief that references numbered sources.","variables":[],"generation":{"temperature":0.1,"topP":0.85,"maxOutputTokens":1200}},"memoryPolicy":{"channels":["shared","conversation"],"retentionDays":30,"maxEntries":200,"summarizationStrategy":"TAIL_WITH_SUMMARY","overflowAction":"TRIM_OLDEST"},"retryPolicy":{"maxAttempts":4,"initialDelayMs":300,"multiplier":2.0,"retryableStatuses":[429,500,502,503,504],"timeoutMs":45000,"overallDeadlineMs":120000,"jitterMs":150},"advisorSettings":{"telemetry":{"enabled":true},"audit":{"enabled":true,"redactPii":true},"routing":{"enabled":false}},"tooling":{"bindings":[{"toolCode":"perplexity_search","schemaVersion":1,"executionMode":"AUTO","requestOverrides":{"max_results":8}},{"toolCode":"perplexity_deep_research","schemaVersion":1,"executionMode":"AUTO","requestOverrides":{"max_iterations":3}}]},"costProfile":{"inputPer1KTokens":0.008,"outputPer1KTokens":0.028,"currency":"USD","latencyFee":0.001}}'::jsonb,
                  provider_id = 'openai',
                  model_id = 'gpt-4o-mini',
                  max_tokens = 1400
              WHERE agent_definition_id = (SELECT id FROM agent_definition WHERE identifier = 'perplexity-research')
                AND version = 1;

              DELETE FROM agent_capability
              WHERE agent_version_id = (
                SELECT id FROM agent_version
                WHERE agent_definition_id = (SELECT id FROM agent_definition WHERE identifier = 'perplexity-research')
                  AND version = 1);

              INSERT INTO agent_capability (agent_version_id, capability, payload)
              VALUES (
                (SELECT id FROM agent_version WHERE agent_definition_id = (SELECT id FROM agent_definition WHERE identifier = 'perplexity-research') AND version = 1),
                'perplexity.tools',
                jsonb_build_object('default', 'perplexity_search', 'options', jsonb_build_array('perplexity_search', 'perplexity_deep_research')));

              UPDATE agent_version
              SET agent_invocation_options = jsonb_set(
                agent_invocation_options,
                '{tooling,bindings}',
                (
                  SELECT jsonb_agg(
                    CASE
                      WHEN binding ->> 'toolCode' ILIKE 'perplexity-research'
                      THEN binding || jsonb_build_object('toolCode', 'perplexity_search')
                      ELSE binding
                    END)
                  FROM jsonb_array_elements(agent_invocation_options #> '{tooling,bindings}') AS binding
                )
              )
              WHERE agent_invocation_options::text ILIKE '%perplexity-research%';
  - changeSet:
      id: 0097-seed-internal-mcp-tools
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('flow_ops.list_flows', 1,
                 '{"type":"object","properties":{"query":{"type":"string","description":"Optional search string"},"status":{"type":"string","description":"Status filter"},"limit":{"type":"integer","minimum":1,"maximum":100}}}'::jsonb,
                 '{"type":"object","properties":{"flows":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string","format":"uuid"},"name":{"type":"string"},"version":{"type":"integer"},"status":{"type":"string"},"active":{"type":"boolean"},"updatedBy":{"type":"string"},"updatedAt":{"type":"string","format":"date-time"},"publishedAt":{"type":"string","format":"date-time"}}}}}}'::jsonb,
                 'checksum-flow_ops.list_flows-v1', '[]'::jsonb, 'flowops', 'flow_ops.list_flows', 'stdio', 'flowops'),
                ('flow_ops.diff_flow_version', 1,
                 '{"type":"object","properties":{"definitionId":{"type":"string","format":"uuid"},"baseVersion":{"type":"integer","minimum":1},"compareVersion":{"type":"integer","minimum":1}},"required":["definitionId"]}'::jsonb,
                 '{"type":"object","properties":{"definitionId":{"type":"string","format":"uuid"},"baseVersion":{"type":"integer"},"compareVersion":{"type":"integer"},"differences":{"type":"array","items":{"type":"object","properties":{"pointer":{"type":"string"},"baseValue":{"type":"string"},"compareValue":{"type":"string"}}}},"baseDefinition":{"type":"string"},"compareDefinition":{"type":"string"}}}'::jsonb,
                 'checksum-flow_ops.diff_flow_version-v1', '[]'::jsonb, 'flowops', 'flow_ops.diff_flow_version', 'stdio', 'flowops'),
                ('flow_ops.validate_blueprint', 1,
                 '{"type":"object","properties":{"blueprint":{"type":"object"},"stepId":{"type":"string"}},"required":["blueprint"]}'::jsonb,
                 '{"type":"object","properties":{"errors":{"type":"array","items":{"type":"object","properties":{"code":{"type":"string"},"message":{"type":"string"},"pointer":{"type":"string"},"stepId":{"type":"string"}}}},"warnings":{"type":"array","items":{"type":"object","properties":{"code":{"type":"string"},"message":{"type":"string"},"pointer":{"type":"string"},"stepId":{"type":"string"}}}}}}'::jsonb,
                 'checksum-flow_ops.validate_blueprint-v1', '[]'::jsonb, 'flowops', 'flow_ops.validate_blueprint', 'stdio', 'flowops'),
                ('flow_ops.publish_flow', 1,
                 '{"type":"object","properties":{"definitionId":{"type":"string","format":"uuid"},"updatedBy":{"type":"string"},"changeNotes":{"type":"string"}},"required":["definitionId"]}'::jsonb,
                 '{"type":"object","properties":{"definitionId":{"type":"string","format":"uuid"},"version":{"type":"integer"},"status":{"type":"string"},"active":{"type":"boolean"},"publishedAt":{"type":"string","format":"date-time"}}}'::jsonb,
                 'checksum-flow_ops.publish_flow-v1', '[]'::jsonb, 'flowops', 'flow_ops.publish_flow', 'stdio', 'flowops'),
                ('flow_ops.rollback_flow', 1,
                 '{"type":"object","properties":{"definitionId":{"type":"string","format":"uuid"},"targetVersion":{"type":"integer","minimum":1},"updatedBy":{"type":"string"},"changeNotes":{"type":"string"}},"required":["definitionId","targetVersion"]}'::jsonb,
                 '{"type":"object","properties":{"definitionId":{"type":"string","format":"uuid"},"version":{"type":"integer"},"status":{"type":"string"},"active":{"type":"boolean"},"publishedAt":{"type":"string","format":"date-time"}}}'::jsonb,
                 'checksum-flow_ops.rollback_flow-v1', '[]'::jsonb, 'flowops', 'flow_ops.rollback_flow', 'stdio', 'flowops'),
                ('agent_ops.list_agents', 1,
                 '{"type":"object","properties":{"query":{"type":"string"},"activeOnly":{"type":"boolean"},"limit":{"type":"integer","minimum":1,"maximum":100}}}'::jsonb,
                 '{"type":"object","properties":{"agents":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string","format":"uuid"},"identifier":{"type":"string"},"displayName":{"type":"string"},"active":{"type":"boolean"},"latestVersion":{"type":"integer"},"latestPublishedVersion":{"type":"integer"},"updatedAt":{"type":"string","format":"date-time"},"createdAt":{"type":"string","format":"date-time"}}}}}}'::jsonb,
                 'checksum-agent_ops.list_agents-v1', '[]'::jsonb, 'agentops', 'agent_ops.list_agents', 'stdio', 'agentops'),
                ('agent_ops.register_agent', 1,
                 '{"type":"object","properties":{"identifier":{"type":"string"},"displayName":{"type":"string"},"description":{"type":"string"},"active":{"type":"boolean"},"createdBy":{"type":"string"},"updatedBy":{"type":"string"}},"required":["identifier","displayName","createdBy"]}'::jsonb,
                 '{"type":"object","properties":{"id":{"type":"string","format":"uuid"},"identifier":{"type":"string"},"displayName":{"type":"string"},"active":{"type":"boolean"},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"}}}'::jsonb,
                 'checksum-agent_ops.register_agent-v1', '[]'::jsonb, 'agentops', 'agent_ops.register_agent', 'stdio', 'agentops'),
                ('agent_ops.preview_dependencies', 1,
                 '{"type":"object","properties":{"definitionId":{"type":"string","format":"uuid"},"identifier":{"type":"string"}}}'::jsonb,
                 '{"type":"object","properties":{"definitionId":{"type":"string","format":"uuid"},"identifier":{"type":"string"},"displayName":{"type":"string"},"active":{"type":"boolean"},"versions":{"type":"array","items":{"type":"object","properties":{"version":{"type":"integer"},"status":{"type":"string"},"providerId":{"type":"string"},"modelId":{"type":"string"},"toolCodes":{"type":"array","items":{"type":"string"}},"createdAt":{"type":"string","format":"date-time"},"publishedAt":{"type":"string","format":"date-time"}}}}}}'::jsonb,
                 'checksum-agent_ops.preview_dependencies-v1', '[]'::jsonb, 'agentops', 'agent_ops.preview_dependencies', 'stdio', 'agentops'),
                ('insight.recent_sessions', 1,
                 '{"type":"object","properties":{"types":{"type":"array","items":{"type":"string"}},"limit":{"type":"integer","minimum":1,"maximum":100}}}'::jsonb,
                 '{"type":"object","properties":{"sessions":{"type":"array","items":{"type":"object","properties":{"type":{"type":"string"},"sessionId":{"type":"string","format":"uuid"},"title":{"type":"string"},"createdAt":{"type":"string","format":"date-time"},"lastActivityAt":{"type":"string","format":"date-time"},"status":{"type":"string"},"flowDefinitionId":{"type":"string","format":"uuid"},"flowDefinitionVersion":{"type":"integer"},"chatSessionId":{"type":"string","format":"uuid"},"messageCount":{"type":"integer"},"stepCount":{"type":"integer"},"summaryPreview":{"type":"string"}}}}}}'::jsonb,
                 'checksum-insight.recent_sessions-v1', '[]'::jsonb, 'insight', 'insight.recent_sessions', 'stdio', 'insight'),
                ('insight.fetch_summary', 1,
                 '{"type":"object","properties":{"sessionId":{"type":"string","format":"uuid"},"type":{"type":"string"},"channel":{"type":"string"}},"required":["sessionId","type"]}'::jsonb,
                 '{"type":"object","properties":{"entries":{"type":"array","items":{"type":"object","properties":{"channel":{"type":"string"},"sourceStart":{"type":"number"},"sourceEnd":{"type":"number"},"summary":{"type":"string"},"tokenCount":{"type":"number"},"language":{"type":"string"},"metadata":{"type":"object"},"createdAt":{"type":"string","format":"date-time"}}}}}}'::jsonb,
                 'checksum-insight.fetch_summary-v1', '[]'::jsonb, 'insight', 'insight.fetch_summary', 'stdio', 'insight'),
                ('insight.search_memory', 1,
                 '{"type":"object","properties":{"sessionId":{"type":"string","format":"uuid"},"type":{"type":"string"},"query":{"type":"string"},"channel":{"type":"string"},"limit":{"type":"integer","minimum":1,"maximum":100}},"required":["sessionId","type","query"]}'::jsonb,
                 '{"type":"object","properties":{"matches":{"type":"array","items":{"type":"object","properties":{"resourceType":{"type":"string"},"channel":{"type":"string"},"content":{"type":"string"},"createdAt":{"type":"string","format":"date-time"},"sequenceNumber":{"type":"integer"},"version":{"type":"number"},"stepId":{"type":"string"},"stepAttempt":{"type":"integer"},"sourceStart":{"type":"number"},"sourceEnd":{"type":"number"},"messageId":{"type":"string","format":"uuid"},"payload":{"type":"object"}}}}}}'::jsonb,
                 'checksum-insight.search_memory-v1', '[]'::jsonb, 'insight', 'insight.search_memory', 'stdio', 'insight'),
                ('insight.fetch_metrics', 1,
                '{"type":"object","properties":{"sessionId":{"type":"string","format":"uuid"},"type":{"type":"string"}},"required":["sessionId","type"]}'::jsonb,
                 '{"type":"object","properties":{"sessionId":{"type":"string","format":"uuid"},"status":{"type":"string"},"startedAt":{"type":"string","format":"date-time"},"completedAt":{"type":"string","format":"date-time"},"lastUpdatedAt":{"type":"string","format":"date-time"},"stepsCompleted":{"type":"integer"},"stepsFailed":{"type":"integer"},"retriesScheduled":{"type":"integer"},"totalCostUsd":{"type":"number"},"promptTokens":{"type":"integer"},"completionTokens":{"type":"integer"}}}'::jsonb,
                 'checksum-insight.fetch_metrics-v1', '[]'::jsonb, 'insight', 'insight.fetch_metrics', 'stdio', 'insight');

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('flow_ops.list_flows', 'Flow Ops  List flows', 'List flow definitions with optional filtering.', 'flowops', 'MANUAL', '["flow-ops","catalog"]'::jsonb, '["flow-management"]'::jsonb, 'Internal service call', NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'flow_ops.list_flows' AND version = 1)),
                ('flow_ops.diff_flow_version', 'Flow Ops  Diff versions', 'Compare two versions of a flow blueprint and highlight differences.', 'flowops', 'MANUAL', '["flow-ops","diff"]'::jsonb, '["flow-management"]'::jsonb, 'Internal service call', NULL, 90000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'flow_ops.diff_flow_version' AND version = 1)),
                ('flow_ops.validate_blueprint', 'Flow Ops  Validate blueprint', 'Run blueprint validation and return warnings and errors.', 'flowops', 'MANUAL', '["flow-ops","validation"]'::jsonb, '["flow-management"]'::jsonb, 'Internal service call', NULL, 90000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'flow_ops.validate_blueprint' AND version = 1)),
                ('flow_ops.publish_flow', 'Flow Ops  Publish flow', 'Publish a new version of a flow definition.', 'flowops', 'MANUAL', '["flow-ops","publish"]'::jsonb, '["flow-management"]'::jsonb, 'Internal service call', NULL, 120000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'flow_ops.publish_flow' AND version = 1)),
                ('flow_ops.rollback_flow', 'Flow Ops  Rollback flow', 'Rollback a flow to a previous blueprint version and publish it.', 'flowops', 'MANUAL', '["flow-ops","rollback"]'::jsonb, '["flow-management"]'::jsonb, 'Internal service call', NULL, 120000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'flow_ops.rollback_flow' AND version = 1)),
                ('agent_ops.list_agents', 'Agent Ops  List agents', 'List agent definitions with filters for identifier and active status.', 'agentops', 'MANUAL', '["agent-ops","catalog"]'::jsonb, '["agent-management"]'::jsonb, 'Internal service call', NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'agent_ops.list_agents' AND version = 1)),
                ('agent_ops.register_agent', 'Agent Ops  Register agent', 'Create a new agent definition in the catalog.', 'agentops', 'MANUAL', '["agent-ops","create"]'::jsonb, '["agent-management"]'::jsonb, 'Internal service call', NULL, 90000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'agent_ops.register_agent' AND version = 1)),
                ('agent_ops.preview_dependencies', 'Agent Ops  Preview dependencies', 'Inspect the dependencies and bound tools for an agent definition.', 'agentops', 'MANUAL', '["agent-ops","inspect"]'::jsonb, '["agent-management"]'::jsonb, 'Internal service call', NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'agent_ops.preview_dependencies' AND version = 1)),
                ('insight.recent_sessions', 'Insight  Recent sessions', 'Fetch recent chat and flow sessions including status and summaries.', 'insight', 'MANUAL', '["insight","analytics"]'::jsonb, '["observability"]'::jsonb, 'Internal service call', NULL, 45000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'insight.recent_sessions' AND version = 1)),
                ('insight.fetch_summary', 'Insight  Fetch summary', 'Retrieve stored summaries for a session and channel.', 'insight', 'MANUAL', '["insight","analytics"]'::jsonb, '["observability"]'::jsonb, 'Internal service call', NULL, 45000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'insight.fetch_summary' AND version = 1)),
                ('insight.search_memory', 'Insight  Search memory', 'Search session memory for matching content and payloads.', 'insight', 'MANUAL', '["insight","search"]'::jsonb, '["observability"]'::jsonb, 'Internal service call', NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'insight.search_memory' AND version = 1)),
                ('insight.fetch_metrics', 'Insight  Fetch metrics', 'Return telemetry snapshot for a flow session.', 'insight', 'MANUAL', '["insight","metrics"]'::jsonb, '["observability"]'::jsonb, 'Internal service call', NULL, 45000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'insight.fetch_metrics' AND version = 1));

              INSERT INTO agent_definition (id, identifier, display_name, description, is_active, created_by, updated_by, created_at, updated_at)
              VALUES
                (gen_random_uuid(), 'flow-ops-operator', 'Flow Ops Operator', 'Default template for managing flow definitions via Flow Ops MCP tools.', true, 'seed', 'seed', now(), now()),
                (gen_random_uuid(), 'agent-ops-admin', 'Agent Ops Administrator', 'Template agent for administering the agent catalog through Agent Ops MCP.', true, 'seed', 'seed', now(), now()),
                (gen_random_uuid(), 'insight-analyst', 'Insight Analyst', 'Template agent for analysing chat and flow telemetry with Insight MCP.', true, 'seed', 'seed', now(), now());

              INSERT INTO agent_version (
                id,
                agent_definition_id,
                version,
                status,
                provider_type,
                provider_id,
                model_id,
                system_prompt,
                agent_invocation_options,
                sync_only,
                max_tokens,
                created_by,
                updated_by,
                created_at,
                published_at)
              VALUES
                (gen_random_uuid(),
                 (SELECT id FROM agent_definition WHERE identifier = 'flow-ops-operator'),
                 1,
                 'PUBLISHED',
                 'OPENAI',
                 'openai',
                 'gpt-4o-mini',
                 'You are a flow operations assistant. Use the Flow Ops MCP tools to inspect definitions, validate blueprints, and manage releases. Ask for confirmation before publish or rollback.',
                 '{"provider":{"type":"OPENAI","id":"openai","modelId":"gpt-4o-mini","mode":"SYNC"},"prompt":{"system":"You are a flow operations assistant. Use the Flow Ops MCP tools to inspect definitions, validate blueprints, and manage releases. Ask for confirmation before publish or rollback.","variables":[],"generation":{"temperature":0.15,"topP":0.85,"maxOutputTokens":900}},"memoryPolicy":{"channels":["shared","conversation"],"retentionDays":14,"maxEntries":150,"summarizationStrategy":"TAIL_WITH_SUMMARY","overflowAction":"TRIM_OLDEST"},"retryPolicy":{"maxAttempts":3,"initialDelayMs":250,"multiplier":2.0,"retryableStatuses":[429,500,502,503,504],"timeoutMs":45000,"overallDeadlineMs":120000,"jitterMs":150},"advisorSettings":{"telemetry":{"enabled":true},"audit":{"enabled":true,"redactPii":true},"routing":{"enabled":false}},"tooling":{"bindings":[{"toolCode":"flow_ops.list_flows","schemaVersion":1,"executionMode":"MANUAL"},{"toolCode":"flow_ops.diff_flow_version","schemaVersion":1,"executionMode":"MANUAL"},{"toolCode":"flow_ops.validate_blueprint","schemaVersion":1,"executionMode":"MANUAL"},{"toolCode":"flow_ops.publish_flow","schemaVersion":1,"executionMode":"MANUAL"},{"toolCode":"flow_ops.rollback_flow","schemaVersion":1,"executionMode":"MANUAL"}]},"costProfile":{"inputPer1KTokens":0.008,"outputPer1KTokens":0.028,"currency":"USD"}}'::jsonb,
                 true,
                 1100,
                 'seed',
                 'seed',
                 now(),
                 now()),
                (gen_random_uuid(),
                 (SELECT id FROM agent_definition WHERE identifier = 'agent-ops-admin'),
                 1,
                 'PUBLISHED',
                 'OPENAI',
                 'openai',
                 'gpt-4o-mini',
                 'You are an agent catalog administrator. Use the Agent Ops MCP tools to list, register, and inspect agents. Always confirm destructive actions with the user.',
                 '{"provider":{"type":"OPENAI","id":"openai","modelId":"gpt-4o-mini","mode":"SYNC"},"prompt":{"system":"You are an agent catalog administrator. Use the Agent Ops MCP tools to list, register, and inspect agents. Always confirm destructive actions with the user.","variables":[],"generation":{"temperature":0.2,"topP":0.85,"maxOutputTokens":850}},"memoryPolicy":{"channels":["shared","conversation"],"retentionDays":14,"maxEntries":120,"summarizationStrategy":"TAIL_WITH_SUMMARY","overflowAction":"TRIM_OLDEST"},"retryPolicy":{"maxAttempts":3,"initialDelayMs":250,"multiplier":2.0,"retryableStatuses":[429,500,502,503,504],"timeoutMs":40000,"overallDeadlineMs":100000,"jitterMs":120},"advisorSettings":{"telemetry":{"enabled":true},"audit":{"enabled":true,"redactPii":true},"routing":{"enabled":false}},"tooling":{"bindings":[{"toolCode":"agent_ops.list_agents","schemaVersion":1,"executionMode":"MANUAL"},{"toolCode":"agent_ops.register_agent","schemaVersion":1,"executionMode":"MANUAL"},{"toolCode":"agent_ops.preview_dependencies","schemaVersion":1,"executionMode":"MANUAL"}]},"costProfile":{"inputPer1KTokens":0.008,"outputPer1KTokens":0.028,"currency":"USD"}}'::jsonb,
                 true,
                 900,
                 'seed',
                 'seed',
                 now(),
                 now()),
                (gen_random_uuid(),
                 (SELECT id FROM agent_definition WHERE identifier = 'insight-analyst'),
                 1,
                 'PUBLISHED',
                 'OPENAI',
                 'openai',
                 'gpt-4o-mini',
                 'You are an analytics specialist. Use the Insight MCP tools to review sessions, surface summaries, search memory, and report telemetry trends.',
                 '{"provider":{"type":"OPENAI","id":"openai","modelId":"gpt-4o-mini","mode":"SYNC"},"prompt":{"system":"You are an analytics specialist. Use the Insight MCP tools to review sessions, surface summaries, search memory, and report telemetry trends.","variables":[],"generation":{"temperature":0.15,"topP":0.85,"maxOutputTokens":900}},"memoryPolicy":{"channels":["shared","conversation"],"retentionDays":14,"maxEntries":120,"summarizationStrategy":"TAIL_WITH_SUMMARY","overflowAction":"TRIM_OLDEST"},"retryPolicy":{"maxAttempts":3,"initialDelayMs":250,"multiplier":2.0,"retryableStatuses":[429,500,502,503,504],"timeoutMs":45000,"overallDeadlineMs":120000,"jitterMs":150},"advisorSettings":{"telemetry":{"enabled":true},"audit":{"enabled":true,"redactPii":true},"routing":{"enabled":false}},"tooling":{"bindings":[{"toolCode":"insight.recent_sessions","schemaVersion":1,"executionMode":"MANUAL"},{"toolCode":"insight.fetch_summary","schemaVersion":1,"executionMode":"MANUAL"},{"toolCode":"insight.search_memory","schemaVersion":1,"executionMode":"MANUAL"},{"toolCode":"insight.fetch_metrics","schemaVersion":1,"executionMode":"MANUAL"}]},"costProfile":{"inputPer1KTokens":0.008,"outputPer1KTokens":0.028,"currency":"USD"}}'::jsonb,
                 true,
                 950,
                 'seed',
                 'seed',
                 now(),
                 now());

              INSERT INTO agent_capability (agent_version_id, capability, payload)
              VALUES
                (
                  (SELECT id FROM agent_version WHERE agent_definition_id = (SELECT id FROM agent_definition WHERE identifier = 'flow-ops-operator') AND version = 1),
                  'flow.ops.tools',
                  jsonb_build_object('default', 'flow_ops.list_flows', 'options', jsonb_build_array('flow_ops.list_flows','flow_ops.diff_flow_version','flow_ops.validate_blueprint','flow_ops.publish_flow','flow_ops.rollback_flow'))
                ),
                (
                  (SELECT id FROM agent_version WHERE agent_definition_id = (SELECT id FROM agent_definition WHERE identifier = 'agent-ops-admin') AND version = 1),
                  'agent.ops.tools',
                  jsonb_build_object('default', 'agent_ops.list_agents', 'options', jsonb_build_array('agent_ops.list_agents','agent_ops.register_agent','agent_ops.preview_dependencies'))
                ),
                (
                  (SELECT id FROM agent_version WHERE agent_definition_id = (SELECT id FROM agent_definition WHERE identifier = 'insight-analyst') AND version = 1),
                  'insight.tools',
                  jsonb_build_object('default', 'insight.recent_sessions', 'options', jsonb_build_array('insight.recent_sessions','insight.fetch_summary','insight.search_memory','insight.fetch_metrics'))
                );
  - changeSet:
      id: 0098-switch-mcp-transport-http
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              UPDATE tool_schema_version
              SET transport = 'http-stream'
              WHERE transport = 'stdio'
                AND (mcp_server IS NULL OR lower(mcp_server) <> 'perplexity');
  - changeSet:
      id: 0099-seed-github-mcp-tools
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('github.list_repository_tree', 1,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","description":"Target repository (owner/name/ref).","properties":{"owner":{"type":"string","description":"Repository owner or organization."},"name":{"type":"string","description":"Repository name."},"ref":{"type":"string","description":"Branch, tag, or commit SHA to resolve."}},"required":["owner","name"]},"path":{"type":"string","description":"Optional directory path to filter tree entries."},"recursive":{"type":"boolean","description":"Fetch entries recursively when true."},"maxDepth":{"type":"integer","minimum":1,"maximum":20,"description":"Maximum depth to traverse (defaults to configuration)."},"maxEntries":{"type":"integer","minimum":1,"maximum":2000,"description":"Maximum number of tree entries to return."}},"required":["repository"]}
                 $$::jsonb,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}}},"resolvedRef":{"type":"string","description":"Commit SHA used to resolve the tree."},"truncated":{"type":"boolean","description":"True when the tree was truncated due to limits."},"entries":{"type":"array","items":{"type":"object","properties":{"path":{"type":"string"},"type":{"type":"string"},"sha":{"type":"string"},"size":{"type":"integer","minimum":0}},"required":["path","type"]}}},"required":["repository","entries"]}
                 $$::jsonb,
                 'checksum-github.list_repository_tree-v1', '[]'::jsonb, 'github', 'github.list_repository_tree', 'http-stream', 'github'),
                ('github.read_file', 1,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","description":"Target repository (owner/name/ref).","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}},"required":["owner","name"]},"path":{"type":"string","description":"File path relative to repository root."}},"required":["repository","path"]}
                 $$::jsonb,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}}},"resolvedRef":{"type":"string"},"file":{"type":"object","properties":{"path":{"type":"string"},"sha":{"type":"string"},"size":{"type":"integer","minimum":0},"encoding":{"type":"string"},"downloadUrl":{"type":"string","format":"uri"},"contentBase64":{"type":"string"},"textContent":{"type":"string"}},"required":["path","sha","size"]},"fetchedAt":{"type":"string","format":"date-time"}},"required":["repository","file"]}
                 $$::jsonb,
                 'checksum-github.read_file-v1', '[]'::jsonb, 'github', 'github.read_file', 'http-stream', 'github'),
                ('github.list_pull_requests', 1,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","description":"Target repository (owner/name/ref).","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}},"required":["owner","name"]},"state":{"type":"string","enum":["open","closed","all"]},"head":{"type":"string","description":"Filter by head reference (user:branch)."},"base":{"type":"string","description":"Filter by base branch."},"limit":{"type":"integer","minimum":1,"maximum":50,"description":"Maximum number of pull requests to return."},"sort":{"type":"string","enum":["created","updated","popularity","long_running"]},"direction":{"type":"string","enum":["asc","desc"]}},"required":["repository"]}
                 $$::jsonb,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}}},"pullRequests":{"type":"array","items":{"type":"object","properties":{"number":{"type":"integer"},"title":{"type":"string"},"state":{"type":"string"},"draft":{"type":"boolean"},"merged":{"type":"boolean"},"author":{"type":"object","properties":{"id":{"type":"integer"},"login":{"type":"string"},"htmlUrl":{"type":"string","format":"uri"},"avatarUrl":{"type":"string","format":"uri"}}},"baseRef":{"type":"string"},"headRef":{"type":"string"},"headSha":{"type":"string"},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"},"closedAt":{"type":"string","format":"date-time"},"mergedAt":{"type":"string","format":"date-time"},"htmlUrl":{"type":"string","format":"uri"}},"required":["number","title","state"]}},"truncated":{"type":"boolean"}},"required":["repository","pullRequests"]}
                 $$::jsonb,
                 'checksum-github.list_pull_requests-v1', '[]'::jsonb, 'github', 'github.list_pull_requests', 'http-stream', 'github'),
                ('github.get_pull_request', 1,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}},"required":["owner","name"]},"number":{"type":"integer","minimum":1}},"required":["repository","number"]}
                 $$::jsonb,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}}},"pullRequest":{"type":"object","properties":{"summary":{"type":"object"},"body":{"type":"string"},"labels":{"type":"array","items":{"type":"object","properties":{"name":{"type":"string"},"color":{"type":"string"},"description":{"type":"string"}}}},"assignees":{"type":"array","items":{"type":"object","properties":{"id":{"type":"integer"},"login":{"type":"string"},"htmlUrl":{"type":"string","format":"uri"}}}},"requestedReviewers":{"type":"array","items":{"type":"object"}},"requestedTeams":{"type":"array","items":{"type":"object"}},"milestone":{"type":"object"},"merge":{"type":"object"},"maintainerCanModify":{"type":"boolean"},"mergeCommitSha":{"type":"string"}}}},"required":["repository","pullRequest"]}
                 $$::jsonb,
                 'checksum-github.get_pull_request-v1', '[]'::jsonb, 'github', 'github.get_pull_request', 'http-stream', 'github'),
                ('github.get_pull_request_diff', 1,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}},"required":["owner","name"]},"number":{"type":"integer","minimum":1},"maxBytes":{"type":"integer","minimum":1,"description":"Maximum diff size in bytes before truncation."}},"required":["repository","number"]}
                 $$::jsonb,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}}},"headSha":{"type":"string"},"diff":{"type":"string","description":"Unified diff payload (may be truncated)."},"truncated":{"type":"boolean"}},"required":["repository","diff"]}
                 $$::jsonb,
                 'checksum-github.get_pull_request_diff-v1', '[]'::jsonb, 'github', 'github.get_pull_request_diff', 'http-stream', 'github'),
                ('github.list_pull_request_comments', 1,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}},"required":["owner","name"]},"number":{"type":"integer","minimum":1},"issueCommentLimit":{"type":"integer","minimum":0,"maximum":200},"reviewCommentLimit":{"type":"integer","minimum":0,"maximum":200}},"required":["repository","number"]}
                 $$::jsonb,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}}},"issueComments":{"type":"array","items":{"type":"object","properties":{"id":{"type":"integer"},"body":{"type":"string"},"author":{"type":"object","properties":{"login":{"type":"string"},"htmlUrl":{"type":"string","format":"uri"}}},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"},"htmlUrl":{"type":"string","format":"uri"}}}},"reviewComments":{"type":"array","items":{"type":"object","properties":{"id":{"type":"integer"},"body":{"type":"string"},"diffHunk":{"type":"string"},"author":{"type":"object","properties":{"login":{"type":"string"},"htmlUrl":{"type":"string","format":"uri"}}},"path":{"type":"string"},"position":{"type":"integer"},"line":{"type":"integer"},"startLine":{"type":"integer"},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"},"htmlUrl":{"type":"string","format":"uri"}}}},"issueCommentsTruncated":{"type":"boolean"},"reviewCommentsTruncated":{"type":"boolean"}},"required":["repository","issueComments","reviewComments"]}
                 $$::jsonb,
                 'checksum-github.list_pull_request_comments-v1', '[]'::jsonb, 'github', 'github.list_pull_request_comments', 'http-stream', 'github'),
                ('github.list_pull_request_checks', 1,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}},"required":["owner","name"]},"number":{"type":"integer","minimum":1},"checkRunLimit":{"type":"integer","minimum":0,"maximum":200},"statusLimit":{"type":"integer","minimum":0,"maximum":200}},"required":["repository","number"]}
                 $$::jsonb,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}}},"pullRequestNumber":{"type":"integer"},"headSha":{"type":"string"},"overallStatus":{"type":"string"},"checkRuns":{"type":"array","items":{"type":"object","properties":{"id":{"type":"integer"},"name":{"type":"string"},"status":{"type":"string"},"conclusion":{"type":"string"},"appSlug":{"type":"string"},"appName":{"type":"string"},"htmlUrl":{"type":"string","format":"uri"},"detailsUrl":{"type":"string","format":"uri"},"startedAt":{"type":"string","format":"date-time"},"completedAt":{"type":"string","format":"date-time"}}}},"statuses":{"type":"array","items":{"type":"object","properties":{"id":{"type":"integer"},"context":{"type":"string"},"state":{"type":"string"},"description":{"type":"string"},"targetUrl":{"type":"string","format":"uri"},"creator":{"type":"object","properties":{"login":{"type":"string"},"htmlUrl":{"type":"string","format":"uri"}}},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"}}}},"checkRunsTruncated":{"type":"boolean"},"statusesTruncated":{"type":"boolean"}},"required":["repository","checkRuns","statuses"]}
                 $$::jsonb,
                 'checksum-github.list_pull_request_checks-v1', '[]'::jsonb, 'github', 'github.list_pull_request_checks', 'http-stream', 'github'),
                ('github.create_pull_request_comment', 1,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}},"required":["owner","name"]},"number":{"type":"integer","minimum":1},"body":{"type":"string","description":"Markdown content of the comment."},"location":{"type":"object","description":"Optional review location when creating a review comment.","properties":{"commitSha":{"type":"string"},"path":{"type":"string"},"line":{"type":"integer"},"startLine":{"type":"integer"},"endLine":{"type":"integer"},"position":{"type":"integer"}}}},"required":["repository","number","body"]}
                 $$::jsonb,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}}},"pullRequestNumber":{"type":"integer"},"type":{"type":"string"},"commentId":{"type":"integer"},"reviewId":{"type":"integer"},"htmlUrl":{"type":"string","format":"uri"},"created":{"type":"boolean"}},"required":["repository","pullRequestNumber","commentId"]}
                 $$::jsonb,
                 'checksum-github.create_pull_request_comment-v1', '[]'::jsonb, 'github', 'github.create_pull_request_comment', 'http-stream', 'github'),
                ('github.create_pull_request_review', 1,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}},"required":["owner","name"]},"number":{"type":"integer","minimum":1},"body":{"type":"string"},"commitId":{"type":"string","description":"Optional head commit SHA to attach review to."},"event":{"type":"string","enum":["APPROVE","REQUEST_CHANGES","COMMENT","PENDING"]},"comments":{"type":"array","items":{"type":"object","properties":{"body":{"type":"string"},"path":{"type":"string"},"line":{"type":"integer"},"startLine":{"type":"integer"},"endLine":{"type":"integer"},"position":{"type":"integer"}},"required":["body","path"]}}},"required":["repository","number"]}
                 $$::jsonb,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}}},"pullRequestNumber":{"type":"integer"},"review":{"type":"object","properties":{"id":{"type":"integer"},"state":{"type":"string"},"htmlUrl":{"type":"string","format":"uri"},"submittedAt":{"type":"string","format":"date-time"}}},"created":{"type":"boolean"}},"required":["repository","pullRequestNumber","review"]}
                 $$::jsonb,
                 'checksum-github.create_pull_request_review-v1', '[]'::jsonb, 'github', 'github.create_pull_request_review', 'http-stream', 'github'),
                ('github.submit_pull_request_review', 1,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}},"required":["owner","name"]},"number":{"type":"integer","minimum":1},"reviewId":{"type":"integer","minimum":1},"body":{"type":"string"},"event":{"type":"string","enum":["APPROVE","REQUEST_CHANGES","COMMENT"]}},"required":["repository","number","reviewId"]}
                 $$::jsonb,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}}},"pullRequestNumber":{"type":"integer"},"review":{"type":"object","properties":{"id":{"type":"integer"},"state":{"type":"string"},"htmlUrl":{"type":"string","format":"uri"},"submittedAt":{"type":"string","format":"date-time"}}}},"required":["repository","pullRequestNumber","review"]}
                 $$::jsonb,
                 'checksum-github.submit_pull_request_review-v1', '[]'::jsonb, 'github', 'github.submit_pull_request_review', 'http-stream', 'github');

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('github.list_repository_tree', 'GitHub  List repository tree', '         .', 'github', 'MANUAL', '["github","tree"]'::jsonb, '["github-read"]'::jsonb, 'GitHub REST API (Personal Access Token).', NULL, 45000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.list_repository_tree' AND version = 1)),
                ('github.read_file', 'GitHub  Read file', '        .', 'github', 'MANUAL', '["github","file"]'::jsonb, '["github-read"]'::jsonb, 'GitHub REST API (Personal Access Token).', NULL, 45000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.read_file' AND version = 1)),
                ('github.list_pull_requests', 'GitHub  List pull requests', ' pull request''    ,   .', 'github', 'MANUAL', '["github","pull-request"]'::jsonb, '["github-read"]'::jsonb, 'GitHub REST API (Personal Access Token).', NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.list_pull_requests' AND version = 1)),
                ('github.get_pull_request', 'GitHub  Get pull request', '   pull request: , ,   merge-.', 'github', 'MANUAL', '["github","pull-request"]'::jsonb, '["github-read"]'::jsonb, 'GitHub REST API (Personal Access Token).', NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.get_pull_request' AND version = 1)),
                ('github.get_pull_request_diff', 'GitHub  Get pull request diff', 'Unified diff  pull request    .', 'github', 'MANUAL', '["github","pull-request","diff"]'::jsonb, '["github-read"]'::jsonb, 'GitHub REST API (Personal Access Token).', NULL, 90000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.get_pull_request_diff' AND version = 1)),
                ('github.list_pull_request_comments', 'GitHub  List pull request comments', ' issue-  review- pull request  .', 'github', 'MANUAL', '["github","pull-request","comments"]'::jsonb, '["github-read"]'::jsonb, 'GitHub REST API (Personal Access Token).', NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.list_pull_request_comments' AND version = 1)),
                ('github.list_pull_request_checks', 'GitHub  List pull request checks', '   check run''  head- pull request.', 'github', 'MANUAL', '["github","pull-request","checks"]'::jsonb, '["github-read"]'::jsonb, 'GitHub REST API (Personal Access Token).', NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.list_pull_request_checks' AND version = 1)),
                ('github.create_pull_request_comment', 'GitHub  Create pull request comment', ' issue-  review-  pull request.', 'github', 'MANUAL', '["github","pull-request","comments"]'::jsonb, '["github-write"]'::jsonb, 'GitHub REST API (Personal Access Token).', NULL, 45000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.create_pull_request_comment' AND version = 1)),
                ('github.create_pull_request_review', 'GitHub  Create pull request review', '  pull request     .', 'github', 'MANUAL', '["github","pull-request","reviews"]'::jsonb, '["github-write"]'::jsonb, 'GitHub REST API (Personal Access Token).', NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.create_pull_request_review' AND version = 1)),
                ('github.submit_pull_request_review', 'GitHub  Submit pull request review', '   pull request   .', 'github', 'MANUAL', '["github","pull-request","reviews"]'::jsonb, '["github-write"]'::jsonb, 'GitHub REST API (Personal Access Token).', NULL, 45000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.submit_pull_request_review' AND version = 1));
  - changeSet:
      id: 0100-seed-github-analysis-flow
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              WITH resolver_def AS (
                INSERT INTO agent_definition (id, identifier, display_name, description, is_active, created_by, updated_by, created_at, updated_at)
                VALUES (
                  gen_random_uuid(),
                  'github-target-resolver',
                  'GitHub Target Resolver',
                  'Determines GitHub repository or pull request targets and normalises owner/name/ref information.',
                  true,
                  'seed',
                  'seed',
                  now(),
                  now())
                ON CONFLICT (identifier) DO NOTHING
                RETURNING id
              ),
              resolver_def_id AS (
                SELECT id FROM resolver_def
                UNION
                SELECT id FROM agent_definition WHERE identifier = 'github-target-resolver'
              ),
              resolver_version_insert AS (
                INSERT INTO agent_version (
                  id,
                  agent_definition_id,
                  version,
                  status,
                  provider_type,
                  provider_id,
                  model_id,
                  system_prompt,
                  agent_invocation_options,
                  sync_only,
                  max_tokens,
                  created_by,
                  updated_by,
                  created_at,
                  published_at)
                SELECT
                  gen_random_uuid(),
                  resolver_def_id.id,
                  1,
                  'PUBLISHED',
                  'OPENAI',
                  'openai',
                  'gpt-4o-mini',
                  'You are a GitHub intake assistant. Using the chat context, launch parameters, and optional interaction payload, determine whether the user wants to analyse a repository or a pull request. Always respond with valid JSON containing fields: status (RESOLVED | NEEDS_CLARIFICATION | UNSUPPORTED), githubTarget (object with type, owner, repository, ref, pullRequestNumber, headRef, baseRef, url), clarificationPrompt, clarificationReason, missingFields (array of strings). When the intent is ambiguous or required data is missing, set status to NEEDS_CLARIFICATION and explain which properties must be provided. Never emit free-form text or markdown.',
                  '{"provider":{"type":"OPENAI","id":"openai","modelId":"gpt-4o-mini","mode":"SYNC"},"prompt":{"templateId":null,"system":null,"variables":[],"generation":{"temperature":0.05,"topP":0.85,"maxOutputTokens":800}},"memoryPolicy":{"channels":["shared","conversation"],"retentionDays":14,"maxEntries":120,"summarizationStrategy":"TAIL_WITH_SUMMARY","overflowAction":"TRIM_OLDEST"},"retryPolicy":{"maxAttempts":3,"initialDelayMs":250,"multiplier":2.0,"retryableStatuses":[429,500,502,503,504],"timeoutMs":45000,"overallDeadlineMs":120000,"jitterMs":150},"advisorSettings":{"telemetry":{"enabled":true},"audit":{"enabled":true,"redactPii":true},"routing":{"enabled":false}},"tooling":{"bindings":[]},"costProfile":{"inputPer1KTokens":0.008,"outputPer1KTokens":0.028,"currency":"USD"}}'::jsonb,
                  true,
                  900,
                  'seed',
                  'seed',
                  now(),
                  now()
                FROM resolver_def_id
                WHERE NOT EXISTS (
                  SELECT 1
                  FROM agent_version av
                  WHERE av.agent_definition_id = resolver_def_id.id
                    AND av.version = 1)
                RETURNING id, agent_definition_id
              ),
              resolver_version_id AS (
                SELECT id, agent_definition_id FROM resolver_version_insert
                UNION
                SELECT id, agent_definition_id
                FROM agent_version
                WHERE agent_definition_id = (SELECT id FROM resolver_def_id LIMIT 1)
                  AND version = 1
              )
              INSERT INTO flow_definition (
                id,
                name,
                version,
                status,
                definition,
                is_active,
                description,
                updated_by,
                created_at,
                updated_at,
                published_at,
                blueprint_schema_version)
              SELECT
                gen_random_uuid(),
                'github-analysis-flow',
                1,
                'PUBLISHED',
                jsonb_build_object(
                  'schemaVersion', 1,
                  'metadata', jsonb_build_object(
                    'title', 'GitHub Analysis Flow',
                    'description', 'Resolves GitHub URLs into repository or pull request targets and prepares analysis context.'),
                  'startStepId', 'github_resolve_target',
                  'syncOnly', true,
                  'launchParameters', jsonb_build_array(
                    jsonb_build_object('name','githubUrl','label','GitHub URL','type','string','required', false)
                  ),
                  'memory', jsonb_build_object('shared', jsonb_build_object('enabled', true)),
                  'steps', jsonb_build_array(
                    jsonb_build_object(
                      'id','github_resolve_target',
                      'name','Resolve GitHub Target',
                      'agentVersionId', resolver_version_id.id::text,
                      'prompt',
                        $$Analyse the conversation and optional interaction payload to determine the GitHub resource the user wants to inspect. When you can resolve an owner, repository name, and target type, return status=RESOLVED with githubTarget fields: type ("REPOSITORY" or "PULL_REQUEST"), owner, repository, ref (branch, tag, or commit), pullRequestNumber (for PR), headRef/baseRef when available, and url. If information is missing or ambiguous, respond with status=NEEDS_CLARIFICATION and populate clarificationPrompt, clarificationReason, and missingFields describing what to ask the user. Never include conversational prose or markdown, only the JSON object.$$,
                      'overrides', jsonb_build_object('temperature', 0.05, 'maxTokens', 750),
                      'interaction', jsonb_build_object(
                        'type', 'INPUT_FORM',
                        'title', ' GitHub ',
                        'description', ' ,    pull request,     .',
                        'payloadSchema', jsonb_build_object(
                          'type', 'object',
                          'properties', jsonb_build_object(
                            'githubUrl', jsonb_build_object(
                              'type', 'string',
                              'format', 'textarea',
                              'description', '     pull request.'),
                            'branch', jsonb_build_object(
                              'type', 'string',
                              'description', '   SHA,   .'),
                            'pullRequestNumber', jsonb_build_object(
                              'type', 'integer',
                              'minimum', 1,
                              'description', ' pull request,   PR.')))),
                      'memoryReads', jsonb_build_array(
                        jsonb_build_object('channel','shared','limit',10),
                        jsonb_build_object('channel','conversation','limit',15)),
                      'memoryWrites', jsonb_build_array(
                        jsonb_build_object('channel','shared','mode','AGENT_OUTPUT'),
                        jsonb_build_object('channel','conversation','mode','AGENT_OUTPUT')),
                      'transitions', jsonb_build_object(
                        'onSuccess', jsonb_build_object('complete', true)),
                      'maxAttempts', 2))
                ),
                true,
                'GitHub analysis orchestrator',
                'seed',
                now(),
                now(),
                now(),
                1
              FROM resolver_version_id
              WHERE NOT EXISTS (
                SELECT 1 FROM flow_definition WHERE name = 'github-analysis-flow');
  - changeSet:
      id: 0101-seed-github-gradle-test-flow
      author: codex
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('github.repository_fetch', 1,
                 $${
                   "type": "object",
                   "properties": {
                     "repository": {
                       "type": "object",
                       "description": "Target repository (owner/name/ref).",
                       "properties": {
                         "owner": {"type": "string"},
                         "name": {"type": "string"},
                         "ref": {"type": "string"}
                       },
                       "required": ["owner","name"]
                     },
                     "requestId": {"type": "string","description": "Optional correlation identifier."},
                     "options": {
                       "type": "object",
                       "properties": {
                         "strategy": {"type": "string","enum": ["ARCHIVE_ONLY","ARCHIVE_WITH_FALLBACK_CLONE","CLONE_WITH_SUBMODULES"]},
                         "shallowClone": {"type": "boolean"},
                         "includeSubmodules": {"type": "boolean"},
                         "cloneTimeout": {"type": "string","description":"ISO-8601 duration"},
                         "archiveTimeout": {"type": "string","description":"ISO-8601 duration"},
                         "archiveSizeLimit": {"type": "integer","minimum": 1},
                         "detectKeyFiles": {"type": "boolean"}
                       }
                     }
                   },
                   "required": ["repository"]
                 }$$::jsonb,
                 $${
                   "type": "object",
                   "properties": {
                     "workspaceId": {"type": "string"},
                     "workspacePath": {"type": "string"},
                     "resolvedRef": {"type": "string"},
                     "commitSha": {"type": "string"},
                     "downloadedBytes": {"type": "integer","minimum": 0},
                     "workspaceSizeBytes": {"type": "integer","minimum": 0},
                     "downloadTimeMs": {"type": "integer","minimum": 0},
                     "strategy": {"type": "string"},
                     "keyFiles": {"type": "array","items":{"type":"string"}},
                     "fetchedAt": {"type": "string","format":"date-time"}
                   },
                   "required": ["workspaceId","workspacePath","commitSha","strategy"]
                 }$$::jsonb,
                 'checksum-github.repository_fetch-v1', '[]'::jsonb, 'github', 'github.repository_fetch', 'http-stream', 'github')
              ON CONFLICT (tool_code, version) DO NOTHING;

              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('github.workspace_directory_inspector', 1,
                 $${
                   "type": "object",
                   "properties": {
                     "workspaceId": {"type": "string"},
                     "includeGlobs": {"type": "array","items":{"type":"string"}},
                     "excludeGlobs": {"type": "array","items":{"type":"string"}},
                     "maxDepth": {"type": "integer","minimum":1,"maximum":20},
                     "maxResults": {"type": "integer","minimum":1,"maximum":2000},
                     "includeTypes": {"type":"array","items":{"type":"string","enum":["FILE","DIRECTORY"]}},
                     "includeHidden": {"type":"boolean"},
                     "detectProjects": {"type":"boolean"}
                   },
                   "required": ["workspaceId"]
                 }$$::jsonb,
                 $${
                   "type": "object",
                   "properties": {
                     "workspaceId": {"type": "string"},
                     "workspacePath": {"type": "string"},
                     "items": {
                       "type": "array",
                       "items": {
                         "type": "object",
                         "properties": {
                           "path": {"type":"string"},
                           "type": {"type":"string"},
                           "sizeBytes": {"type":"integer","minimum":0},
                           "hidden": {"type":"boolean"},
                           "symlink": {"type":"boolean"},
                           "executable": {"type":"boolean"},
                           "lastModified": {"type":"string","format":"date-time"},
                           "projectTypes": {"type":"array","items":{"type":"string"}},
                           "hasGradleWrapper": {"type":"boolean"}
                         },
                         "required": ["path","type"]
                       }
                     },
                     "truncated": {"type":"boolean"},
                     "warnings": {"type":"array","items":{"type":"string"}},
                     "containsMultipleGradleProjects": {"type":"boolean"},
                     "recommendedProjectPath": {"type":"string"},
                     "totalMatches": {"type":"integer","minimum":0},
                     "durationMs": {"type":"integer","minimum":0},
                     "inspectedAt": {"type":"string","format":"date-time"}
                   },
                   "required": ["workspaceId","items","truncated"]
                 }$$::jsonb,
                 'checksum-github.workspace_directory_inspector-v1', '[]'::jsonb, 'github', 'github.workspace_directory_inspector', 'http-stream', 'github')
              ON CONFLICT (tool_code, version) DO NOTHING;

              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('docker.build_runner', 1,
                 $${
                   "type": "object",
                   "properties": {
                     "workspaceId": {"type":"string"},
                     "projectPath": {"type":"string"},
                     "tasks": {"type":"array","items":{"type":"string"}},
                     "arguments": {"type":"array","items":{"type":"string"}},
                     "env": {"type":"object","additionalProperties":{"type":"string"}},
                     "timeoutSeconds": {"type":"integer","minimum":1}
                   },
                   "required": ["workspaceId"]
                 }$$::jsonb,
                 $${
                   "type": "object",
                   "properties": {
                     "workspaceId": {"type":"string"},
                     "projectPath": {"type":"string"},
                     "runnerExecutable": {"type":"string"},
                     "dockerCommand": {"type":"array","items":{"type":"string"}},
                     "exitCode": {"type":"integer"},
                     "status": {"type":"string"},
                     "stdout": {"type":"array","items":{"type":"string"}},
                     "stderr": {"type":"array","items":{"type":"string"}},
                     "durationMs": {"type":"integer","minimum":0},
                     "startedAt": {"type":"string","format":"date-time"},
                     "finishedAt": {"type":"string","format":"date-time"}
                   },
                   "required": ["workspaceId","runnerExecutable","exitCode","status"]
                 }$$::jsonb,
                 'checksum-docker.build_runner-v1', '[]'::jsonb, 'docker', 'docker.build_runner', 'http-stream', 'docker')
              ON CONFLICT (tool_code, version) DO NOTHING;

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('github.repository_fetch', 'GitHub  Repository fetch', '    workspace      .', 'github', 'MANUAL', '["github","workspace"]'::jsonb, '["github-read"]'::jsonb, 'GitHub REST API (PAT).', NULL, 180000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.repository_fetch' AND version = 1))
              ON CONFLICT (code) DO NOTHING;

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('github.workspace_directory_inspector', 'GitHub  Workspace inspector', '  workspace,  Gradle-   projectPath.', 'github', 'MANUAL', '["github","workspace"]'::jsonb, '["github-read"]'::jsonb, ' workspace,  GitHub fetch.', NULL, 120000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.workspace_directory_inspector' AND version = 1))
              ON CONFLICT (code) DO NOTHING;

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('docker.build_runner', 'Docker  Gradle runner', ' Gradle   Docker-     .', 'docker', 'MANUAL', '["gradle","tests"]'::jsonb, '["ci-run"]'::jsonb, ' aiadvent/mcp-gradle-runner.', NULL, 900000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'docker.build_runner' AND version = 1))
              ON CONFLICT (code) DO NOTHING;

              WITH repo_def AS (
                INSERT INTO agent_definition (id, identifier, display_name, description, is_active, created_by, updated_by, created_at, updated_at)
                VALUES (
                  gen_random_uuid(),
                  'repo-fetcher',
                  'Repo Fetcher Agent',
                  'LLM-,    GitHub    github.repository_fetch.',
                  true,
                  'seed',
                  'seed',
                  now(),
                  now())
                ON CONFLICT (identifier) DO NOTHING
                RETURNING id
              ),
              repo_def_id AS (
                SELECT id FROM repo_def
                UNION
                SELECT id FROM agent_definition WHERE identifier = 'repo-fetcher'
              ),
              repo_version_insert AS (
                INSERT INTO agent_version (
                  id,
                  agent_definition_id,
                  version,
                  status,
                  provider_type,
                  provider_id,
                  model_id,
                  system_prompt,
                  agent_invocation_options,
                  sync_only,
                  max_tokens,
                  created_by,
                  updated_by,
                  created_at,
                  published_at)
                SELECT
                  gen_random_uuid(),
                  repo_def_id.id,
                  1,
                  'PUBLISHED',
                  'OPENAI',
                  'openai',
                  'gpt-4o-mini',
                  'You ingest launch parameters and conversation history to prepare a repository for Gradle testing. Verify owner/name/ref data, infer it from URLs when needed, and call the github.repository_fetch tool exactly once. Respond with compact JSON: {"status":"READY","workspaceId":..,"commitSha":..,"notes":..}. Surface actionable validation errors in {"status":"ERROR","message":..}.',
                  $${
                    "provider":{"type":"OPENAI","id":"openai","modelId":"gpt-4o-mini","mode":"SYNC"},
                    "prompt":{"templateId":null,"system":null,"variables":[],"generation":{"temperature":0.1,"topP":0.8,"maxOutputTokens":900}},
                    "memoryPolicy":{"channels":["shared","conversation"],"retentionDays":14,"maxEntries":180,"summarizationStrategy":"TAIL_WITH_SUMMARY","overflowAction":"TRIM_OLDEST"},
                    "retryPolicy":{"maxAttempts":3,"initialDelayMs":250,"multiplier":2.0,"retryableStatuses":[429,500,502,503,504],"timeoutMs":45000,"overallDeadlineMs":120000,"jitterMs":150},
                    "advisorSettings":{"telemetry":{"enabled":true},"audit":{"enabled":true,"redactPii":true},"routing":{"enabled":false}},
                    "tooling":{"bindings":[{"toolCode":"github.repository_fetch","schemaVersion":1,"executionMode":"AUTO"}]},
                    "costProfile":{"inputPer1KTokens":0.008,"outputPer1KTokens":0.028,"currency":"USD"}
                  }$$::jsonb,
                  true,
                  900,
                  'seed',
                  'seed',
                  now(),
                  now()
                FROM repo_def_id
                WHERE NOT EXISTS (
                  SELECT 1 FROM agent_version av WHERE av.agent_definition_id = repo_def_id.id AND av.version = 1)
                RETURNING id, agent_definition_id
              ),
              repo_version_id AS (
                SELECT id, agent_definition_id FROM repo_version_insert
                UNION
                SELECT id, agent_definition_id
                FROM agent_version
                WHERE agent_definition_id = (SELECT id FROM repo_def_id LIMIT 1)
                  AND version = 1
              ),
              navigator_def AS (
                INSERT INTO agent_definition (id, identifier, display_name, description, is_active, created_by, updated_by, created_at, updated_at)
                VALUES (
                  gen_random_uuid(),
                  'workspace-navigator',
                  'Workspace Navigator Agent',
                  'LLM-,  workspace    projectPath  Gradle .',
                  true,
                  'seed',
                  'seed',
                  now(),
                  now())
                ON CONFLICT (identifier) DO NOTHING
                RETURNING id
              ),
              navigator_def_id AS (
                SELECT id FROM navigator_def
                UNION
                SELECT id FROM agent_definition WHERE identifier = 'workspace-navigator'
              ),
              navigator_version_insert AS (
                INSERT INTO agent_version (
                  id,
                  agent_definition_id,
                  version,
                  status,
                  provider_type,
                  provider_id,
                  model_id,
                  system_prompt,
                  agent_invocation_options,
                  sync_only,
                  max_tokens,
                  created_by,
                  updated_by,
                  created_at,
                  published_at)
                SELECT
                  gen_random_uuid(),
                  navigator_def_id.id,
                  1,
                  'PUBLISHED',
                  'OPENAI',
                  'openai',
                  'gpt-4o-mini',
                  'You help select the Gradle project path. Use workspace metadata (workspaceId, key files) and call github.workspace_directory_inspector when additional structure is required. Output {"status":"READY","projectPath":..,"recommendations":[...]} or {"status":"CLARIFY","message":..}.',
                  $${
                    "provider":{"type":"OPENAI","id":"openai","modelId":"gpt-4o-mini","mode":"SYNC"},
                    "prompt":{"templateId":null,"system":null,"variables":[],"generation":{"temperature":0.15,"topP":0.85,"maxOutputTokens":850}},
                    "memoryPolicy":{"channels":["shared","conversation"],"retentionDays":14,"maxEntries":180,"summarizationStrategy":"TAIL_WITH_SUMMARY","overflowAction":"TRIM_OLDEST"},
                    "retryPolicy":{"maxAttempts":3,"initialDelayMs":250,"multiplier":2.0,"retryableStatuses":[429,500,502,503,504],"timeoutMs":45000,"overallDeadlineMs":120000,"jitterMs":150},
                    "advisorSettings":{"telemetry":{"enabled":true},"audit":{"enabled":true,"redactPii":true},"routing":{"enabled":false}},
                    "tooling":{"bindings":[{"toolCode":"github.workspace_directory_inspector","schemaVersion":1,"executionMode":"AUTO"}]},
                    "costProfile":{"inputPer1KTokens":0.008,"outputPer1KTokens":0.028,"currency":"USD"}
                  }$$::jsonb,
                  true,
                  850,
                  'seed',
                  'seed',
                  now(),
                  now()
                FROM navigator_def_id
                WHERE NOT EXISTS (
                  SELECT 1 FROM agent_version av WHERE av.agent_definition_id = navigator_def_id.id AND av.version = 1)
                RETURNING id, agent_definition_id
              ),
              navigator_version_id AS (
                SELECT id, agent_definition_id FROM navigator_version_insert
                UNION
                SELECT id, agent_definition_id
                FROM agent_version
                WHERE agent_definition_id = (SELECT id FROM navigator_def_id LIMIT 1)
                  AND version = 1
              ),
              gradle_def AS (
                INSERT INTO agent_definition (id, identifier, display_name, description, is_active, created_by, updated_by, created_at, updated_at)
                VALUES (
                  gen_random_uuid(),
                  'gradle-test-runner',
                  'Gradle Test Runner Agent',
                  'LLM-,    docker.build_runner   .',
                  true,
                  'seed',
                  'seed',
                  now(),
                  now())
                ON CONFLICT (identifier) DO NOTHING
                RETURNING id
              ),
              gradle_def_id AS (
                SELECT id FROM gradle_def
                UNION
                SELECT id FROM agent_definition WHERE identifier = 'gradle-test-runner'
              ),
              gradle_version_insert AS (
                INSERT INTO agent_version (
                  id,
                  agent_definition_id,
                  version,
                  status,
                  provider_type,
                  provider_id,
                  model_id,
                  system_prompt,
                  agent_invocation_options,
                  sync_only,
                  max_tokens,
                  created_by,
                  updated_by,
                  created_at,
                  published_at)
                SELECT
                  gen_random_uuid(),
                  gradle_def_id.id,
                  1,
                  'PUBLISHED',
                  'OPENAI',
                  'openai',
                  'gpt-4o-mini',
                  'You execute Gradle tasks inside Docker. Consume workspaceId, projectPath, tasks, and env hints. Call docker.build_runner exactly once, retry only on transient errors, and summarise the outcome as {"status":"PASSED"|"FAILED","exitCode":..,"summary":..}. Include failing tasks and tail of logs when useful.',
                  $${
                    "provider":{"type":"OPENAI","id":"openai","modelId":"gpt-4o-mini","mode":"SYNC"},
                    "prompt":{"templateId":null,"system":null,"variables":[],"generation":{"temperature":0.05,"topP":0.8,"maxOutputTokens":900}},
                    "memoryPolicy":{"channels":["shared","conversation"],"retentionDays":7,"maxEntries":120,"summarizationStrategy":"TAIL_WITH_SUMMARY","overflowAction":"TRIM_OLDEST"},
                    "retryPolicy":{"maxAttempts":2,"initialDelayMs":500,"multiplier":2.0,"retryableStatuses":[429,500,502,503,504],"timeoutMs":90000,"overallDeadlineMs":240000,"jitterMs":200},
                    "advisorSettings":{"telemetry":{"enabled":true},"audit":{"enabled":true,"redactPii":true},"routing":{"enabled":false}},
                    "tooling":{"bindings":[{"toolCode":"docker.build_runner","schemaVersion":1,"executionMode":"AUTO"}]},
                    "costProfile":{"inputPer1KTokens":0.008,"outputPer1KTokens":0.028,"currency":"USD"}
                  }$$::jsonb,
                  true,
                  900,
                  'seed',
                  'seed',
                  now(),
                  now()
                FROM gradle_def_id
                WHERE NOT EXISTS (
                  SELECT 1 FROM agent_version av WHERE av.agent_definition_id = gradle_def_id.id AND av.version = 1)
                RETURNING id, agent_definition_id
              ),
              gradle_version_id AS (
                SELECT id, agent_definition_id FROM gradle_version_insert
                UNION
                SELECT id, agent_definition_id
                FROM agent_version
                WHERE agent_definition_id = (SELECT id FROM gradle_def_id LIMIT 1)
                  AND version = 1
              )
              INSERT INTO flow_definition (
                id,
                name,
                version,
                status,
                definition,
                is_active,
                description,
                updated_by,
                created_at,
                updated_at,
                published_at,
                blueprint_schema_version)
              SELECT
                gen_random_uuid(),
                'github-gradle-test-flow',
                1,
                'PUBLISHED',
                jsonb_build_object(
                  'schemaVersion', 1,
                  'metadata', jsonb_build_object(
                    'title', 'GitHub Gradle Test Flow',
                    'description', ' ,  projectPath   Gradle-  Docker.'),
                  'syncOnly', true,
                  'startStepId', 'fetch_workspace',
                  'launchParameters', jsonb_build_array(
                    jsonb_build_object('name','repositoryUrl','label','GitHub URL','type','string','required', true),
                    jsonb_build_object('name','ref','label','Branch / Tag / SHA','type','string','required', false),
                    jsonb_build_object('name','tasks','label','Gradle tasks','type','array','itemType','string','required', false),
                    jsonb_build_object('name','projectPath','label','Project path','type','string','required', false),
                    jsonb_build_object('name','gradleArgs','label','Extra Gradle arguments','type','array','itemType','string','required', false)
                  ),
                  'memory', jsonb_build_object('shared', jsonb_build_object('enabled', true)),
                  'steps', jsonb_build_array(
                    jsonb_build_object(
                      'id','fetch_workspace',
                      'name','Fetch workspace',
                      'agentVersionId', (SELECT id::text FROM repo_version_id LIMIT 1),
                      'prompt',
                        $$Use launch parameters (repositoryUrl, ref, tasks, projectPath, gradleArgs) and conversation context to validate GitHub coordinates. Parse owner/name/ref from URLs when necessary, prefer explicit ref parameter, and call github.repository_fetch exactly once. Record key metadata in the response JSON and summary lines for operators.$$,
                      'overrides', jsonb_build_object('temperature', 0.05, 'maxTokens', 750),
                      'memoryReads', jsonb_build_array(
                        jsonb_build_object('channel','shared','limit',15),
                        jsonb_build_object('channel','conversation','limit',10)),
                      'memoryWrites', jsonb_build_array(
                        jsonb_build_object('channel','shared','mode','AGENT_OUTPUT'),
                        jsonb_build_object('channel','conversation','mode','AGENT_OUTPUT')),
                      'transitions', jsonb_build_object(
                        'onSuccess', jsonb_build_object('next','inspect_workspace')),
                      'maxAttempts', 2),
                    jsonb_build_object(
                      'id','inspect_workspace',
                      'name','Inspect workspace',
                      'agentVersionId', (SELECT id::text FROM navigator_version_id LIMIT 1),
                      'prompt',
                        $$Analyse repo metadata and Gradle task intent. If projectPath is not supplied or ambiguous, call github.workspace_directory_inspector to list modules, then recommend the best projectPath and additional notes. Respect user-provided projectPath when valid.$$,
                      'overrides', jsonb_build_object('temperature', 0.15, 'maxTokens', 700),
                      'memoryReads', jsonb_build_array(
                        jsonb_build_object('channel','shared','limit',15),
                        jsonb_build_object('channel','conversation','limit',15)),
                      'memoryWrites', jsonb_build_array(
                        jsonb_build_object('channel','shared','mode','AGENT_OUTPUT'),
                        jsonb_build_object('channel','conversation','mode','AGENT_OUTPUT')),
                      'transitions', jsonb_build_object(
                        'onSuccess', jsonb_build_object('next','run_gradle_tests')),
                      'maxAttempts', 2),
                    jsonb_build_object(
                      'id','run_gradle_tests',
                      'name','Run Gradle tests',
                      'agentVersionId', (SELECT id::text FROM gradle_version_id LIMIT 1),
                      'prompt',
                        $$Launch docker.build_runner with the confirmed workspaceId, projectPath, and Gradle tasks. Default to the first recommended task list when none provided. Summarize exit code, failing tasks, and link to any artefacts. Provide actionable advice when execution fails.$$,
                      'overrides', jsonb_build_object('temperature', 0.05, 'maxTokens', 900),
                      'memoryReads', jsonb_build_array(
                        jsonb_build_object('channel','shared','limit',15),
                        jsonb_build_object('channel','conversation','limit',20)),
                      'memoryWrites', jsonb_build_array(
                        jsonb_build_object('channel','shared','mode','AGENT_OUTPUT'),
                        jsonb_build_object('channel','conversation','mode','AGENT_OUTPUT')),
                      'transitions', jsonb_build_object(
                        'onSuccess', jsonb_build_object('complete', true)),
                      'maxAttempts', 2)
                  )
                ),
                true,
                'GitHub Gradle orchestration flow',
                'seed',
                now(),
                now(),
                now(),
                1
              WHERE NOT EXISTS (
                SELECT 1 FROM flow_definition WHERE name = 'github-gradle-test-flow');
  - changeSet:
      id: 0102-add-workspace-read-file-tool
      author: codex
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('workspace.read_file', 1,
                 $${
                   "type": "object",
                   "properties": {
                     "workspaceId": {"type":"string"},
                     "path": {"type":"string"},
                     "maxBytes": {"type":"integer","minimum":1,"maximum":2097152}
                   },
                   "required": ["workspaceId","path"]
                 }$$::jsonb,
                 $${
                   "type": "object",
                   "properties": {
                     "workspaceId": {"type":"string"},
                     "path": {"type":"string"},
                     "sizeBytes": {"type":"integer","minimum":0},
                     "truncated": {"type":"boolean"},
                     "binary": {"type":"boolean"},
                     "encoding": {"type":"string"},
                     "content": {"type":"string"},
                     "base64Content": {"type":"string"},
                     "readAt": {"type":"string","format":"date-time"}
                   },
                   "required": ["workspaceId","path","sizeBytes","truncated","binary","readAt"]
                 }$$::jsonb,
                 'checksum-workspace.read_file-v1', '[]'::jsonb, 'github', 'workspace.read_file', 'http-stream', 'github')
              ON CONFLICT (tool_code, version) DO NOTHING;

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('workspace.read_file', 'Workspace  Read file', '     workspace,  GitHub MCP.', 'github', 'MANUAL', '["github","workspace"]'::jsonb, '["github-read"]'::jsonb, ' workspace,   github.repository_fetch.', NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'workspace.read_file' AND version = 1))
              ON CONFLICT (code) DO NOTHING;
  - changeSet:
      id: 0103-integrate-repo-analysis-mcp
      author: codex
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('repo_analysis.scan_next_segment', 1,
                 $${
                   "type": "object",
                   "properties": {
                     "analysisId": {"type":"string"},
                     "workspaceId": {"type":"string"},
                     "projectPath": {"type":"string"},
                     "reset": {"type":"boolean"},
                     "maxBytes": {"type":"integer","minimum":1,"maximum":262144},
                     "configOverrides": {
                       "type": "object",
                       "properties": {
                         "maxDepth": {"type":"integer","minimum":1,"maximum":32},
                         "maxFileBytes": {"type":"integer","minimum":1024,"maximum":10485760},
                         "segmentMaxBytes": {"type":"integer","minimum":2048,"maximum":262144},
                         "includeHidden": {"type":"boolean"},
                         "includeExtensions": {"type":"array","items":{"type":"string"}},
                         "excludeExtensions": {"type":"array","items":{"type":"string"}},
                         "excludeDirectories": {"type":"array","items":{"type":"string"}}
                       }
                     }
                   },
                   "required": ["analysisId","workspaceId"]
                 }$$::jsonb,
                 $${
                   "type": "object",
                   "properties": {
                     "analysisId": {"type":"string"},
                     "workspaceId": {"type":"string"},
                     "projectPath": {"type":"string"},
                     "completed": {"type":"boolean"},
                     "segment": {
                       "type": ["object","null"],
                       "properties": {
                         "key": {"type":"string"},
                         "path": {"type":"string"},
                         "segmentIndex": {"type":"integer","minimum":1},
                         "totalSegments": {"type":"integer","minimum":1},
                         "startLine": {"type":"integer","minimum":1},
                         "endLine": {"type":"integer","minimum":1},
                         "bytes": {"type":"integer","minimum":0},
                         "truncated": {"type":"boolean"},
                         "content": {"type":"string"},
                         "summary": {"type":"string"},
                         "readAt": {"type":"string","format":"date-time"}
                       },
                       "required": ["key","path","segmentIndex","totalSegments","startLine","endLine","bytes","truncated","content","summary","readAt"]
                     },
                     "remainingSegments": {"type":"integer","minimum":0},
                     "processedSegments": {"type":"integer","minimum":0},
                     "warnings": {"type":"array","items":{"type":"string"}},
                     "skippedFiles": {"type":"array","items":{"type":"string"}},
                     "generatedAt": {"type":"string","format":"date-time"}
                   },
                   "required": ["analysisId","workspaceId","completed","remainingSegments","processedSegments","warnings","skippedFiles","generatedAt"]
                 }$$::jsonb,
                 'checksum-repo_analysis.scan_next_segment-v1', '[]'::jsonb, 'repo-analysis', 'repo_analysis.scan_next_segment', 'http-stream', 'repo-analysis')
              ON CONFLICT (tool_code, version) DO NOTHING;

              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('repo_analysis.aggregate_findings', 1,
                 $${
                   "type": "object",
                   "properties": {
                     "analysisId": {"type":"string"},
                     "workspaceId": {"type":"string"},
                     "findings": {
                       "type":"array",
                       "items": {
                         "type":"object",
                         "properties": {
                           "path": {"type":"string"},
                           "line": {"type":"integer","minimum":1},
                           "endLine": {"type":"integer","minimum":1},
                           "title": {"type":"string"},
                           "summary": {"type":"string"},
                           "severity": {"type":"string"},
                           "tags": {"type":"array","items":{"type":"string"}},
                           "score": {"type":"number"}
                         },
                         "required": ["path"]
                       }
                     }
                   },
                   "required": ["analysisId","workspaceId"]
                 }$$::jsonb,
                 $${
                   "type": "object",
                   "properties": {
                     "analysisId": {"type":"string"},
                     "workspaceId": {"type":"string"},
                     "totalFindings": {"type":"integer","minimum":0},
                     "newFindings": {"type":"integer","minimum":0},
                     "files": {
                       "type":"array",
                       "items": {
                         "type":"object",
                         "properties": {
                           "path": {"type":"string"},
                           "findingCount": {"type":"integer","minimum":0},
                           "worstSeverity": {"type":"string"},
                           "score": {"type":"number"},
                           "tags": {"type":"array","items":{"type":"string"}},
                           "highlights": {"type":"array","items":{"type":"string"}}
                         },
                         "required": ["path","findingCount","worstSeverity","score","tags","highlights"]
                       }
                     },
                     "aggregatedAt": {"type":"string","format":"date-time"}
                   },
                   "required": ["analysisId","workspaceId","totalFindings","newFindings","files","aggregatedAt"]
                 }$$::jsonb,
                 'checksum-repo_analysis.aggregate_findings-v1', '[]'::jsonb, 'repo-analysis', 'repo_analysis.aggregate_findings', 'http-stream', 'repo-analysis')
              ON CONFLICT (tool_code, version) DO NOTHING;

              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('repo_analysis.list_hotspots', 1,
                 $${
                   "type": "object",
                   "properties": {
                     "analysisId": {"type":"string"},
                     "workspaceId": {"type":"string"},
                     "limit": {"type":"integer","minimum":1,"maximum":200},
                     "includeDetails": {"type":"boolean"}
                   },
                   "required": ["analysisId","workspaceId"]
                 }$$::jsonb,
                 $${
                   "type": "object",
                   "properties": {
                     "analysisId": {"type":"string"},
                     "workspaceId": {"type":"string"},
                     "hotspots": {
                       "type":"array",
                       "items": {
                         "type":"object",
                         "properties": {
                           "path": {"type":"string"},
                           "severity": {"type":"string"},
                           "findingCount": {"type":"integer","minimum":0},
                           "score": {"type":"number"},
                           "highlights": {"type":"array","items":{"type":"string"}},
                           "tags": {"type":"array","items":{"type":"string"}}
                         },
                         "required": ["path","severity","findingCount","score","highlights","tags"]
                       }
                     },
                     "generatedAt": {"type":"string","format":"date-time"}
                   },
                   "required": ["analysisId","workspaceId","hotspots","generatedAt"]
                 }$$::jsonb,
                 'checksum-repo_analysis.list_hotspots-v1', '[]'::jsonb, 'repo-analysis', 'repo_analysis.list_hotspots', 'http-stream', 'repo-analysis')
              ON CONFLICT (tool_code, version) DO NOTHING;

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('repo_analysis.scan_next_segment', 'Repo Analysis  Scan segment', '      workspace     .', 'repo-analysis', 'MANUAL', '["analysis","workspace"]'::jsonb, '["workspace-read"]'::jsonb, ' workspace,  GitHub MCP.', NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'repo_analysis.scan_next_segment' AND version = 1))
              ON CONFLICT (code) DO NOTHING;

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('repo_analysis.aggregate_findings', 'Repo Analysis  Aggregate findings', '          .', 'repo-analysis', 'MANUAL', '["analysis","workspace"]'::jsonb, '["workspace-read"]'::jsonb, ' workspace,  GitHub MCP.', NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'repo_analysis.aggregate_findings' AND version = 1))
              ON CONFLICT (code) DO NOTHING;

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('repo_analysis.list_hotspots', 'Repo Analysis  List hotspots', '        .', 'repo-analysis', 'MANUAL', '["analysis","workspace"]'::jsonb, '["workspace-read"]'::jsonb, ' workspace,  GitHub MCP.', NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'repo_analysis.list_hotspots' AND version = 1))
              ON CONFLICT (code) DO NOTHING;

              WITH analysis_def AS (
                INSERT INTO agent_definition (id, identifier, display_name, description, is_active, created_by, updated_by, created_at, updated_at)
                VALUES (
                  gen_random_uuid(),
                  'github-analysis-runner',
                  'GitHub Analysis Runner Agent',
                  'LLM-,   repo_analysis MCP:   ,     hotspots.',
                  true,
                  'seed',
                  'seed',
                  now(),
                  now())
                ON CONFLICT (identifier) DO NOTHING
                RETURNING id
              ),
              analysis_def_id AS (
                SELECT id FROM analysis_def
                UNION
                SELECT id FROM agent_definition WHERE identifier = 'github-analysis-runner'
              )
              INSERT INTO agent_version (
                id,
                agent_definition_id,
                version,
                status,
                provider_type,
                provider_id,
                model_id,
                system_prompt,
                agent_invocation_options,
                sync_only,
                max_tokens,
                created_by,
                updated_by,
                created_at,
                published_at)
              SELECT
                gen_random_uuid(),
                analysis_def_id.id,
                1,
                'PUBLISHED',
                'OPENAI',
                'openai',
                'gpt-4o-mini',
                'You orchestrate offline repository analysis over a prepared workspace. Validate analysisId/workspaceId/projectPath, resume existing runs via reset when asked, and iterate repo_analysis.scan_next_segment until completed. Summarize critical code fragments, request follow-up scans when useful, and consolidate observations through repo_analysis.aggregate_findings. Use repo_analysis.list_hotspots with includeDetails=true to surface the top risk files. workspace.read_file is available for targeted excerpts. Always return compact JSON like {"status":"COMPLETED","analysisId":..,"summary":..,"hotspots":[...],"warnings":[...]} or {"status":"ERROR","message":..}.',
                $${
                  "provider":{"type":"OPENAI","id":"openai","modelId":"gpt-4o-mini","mode":"SYNC"},
                  "prompt":{"templateId":null,"system":null,"variables":[],"generation":{"temperature":0.15,"topP":0.85,"maxOutputTokens":900}},
                  "memoryPolicy":{"channels":["shared","conversation"],"retentionDays":14,"maxEntries":160,"summarizationStrategy":"TAIL_WITH_SUMMARY","overflowAction":"TRIM_OLDEST"},
                  "retryPolicy":{"maxAttempts":3,"initialDelayMs":250,"multiplier":2.0,"retryableStatuses":[429,500,502,503,504],"timeoutMs":45000,"overallDeadlineMs":120000,"jitterMs":150},
                  "advisorSettings":{"telemetry":{"enabled":true},"audit":{"enabled":true,"redactPii":true},"routing":{"enabled":false}},
                  "tooling":{"bindings":[
                    {"toolCode":"repo_analysis.scan_next_segment","schemaVersion":1,"executionMode":"AUTO"},
                    {"toolCode":"repo_analysis.aggregate_findings","schemaVersion":1,"executionMode":"AUTO"},
                    {"toolCode":"repo_analysis.list_hotspots","schemaVersion":1,"executionMode":"AUTO"},
                    {"toolCode":"workspace.read_file","schemaVersion":1,"executionMode":"AUTO"}
                  ]},
                  "costProfile":{"inputPer1KTokens":0.008,"outputPer1KTokens":0.028,"currency":"USD"}
                }$$::jsonb,
                true,
                900,
                'seed',
                'seed',
                now(),
                now()
              FROM analysis_def_id
              WHERE NOT EXISTS (
                SELECT 1 FROM agent_version av WHERE av.agent_definition_id = analysis_def_id.id AND av.version = 1);

  - changeSet:
      id: 0205-insert-notes-mcp-tools
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('notes.save_note', 1,
                 '{"type":"object","properties":{"title":{"type":"string","minLength":1,"maxLength":160},"content":{"type":"string","minLength":1,"maxLength":4000},"tags":{"type":"array","items":{"type":"string"},"maxItems":25},"metadata":{"type":"object"},"userNamespace":{"type":"string","minLength":1},"userReference":{"type":"string","minLength":1},"sourceChannel":{"type":"string"}},"required":["title","content","userNamespace","userReference"]}'::jsonb,
                 '{"type":"object","properties":{"noteId":{"type":"string","format":"uuid"},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"},"created":{"type":"boolean"},"embeddingProvider":{"type":"string"},"embeddingDimensions":{"type":"integer"}},"required":["noteId","createdAt","updatedAt","created","embeddingProvider","embeddingDimensions"]}'::jsonb,
                 'checksum-notes.save_note-v1', '[]'::jsonb, 'notes', 'notes.save_note', 'http-stream', 'notes'),
                ('notes.search_similar', 1,
                 '{"type":"object","properties":{"query":{"type":"string","minLength":1},"userNamespace":{"type":"string","minLength":1},"userReference":{"type":"string","minLength":1},"topK":{"type":"integer","minimum":1,"maximum":50},"minScore":{"type":"number","minimum":0.0,"maximum":0.99}},"required":["query","userNamespace","userReference"]}'::jsonb,
                 '{"type":"object","properties":{"matches":{"type":"array","items":{"type":"object","properties":{"noteId":{"type":"string","format":"uuid"},"title":{"type":"string"},"content":{"type":"string"},"tags":{"type":"array","items":{"type":"string"}},"metadata":{"type":"object"},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"},"score":{"type":"number"},"vectorMetadata":{"type":"object"}},"required":["noteId","title","content","score"]}}},"required":["matches"]}'::jsonb,
                 'checksum-notes.search_similar-v1', '[]'::jsonb, 'notes', 'notes.search_similar', 'http-stream', 'notes')
              ON CONFLICT (tool_code, version) DO NOTHING;

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('notes.save_note', 'Notes  Save note', 'Persist user note and index it in PgVector.', 'notes', 'MANUAL', '["notes","storage"]'::jsonb, '["persistence"]'::jsonb, 'Local MCP service', NULL, 45000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'notes.save_note' AND version = 1)),
                ('notes.search_similar', 'Notes  Search similar', 'Vector search over notes for the requesting user.', 'notes', 'MANUAL', '["notes","search"]'::jsonb, '["retrieval"]'::jsonb, 'Local MCP service', NULL, 45000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'notes.search_similar' AND version = 1))
              ON CONFLICT (code) DO NOTHING;

  - changeSet:
      id: 0206-insert-coding-mcp-tools
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('coding.generate_patch', 1,
                 '{"type":"object","properties":{"workspaceId":{"type":"string","minLength":1},"instructions":{"type":"string","minLength":1,"maxLength":4000},"targetPaths":{"type":"array","items":{"type":"string"},"maxItems":25},"forbiddenPaths":{"type":"array","items":{"type":"string"},"maxItems":25},"contextFiles":{"type":"array","items":{"type":"object","properties":{"path":{"type":"string","minLength":1},"maxBytes":{"type":"integer","minimum":1}},"required":["path"]},"maxItems":25}},"required":["workspaceId","instructions"]}'::jsonb,
                 '{"type":"object","properties":{"patchId":{"type":"string"},"workspaceId":{"type":"string"},"summary":{"type":"string"},"diff":{"type":"string"},"annotations":{"type":"object","properties":{"files":{"type":"array","items":{"type":"string"}},"risks":{"type":"array","items":{"type":"string"}},"conflicts":{"type":"array","items":{"type":"string"}}},"required":["files","risks","conflicts"]},"usage":{"type":"object","properties":{"promptTokens":{"type":"integer","minimum":0},"completionTokens":{"type":"integer","minimum":0}},"required":["promptTokens","completionTokens"]},"createdAt":{"type":"string","format":"date-time"}},"required":["patchId","workspaceId","summary","diff","annotations","usage","createdAt"]}'::jsonb,
                 'checksum-coding.generate_patch-v1', '[]'::jsonb, 'coding-mcp', 'coding.generate_patch', 'http-stream', 'coding'),
                ('coding.review_patch', 1,
                 '{"type":"object","properties":{"workspaceId":{"type":"string","minLength":1},"patchId":{"type":"string","minLength":1},"focus":{"type":"array","items":{"type":"string","enum":["risks","tests","migration"]},"maxItems":3}},"required":["workspaceId","patchId"]}'::jsonb,
                 '{"type":"object","properties":{"patchId":{"type":"string"},"status":{"type":"string","enum":["ok","warnings","blocked"]},"findings":{"type":"array","items":{"type":"string"}},"testingRecommendations":{"type":"array","items":{"type":"string"}},"nextSteps":{"type":"array","items":{"type":"string"}},"annotations":{"type":"object","properties":{"files":{"type":"array","items":{"type":"string"}},"risks":{"type":"array","items":{"type":"string"}},"conflicts":{"type":"array","items":{"type":"string"}}},"required":["files","risks","conflicts"]},"usage":{"type":"object","properties":{"promptTokens":{"type":"integer","minimum":0},"completionTokens":{"type":"integer","minimum":0}},"required":["promptTokens","completionTokens"]}},"required":["patchId","status","findings","testingRecommendations","nextSteps","annotations","usage"]}'::jsonb,
                 'checksum-coding.review_patch-v1', '[]'::jsonb, 'coding-mcp', 'coding.review_patch', 'http-stream', 'coding'),
                ('coding.apply_patch_preview', 1,
                 '{"type":"object","properties":{"workspaceId":{"type":"string","minLength":1},"patchId":{"type":"string","minLength":1},"commands":{"type":"array","items":{"type":"string"},"maxItems":10},"dryRun":{"type":"boolean"},"timeout":{"type":"string","minLength":1}},"required":["workspaceId","patchId"]}'::jsonb,
                 '{"type":"object","properties":{"patchId":{"type":"string"},"workspaceId":{"type":"string"},"applied":{"type":"boolean"},"preview":{"type":"object","properties":{"summary":{"type":"string"},"warnings":{"type":"array","items":{"type":"string"}},"dryRunStatus":{"type":"string"},"modifiedFiles":{"type":"array","items":{"type":"string"}},"recommendations":{"type":"array","items":{"type":"string"}}},"required":["summary","warnings","dryRunStatus","modifiedFiles","recommendations"]},"gradle":{"type":"object","properties":{"executed":{"type":"boolean"},"runner":{"type":"string"},"exitCode":{"type":"integer"},"status":{"type":"string"},"logs":{"type":"array","items":{"type":"string"}}},"required":["executed","exitCode","status","logs"]},"annotations":{"type":"object","properties":{"files":{"type":"array","items":{"type":"string"}},"risks":{"type":"array","items":{"type":"string"}},"conflicts":{"type":"array","items":{"type":"string"}}},"required":["files","risks","conflicts"]},"usage":{"type":"object","properties":{"promptTokens":{"type":"integer","minimum":0},"completionTokens":{"type":"integer","minimum":0}},"required":["promptTokens","completionTokens"]},"metrics":{"type":"object"},"completedAt":{"type":"string","format":"date-time"}},"required":["patchId","workspaceId","applied","preview","gradle","annotations","usage","metrics","completedAt"]}'::jsonb,
                 'checksum-coding.apply_patch_preview-v1', '[]'::jsonb, 'coding-mcp', 'coding.apply_patch_preview', 'http-stream', 'coding'),
                ('coding.list_patches', 1,
                 '{"type":"object","properties":{"workspaceId":{"type":"string","minLength":1}},"required":["workspaceId"]}'::jsonb,
                 '{"type":"object","properties":{"patches":{"type":"array","items":{"type":"object","properties":{"patchId":{"type":"string"},"workspaceId":{"type":"string"},"status":{"type":"string"},"summary":{"type":"string"},"requiresManualReview":{"type":"boolean"},"hasDryRun":{"type":"boolean"},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"},"expiresAt":{"type":"string","format":"date-time"},"annotations":{"type":"object","properties":{"files":{"type":"array","items":{"type":"string"}},"risks":{"type":"array","items":{"type":"string"}},"conflicts":{"type":"array","items":{"type":"string"}}},"required":["files","risks","conflicts"]},"usage":{"type":"object","properties":{"promptTokens":{"type":"integer","minimum":0},"completionTokens":{"type":"integer","minimum":0}},"required":["promptTokens","completionTokens"]}},"required":["patchId","workspaceId","status","summary","requiresManualReview","hasDryRun","createdAt","updatedAt","expiresAt","annotations","usage"]}}},"required":["patches"]}'::jsonb,
                 'checksum-coding.list_patches-v1', '[]'::jsonb, 'coding-mcp', 'coding.list_patches', 'http-stream', 'coding'),
                ('coding.discard_patch', 1,
                 '{"type":"object","properties":{"workspaceId":{"type":"string","minLength":1},"patchId":{"type":"string","minLength":1}},"required":["workspaceId","patchId"]}'::jsonb,
                 '{"type":"object","properties":{"patchId":{"type":"string"},"patch":{"type":"object","properties":{"patchId":{"type":"string"},"workspaceId":{"type":"string"},"status":{"type":"string"},"summary":{"type":"string"},"requiresManualReview":{"type":"boolean"},"hasDryRun":{"type":"boolean"},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"},"expiresAt":{"type":"string","format":"date-time"},"annotations":{"type":"object","properties":{"files":{"type":"array","items":{"type":"string"}},"risks":{"type":"array","items":{"type":"string"}},"conflicts":{"type":"array","items":{"type":"string"}}},"required":["files","risks","conflicts"]},"usage":{"type":"object","properties":{"promptTokens":{"type":"integer","minimum":0},"completionTokens":{"type":"integer","minimum":0}},"required":["promptTokens","completionTokens"]}},"required":["patchId","workspaceId","status","summary","requiresManualReview","hasDryRun","createdAt","updatedAt","expiresAt","annotations","usage"]},"discardedAt":{"type":"string","format":"date-time"}},"required":["patchId","patch","discardedAt"]}'::jsonb,
                 'checksum-coding.discard_patch-v1', '[]'::jsonb, 'coding-mcp', 'coding.discard_patch', 'http-stream', 'coding')
              ON CONFLICT (tool_code, version) DO NOTHING;

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('coding.generate_patch', 'Coding  Generate patch', 'Generate patch diff suggestions within a prepared workspace.', 'coding', 'AUTO', '["coding","patch"]'::jsonb, '["generation"]'::jsonb, 'Local MCP service', NULL, 60000,
                (SELECT id FROM tool_schema_version WHERE tool_code = 'coding.generate_patch' AND version = 1)),
                ('coding.review_patch', 'Coding  Review patch', 'Analyse generated patch and highlight risks, testing advice and next steps.', 'coding', 'AUTO', '["coding","review"]'::jsonb, '["analysis"]'::jsonb, 'Local MCP service', NULL, 60000,
                (SELECT id FROM tool_schema_version WHERE tool_code = 'coding.review_patch' AND version = 1)),
                ('coding.apply_patch_preview', 'Coding  Apply patch preview', 'Apply patch preview inside sandboxed workspace and optionally run dry-run commands.', 'coding', 'MANUAL', '["coding","execution"]'::jsonb, '["dry-run"]'::jsonb, 'Local MCP service', NULL, 120000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'coding.apply_patch_preview' AND version = 1)),
                ('coding.list_patches', 'Coding  List patches', 'List active patches for a workspace with metadata.', 'coding', 'AUTO', '["coding","registry"]'::jsonb, '["introspection"]'::jsonb, 'Local MCP service', NULL, 45000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'coding.list_patches' AND version = 1)),
                ('coding.discard_patch', 'Coding  Discard patch', 'Remove a patch from registry after manual confirmation.', 'coding', 'MANUAL', '["coding","registry"]'::jsonb, '["cleanup"]'::jsonb, 'Local MCP service', NULL, 45000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'coding.discard_patch' AND version = 1))
              ON CONFLICT (code) DO NOTHING;


  - changeSet:
      id: 0207-seed-github-write-tools
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('github.create_branch', 1,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}},"required":["owner","name"]},"workspaceId":{"type":"string","minLength":1},"branchName":{"type":"string","minLength":1},"sourceSha":{"type":"string","pattern":"^[0-9a-fA-F]{40}$"}},"required":["repository","workspaceId","branchName"]}
                 $$::jsonb,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}}},"workspaceId":{"type":"string"},"branchName":{"type":"string"},"branchRef":{"type":"string"},"sourceSha":{"type":"string"},"localHeadSha":{"type":"string"},"createdAt":{"type":"string","format":"date-time"}},"required":["repository","workspaceId","branchName","branchRef","sourceSha","localHeadSha","createdAt"]}
                 $$::jsonb,
                 'checksum-github.create_branch-v1', '[]'::jsonb, 'github', 'github.create_branch', 'http-stream', 'github'),
                ('github.commit_workspace_diff', 1,
                 $$
                 {"type":"object","properties":{"workspaceId":{"type":"string","minLength":1},"branchName":{"type":"string","minLength":1},"author":{"type":"object","properties":{"name":{"type":"string","minLength":1},"email":{"type":"string","format":"email"}},"required":["name","email"]},"commitMessage":{"type":"string","minLength":1}},"required":["workspaceId","branchName","author","commitMessage"]}
                 $$::jsonb,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}}},"workspaceId":{"type":"string"},"branchName":{"type":"string"},"commitSha":{"type":"string"},"filesChanged":{"type":"integer","minimum":0},"additions":{"type":"integer","minimum":0},"deletions":{"type":"integer","minimum":0},"files":{"type":"array","items":{"type":"object","properties":{"status":{"type":"string"},"path":{"type":"string"},"previousPath":{"type":"string"}},"required":["status","path"]}},"committedAt":{"type":"string","format":"date-time"}},"required":["repository","workspaceId","branchName","commitSha","filesChanged","additions","deletions","files","committedAt"]}
                 $$::jsonb,
                 'checksum-github.commit_workspace_diff-v1', '[]'::jsonb, 'github', 'github.commit_workspace_diff', 'http-stream', 'github'),
                ('github.push_branch', 1,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}},"required":["owner","name"]},"workspaceId":{"type":"string","minLength":1},"branchName":{"type":"string","minLength":1},"force":{"type":"boolean"}},"required":["repository","workspaceId","branchName"]}
                 $$::jsonb,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}}},"workspaceId":{"type":"string"},"branchName":{"type":"string"},"localHeadSha":{"type":"string"},"remoteHeadSha":{"type":"string"},"commitsPushed":{"type":"integer","minimum":0},"pushedAt":{"type":"string","format":"date-time"}},"required":["repository","workspaceId","branchName","localHeadSha","remoteHeadSha","commitsPushed","pushedAt"]}
                 $$::jsonb,
                 'checksum-github.push_branch-v1', '[]'::jsonb, 'github', 'github.push_branch', 'http-stream', 'github'),
                ('github.open_pull_request', 1,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}},"required":["owner","name"]},"headBranch":{"type":"string","minLength":1},"baseBranch":{"type":"string","minLength":1},"title":{"type":"string","minLength":1},"body":{"type":"string"},"reviewers":{"type":"array","items":{"type":"string"},"maxItems":16},"teamReviewers":{"type":"array","items":{"type":"string"},"maxItems":10},"draft":{"type":"boolean"}},"required":["repository","headBranch","baseBranch","title"]}
                 $$::jsonb,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}}},"pullRequestNumber":{"type":"integer"},"htmlUrl":{"type":"string","format":"uri"},"headSha":{"type":"string"},"baseSha":{"type":"string"},"createdAt":{"type":"string","format":"date-time"}},"required":["repository","pullRequestNumber","headSha","baseSha","createdAt"]}
                 $$::jsonb,
                 'checksum-github.open_pull_request-v1', '[]'::jsonb, 'github', 'github.open_pull_request', 'http-stream', 'github'),
                ('github.approve_pull_request', 1,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}},"required":["owner","name"]},"number":{"type":"integer","minimum":1},"body":{"type":"string"}},"required":["repository","number"]}
                 $$::jsonb,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}}},"pullRequestNumber":{"type":"integer"},"reviewId":{"type":"integer"},"state":{"type":"string"},"submittedAt":{"type":"string","format":"date-time"}},"required":["repository","pullRequestNumber","reviewId","state","submittedAt"]}
                 $$::jsonb,
                 'checksum-github.approve_pull_request-v1', '[]'::jsonb, 'github', 'github.approve_pull_request', 'http-stream', 'github'),
                ('github.merge_pull_request', 1,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}},"required":["owner","name"]},"number":{"type":"integer","minimum":1},"mergeMethod":{"type":"string","enum":["MERGE","SQUASH","REBASE"]},"commitTitle":{"type":"string"},"commitMessage":{"type":"string"}},"required":["repository","number"]}
                 $$::jsonb,
                 $$
                 {"type":"object","properties":{"repository":{"type":"object","properties":{"owner":{"type":"string"},"name":{"type":"string"},"ref":{"type":"string"}}},"pullRequestNumber":{"type":"integer"},"merged":{"type":"boolean"},"mergeSha":{"type":"string"},"message":{"type":"string"},"mergedAt":{"type":"string","format":"date-time"}},"required":["repository","pullRequestNumber","merged"]}
                 $$::jsonb,
                 'checksum-github.merge_pull_request-v1', '[]'::jsonb, 'github', 'github.merge_pull_request', 'http-stream', 'github');

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('github.create_branch', 'GitHub  Create branch', '     ,   workspace.', 'github', 'MANUAL', '["github","branch","write"]'::jsonb, '["github-write"]'::jsonb, 'GitHub REST API (Personal Access Token).', NULL, 45000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.create_branch' AND version = 1)),
                ('github.commit_workspace_diff', 'GitHub  Commit workspace diff', ' commit    workspace   diff.', 'github', 'MANUAL', '["github","commit","write"]'::jsonb, '["github-write"]'::jsonb, 'GitHub REST API (Personal Access Token).', NULL, 120000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.commit_workspace_diff' AND version = 1)),
                ('github.push_branch', 'GitHub  Push branch', '   workspace   .', 'github', 'MANUAL', '["github","branch","write"]'::jsonb, '["github-write"]'::jsonb, 'GitHub REST API (Personal Access Token).', NULL, 90000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.push_branch' AND version = 1)),
                ('github.open_pull_request', 'GitHub  Open pull request', ' pull request   .', 'github', 'MANUAL', '["github","pull-request","write"]'::jsonb, '["github-write"]'::jsonb, 'GitHub REST API (Personal Access Token).', NULL, 90000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.open_pull_request' AND version = 1)),
                ('github.approve_pull_request', 'GitHub  Approve pull request', ' approve-review  pull request    .', 'github', 'MANUAL', '["github","pull-request","review"]'::jsonb, '["github-write"]'::jsonb, 'GitHub REST API (Personal Access Token).', NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.approve_pull_request' AND version = 1)),
                ('github.merge_pull_request', 'GitHub  Merge pull request', ' merge pull request   .', 'github', 'MANUAL', '["github","pull-request","merge"]'::jsonb, '["github-write"]'::jsonb, 'GitHub REST API (Personal Access Token).', NULL, 90000,
                (SELECT id FROM tool_schema_version WHERE tool_code = 'github.merge_pull_request' AND version = 1));

  - changeSet:
      id: 0207b-seed-github-workspace-git-state
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('github.workspace_git_state', 1,
                 $${"type":"object","properties":{"workspaceId":{"type":"string","minLength":1},"includeFileStatus":{"type":"boolean"},"includeUntracked":{"type":"boolean"},"maxEntries":{"type":"integer","minimum":1},"includeSummaryOnly":{"type":"boolean"}},"required":["workspaceId"]}$$::jsonb,
                 $${"type":"object","properties":{"workspaceId":{"type":"string"},"branch":{"type":"object","properties":{"name":{"type":"string"},"headSha":{"type":"string"},"resolvedRef":{"type":"string"},"upstream":{"type":"string"},"detached":{"type":"boolean"},"ahead":{"type":"integer"},"behind":{"type":"integer"}},"required":["detached"]},"status":{"type":"object","properties":{"clean":{"type":"boolean"},"staged":{"type":"integer","minimum":0},"unstaged":{"type":"integer","minimum":0},"untracked":{"type":"integer","minimum":0},"conflicts":{"type":"integer","minimum":0}},"required":["clean","staged","unstaged","untracked","conflicts"]},"files":{"type":"array","items":{"type":"object","properties":{"path":{"type":"string"},"previousPath":{"type":"string"},"changeType":{"type":"string"},"staged":{"type":"boolean"},"unstaged":{"type":"boolean"},"tracked":{"type":"boolean"}},"required":["path","changeType","staged","unstaged","tracked"]}},"truncated":{"type":"boolean"},"warnings":{"type":"array","items":{"type":"string"}},"inspectedAt":{"type":"string","format":"date-time"},"durationMs":{"type":"integer","minimum":0}},"required":["workspaceId","branch","status","files","truncated","warnings","inspectedAt","durationMs"]}$$::jsonb,
                 'checksum-github.workspace_git_state-v1', '[]'::jsonb, 'github', 'github.workspace_git_state', 'http-stream', 'github')
              ON CONFLICT (tool_code, version) DO NOTHING;

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('github.workspace_git_state', 'GitHub  Workspace git state', ' , HEAD      workspace   git status.', 'github', 'AUTO', '["github","workspace","git"]'::jsonb, '["github-read"]'::jsonb, ' workspace', NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'github.workspace_git_state' AND version = 1))
              ON CONFLICT (code) DO NOTHING;

  - changeSet:
      id: 0208-add-repo-rag-tools
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('repo.rag_index_status', 1,
                 $${"type":"object","properties":{"repoOwner":{"type":"string"},"repoName":{"type":"string"}},"required":["repoOwner","repoName"]}$$::jsonb,
                 $${"type":"object","properties":{"repoOwner":{"type":"string"},"repoName":{"type":"string"},"status":{"type":"string"},"attempt":{"type":"integer"},"maxAttempts":{"type":"integer"},"progress":{"type":"number"},"etaSeconds":{"type":["integer","null"]},"filesProcessed":{"type":"integer"},"chunksProcessed":{"type":"integer"},"queuedAt":{"type":["string","null"]},"startedAt":{"type":["string","null"]},"completedAt":{"type":["string","null"]},"lastError":{"type":["string","null"]}},"required":["repoOwner","repoName","status","attempt","maxAttempts","progress","filesProcessed","chunksProcessed"]}$$::jsonb,
                 'checksum-repo.rag_index_status-v1', '[]'::jsonb, 'github', 'repo.rag_index_status', 'http-stream', 'github')
              ON CONFLICT (tool_code, version) DO NOTHING;

              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('repo.rag_search', 1,
                 $${"type":"object","properties":{"repoOwner":{"type":"string"},"repoName":{"type":"string"},"query":{"type":"string"},"topK":{"type":"integer","minimum":1,"maximum":40},"minScore":{"type":"number","minimum":0.1,"maximum":0.99},"rerankTopN":{"type":"integer","minimum":1,"maximum":40}},"required":["repoOwner","repoName","query"]}$$::jsonb,
                 $${"type":"object","properties":{"matches":{"type":"array","items":{"type":"object","properties":{"path":{"type":"string"},"snippet":{"type":"string"},"summary":{"type":"string"},"score":{"type":"number"},"metadata":{"type":"object"}},"required":["path","snippet","score"]}},"rerankApplied":{"type":"boolean"}},"required":["matches","rerankApplied"]}$$::jsonb,
                 'checksum-repo.rag_search-v1', '[]'::jsonb, 'github', 'repo.rag_search', 'http-stream', 'github')
              ON CONFLICT (tool_code, version) DO NOTHING;

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('repo.rag_index_status', 'GitHub  Repo RAG status', '    workspace: , ETA, .', 'github', 'MANUAL', '["github","rag"]'::jsonb, '["github-read"]'::jsonb, NULL, NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'repo.rag_index_status' AND version = 1))
              ON CONFLICT (code) DO NOTHING;

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('repo.rag_search', 'GitHub  Repo RAG search', '    namespace `repo:<owner>/<name>`  heuristic rerank.', 'github', 'MANUAL', '["github","rag"]'::jsonb, '["github-read"]'::jsonb, NULL, NULL, 120000,
                (SELECT id FROM tool_schema_version WHERE tool_code = 'repo.rag_search' AND version = 1))
              ON CONFLICT (code) DO NOTHING;

  - changeSet:
      id: 0210-update-repo-rag-search-schema
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('repo.rag_search', 2,
                 $${"type":"object","properties":{"repoOwner":{"type":"string"},"repoName":{"type":"string"},"query":{"type":"string"},"topK":{"type":"integer","minimum":1,"maximum":40},"minScore":{"type":"number","minimum":0.1,"maximum":0.99},"rerankTopN":{"type":"integer","minimum":1,"maximum":40},"filters":{"type":"object","properties":{"languages":{"type":"array","items":{"type":"string"}},"pathGlobs":{"type":"array","items":{"type":"string"}}}},"filterExpression":{"type":"string"}},"required":["repoOwner","repoName","query"]}$$::jsonb,
                 $${"type":"object","properties":{"matches":{"type":"array","items":{"type":"object","properties":{"path":{"type":"string"},"snippet":{"type":"string"},"summary":{"type":"string"},"score":{"type":"number"},"metadata":{"type":"object"}},"required":["path","snippet","score"]}},"rerankApplied":{"type":"boolean"}},"required":["matches","rerankApplied"]}$$::jsonb,
                 'checksum-repo.rag_search-v2', '[]'::jsonb, 'github', 'repo.rag_search', 'http-stream', 'github')
              ON CONFLICT (tool_code, version) DO NOTHING;

              UPDATE tool_definition
              SET schema_version_id = (SELECT id FROM tool_schema_version WHERE tool_code = 'repo.rag_search' AND version = 2)
              WHERE code = 'repo.rag_search';

  - changeSet:
      id: 0215-update-repo-rag-tools-wave31
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('repo.rag_search', 3,
                 $${"type":"object","properties":{"repoOwner":{"type":"string"},"repoName":{"type":"string"},"rawQuery":{"type":"string"},"topK":{"type":"integer","minimum":1,"maximum":40},"minScore":{"type":"number","minimum":0.1,"maximum":0.99},"rerankTopN":{"type":"integer","minimum":1,"maximum":40},"filters":{"type":"object","properties":{"languages":{"type":"array","items":{"type":"string"}},"pathGlobs":{"type":"array","items":{"type":"string"}}}},"filterExpression":{"type":"string"},"history":{"type":"array","items":{"type":"object","properties":{"role":{"type":"string"},"content":{"type":"string"}},"required":["role","content"]}},"previousAssistantReply":{"type":"string"},"allowEmptyContext":{"type":"boolean"},"translateTo":{"type":"string"},"multiQuery":{"type":"object","properties":{"enabled":{"type":"boolean"},"queries":{"type":"integer","minimum":1,"maximum":40}}},"maxContextTokens":{"type":"integer","minimum":256},"generationLocale":{"type":"string"},"instructionsTemplate":{"type":"string"}},"required":["repoOwner","repoName","rawQuery"]}$$::jsonb,
                 $${"type":"object","properties":{"matches":{"type":"array","items":{"type":"object","properties":{"path":{"type":"string"},"snippet":{"type":"string"},"summary":{"type":"string"},"score":{"type":"number"},"metadata":{"type":"object"}},"required":["path","snippet","score"]}},"rerankApplied":{"type":"boolean"},"augmentedPrompt":{"type":"string"},"instructions":{"type":"string"},"contextMissing":{"type":"boolean"},"appliedModules":{"type":"array","items":{"type":"string"}}},"required":["matches","rerankApplied","contextMissing","appliedModules"]}$$::jsonb,
                 'checksum-repo.rag_search-v3', '[]'::jsonb, 'github', 'repo.rag_search', 'http-stream', 'github')
              ON CONFLICT (tool_code, version) DO NOTHING;

              UPDATE tool_definition
              SET schema_version_id = (SELECT id FROM tool_schema_version WHERE tool_code = 'repo.rag_search' AND version = 3)
              WHERE code = 'repo.rag_search';

              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('repo.rag_search_simple', 1,
                 $${"type":"object","properties":{"rawQuery":{"type":"string"}},"required":["rawQuery"]}$$::jsonb,
                 $${"type":"object","properties":{"matches":{"type":"array","items":{"type":"object","properties":{"path":{"type":"string"},"snippet":{"type":"string"},"summary":{"type":"string"},"score":{"type":"number"},"metadata":{"type":"object"}},"required":["path","snippet","score"]}},"rerankApplied":{"type":"boolean"},"augmentedPrompt":{"type":"string"},"instructions":{"type":"string"},"contextMissing":{"type":"boolean"},"appliedModules":{"type":"array","items":{"type":"string"}}},"required":["matches","rerankApplied","contextMissing","appliedModules"]}$$::jsonb,
                 'checksum-repo.rag_search_simple-v1', '[]'::jsonb, 'github', 'repo.rag_search_simple', 'http-stream', 'github')
              ON CONFLICT (tool_code, version) DO NOTHING;

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('repo.rag_search_simple', 'GitHub  Repo RAG search (auto repo)', '    READY-namespace   repoOwner/repoName.   github.repository_fetch,  , , multi-query   post-processing.', 'github', 'MANUAL', '["github","rag"]'::jsonb, '["github-read"]'::jsonb, NULL, NULL, 120000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'repo.rag_search_simple' AND version = 1))
              ON CONFLICT (code) DO NOTHING;

  - changeSet:
      id: 0216-update-repo-rag-tools-v4
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('repo.rag_search', 4,
                 $${"type":"object","properties":{"repoOwner":{"type":"string"},"repoName":{"type":"string"},"rawQuery":{"type":"string"},"topK":{"type":"integer","minimum":1,"maximum":40},"topKPerQuery":{"type":"integer","minimum":1,"maximum":40},"minScore":{"type":"number","minimum":0.1,"maximum":0.99},"minScoreByLanguage":{"type":"object","additionalProperties":{"type":"number","minimum":0.1,"maximum":0.99}},"rerankTopN":{"type":"integer","minimum":1,"maximum":40},"rerankStrategy":{"type":"string"},"filters":{"type":"object","properties":{"languages":{"type":"array","items":{"type":"string"}},"pathGlobs":{"type":"array","items":{"type":"string"}}}},"filterExpression":{"type":"string"},"history":{"type":"array","items":{"type":"object","properties":{"role":{"type":"string"},"content":{"type":"string"}},"required":["role","content"]}},"previousAssistantReply":{"type":"string"},"allowEmptyContext":{"type":"boolean"},"useCompression":{"type":"boolean"},"translateTo":{"type":"string"},"multiQuery":{"type":"object","properties":{"enabled":{"type":"boolean"},"queries":{"type":"integer","minimum":1,"maximum":40},"maxQueries":{"type":"integer","minimum":1,"maximum":40}}},"maxContextTokens":{"type":"integer","minimum":256,"maximum":4000},"generationLocale":{"type":"string"},"instructionsTemplate":{"type":"string"}},"required":["repoOwner","repoName","rawQuery"]}$$::jsonb,
                 $${"type":"object","properties":{"matches":{"type":"array","items":{"type":"object","properties":{"path":{"type":"string"},"snippet":{"type":"string"},"summary":{"type":"string"},"score":{"type":"number"},"metadata":{"type":"object"}},"required":["path","snippet","score"]}},"rerankApplied":{"type":"boolean"},"augmentedPrompt":{"type":"string"},"instructions":{"type":"string"},"contextMissing":{"type":"boolean"},"noResults":{"type":"boolean"},"noResultsReason":{"type":["string","null"]},"appliedModules":{"type":"array","items":{"type":"string"}}},"required":["matches","rerankApplied","contextMissing","noResults","appliedModules"]}$$::jsonb,
                 'checksum-repo.rag_search-v4', '[]'::jsonb, 'github', 'repo.rag_search', 'http-stream', 'github')
              ON CONFLICT (tool_code, version) DO NOTHING;

              UPDATE tool_definition
              SET schema_version_id = (SELECT id FROM tool_schema_version WHERE tool_code = 'repo.rag_search' AND version = 4)
              WHERE code = 'repo.rag_search';

              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('repo.rag_search_simple', 2,
                 $${"type":"object","properties":{"rawQuery":{"type":"string"}},"required":["rawQuery"]}$$::jsonb,
                 $${"type":"object","properties":{"matches":{"type":"array","items":{"type":"object","properties":{"path":{"type":"string"},"snippet":{"type":"string"},"summary":{"type":"string"},"score":{"type":"number"},"metadata":{"type":"object"}},"required":["path","snippet","score"]}},"rerankApplied":{"type":"boolean"},"augmentedPrompt":{"type":"string"},"instructions":{"type":"string"},"contextMissing":{"type":"boolean"},"noResults":{"type":"boolean"},"noResultsReason":{"type":["string","null"]},"appliedModules":{"type":"array","items":{"type":"string"}}},"required":["matches","rerankApplied","contextMissing","noResults","appliedModules"]}$$::jsonb,
                 'checksum-repo.rag_search_simple-v2', '[]'::jsonb, 'github', 'repo.rag_search_simple', 'http-stream', 'github')
              ON CONFLICT (tool_code, version) DO NOTHING;

              UPDATE tool_definition
              SET schema_version_id = (SELECT id FROM tool_schema_version WHERE tool_code = 'repo.rag_search_simple' AND version = 2)
              WHERE code = 'repo.rag_search_simple';

  - changeSet:
      id: 0217-add-repo-rag-search-global
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('repo.rag_search_global', 1,
                 $${"type":"object","properties":{"rawQuery":{"type":"string"}},"required":["rawQuery"]}$$::jsonb,
                 $${"type":"object","properties":{"matches":{"type":"array","items":{"type":"object","properties":{"path":{"type":"string"},"snippet":{"type":"string"},"summary":{"type":"string"},"score":{"type":"number"},"metadata":{"type":"object"}},"required":["path","snippet","score"]}},"rerankApplied":{"type":"boolean"},"augmentedPrompt":{"type":"string"},"instructions":{"type":"string"},"contextMissing":{"type":"boolean"},"noResults":{"type":"boolean"},"noResultsReason":{"type":["string","null"]},"appliedModules":{"type":"array","items":{"type":"string"}}},"required":["matches","rerankApplied","contextMissing","noResults","appliedModules"]}$$::jsonb,
                 'checksum-repo.rag_search_global-v1', '[]'::jsonb, 'github', 'repo.rag_search_global', 'http-stream', 'github')
              ON CONFLICT (tool_code, version) DO NOTHING;

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('repo.rag_search_global', 'GitHub  Repo RAG search (global)', '     READY namespace (  repoOwner/repoName).       repo_owner/repo_name  metadata.', 'github', 'MANUAL', '["github","rag"]'::jsonb, '["github-read"]'::jsonb, NULL, NULL, 120000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'repo.rag_search_global' AND version = 1))
              ON CONFLICT (code) DO NOTHING;

  - changeSet:
      id: 0218-add-repo-rag-search-simple-global
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('repo.rag_search_simple_global', 1,
                 $${"type":"object","properties":{"rawQuery":{"type":"string"}},"required":["rawQuery"]}$$::jsonb,
                 $${"type":"object","properties":{"matches":{"type":"array","items":{"type":"object","properties":{"path":{"type":"string"},"snippet":{"type":"string"},"summary":{"type":"string"},"score":{"type":"number"},"metadata":{"type":"object"}},"required":["path","snippet","score"]}},"rerankApplied":{"type":"boolean"},"augmentedPrompt":{"type":"string"},"instructions":{"type":"string"},"contextMissing":{"type":"boolean"},"noResults":{"type":"boolean"},"noResultsReason":{"type":["string","null"]},"appliedModules":{"type":"array","items":{"type":"string"}}},"required":["matches","rerankApplied","contextMissing","noResults","appliedModules"]}$$::jsonb,
                 'checksum-repo.rag_search_simple_global-v1', '[]'::jsonb, 'github', 'repo.rag_search_simple_global', 'http-stream', 'github')
              ON CONFLICT (tool_code, version) DO NOTHING;

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('repo.rag_search_simple_global', 'GitHub  Repo RAG search (simple global)', '  :   rawQuery,  repo.rag_search_global         UI.', 'github', 'MANUAL', '["github","rag"]'::jsonb, '["github-read"]'::jsonb, NULL, NULL, 120000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'repo.rag_search_simple_global' AND version = 1))
              ON CONFLICT (code) DO NOTHING;
