databaseChangeLog:
  - changeSet:
      id: 0001-create-help-table
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: CREATE EXTENSION IF NOT EXISTS "vector";
        - createTable:
            tableName: help_content
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: message
                  type: TEXT
                  constraints:
                    nullable: false
  - changeSet:
      id: 0002-insert-initial-help-message
      author: ai-advent
      context: local,prod
      changes:
        - insert:
            tableName: help_content
            columns:
              - column:
                  name: message
                  value: 'AI Advent Challenge: explore available endpoints via /help.'
  - changeSet:
      id: 0003-update-help-message-api-prefix
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            sql: >
              UPDATE help_content
              SET message = 'AI Advent Challenge: explore available endpoints via /api/help.'
              WHERE message = 'AI Advent Challenge: explore available endpoints via /help.';
  - changeSet:
      id: 0004-create-chat-tables
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: CREATE EXTENSION IF NOT EXISTS "pgcrypto";
        - createTable:
            tableName: chat_session
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - createTable:
            tableName: chat_message
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: role
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: content
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: sequence_number
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: chat_message
            baseColumnNames: session_id
            referencedTableName: chat_session
            referencedColumnNames: id
            constraintName: fk_chat_message_session
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: chat_message
            columnNames: session_id, sequence_number
            constraintName: uq_chat_message_session_sequence
        - createIndex:
            tableName: chat_message
            indexName: idx_chat_message_session_sequence
            columns:
              - column:
                  name: session_id
              - column:
                  name: sequence_number
  - changeSet:
      id: 0005-create-chat-memory-window
      author: ai-advent
      context: local,prod
      changes:
        - createTable:
            tableName: chat_memory_message
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: message_order
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: role
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: content
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: metadata
                  type: TEXT
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: chat_memory_message
            baseColumnNames: session_id
            referencedTableName: chat_session
            referencedColumnNames: id
            constraintName: fk_chat_memory_session
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: chat_memory_message
            columnNames: session_id, message_order
            constraintName: uq_chat_memory_session_order
        - createIndex:
            tableName: chat_memory_message
            indexName: idx_chat_memory_session_order
            columns:
              - column:
                  name: session_id
              - column:
                  name: message_order
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              INSERT INTO chat_memory_message (id, session_id, message_order, role, content, metadata, created_at)
              SELECT gen_random_uuid(), session_id, message_order, role, content, metadata, created_at
              FROM (
                SELECT
                  cm.session_id,
                  cm.role,
                  cm.content,
                  '{}' AS metadata,
                  cm.created_at,
                  ROW_NUMBER() OVER (PARTITION BY cm.session_id ORDER BY cm.sequence_number ASC) AS message_order,
                  ROW_NUMBER() OVER (PARTITION BY cm.session_id ORDER BY cm.sequence_number DESC) AS rn
                FROM chat_message cm
              ) latest
              WHERE latest.rn <= 20
              ORDER BY latest.session_id, latest.message_order;
  - changeSet:
      id: 0006-extend-chat-message-with-provider
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: chat_message
            columns:
              - column:
                  name: provider
                  type: VARCHAR(64)
              - column:
                  name: model
                  type: VARCHAR(128)
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              UPDATE chat_message
              SET provider = COALESCE(provider, 'z.ai'),
                  model = COALESCE(model, 'glm-4.6');
  - changeSet:
      id: 0007-add-structured-payload-to-chat-message
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: chat_message
            columns:
              - column:
                  name: structured_payload
                  type: JSONB
        - createIndex:
            tableName: chat_message
            indexName: idx_chat_message_session_created_at
            columns:
              - column:
                  name: session_id
              - column:
                  name: created_at
  - changeSet:
      id: 0008-add-usage-cost-to-chat-message
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: chat_message
            columns:
              - column:
                  name: prompt_tokens
                  type: BIGINT
              - column:
                  name: completion_tokens
                  type: BIGINT
              - column:
                  name: total_tokens
                  type: BIGINT
              - column:
                  name: input_cost
                  type: NUMERIC(19, 8)
              - column:
                  name: output_cost
                  type: NUMERIC(19, 8)
              - column:
                  name: currency
                  type: VARCHAR(8)

  - changeSet:
      id: 0009-create-flow-orchestration-tables
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: CREATE EXTENSION IF NOT EXISTS "pgcrypto";
        - createTable:
            tableName: agent_definition
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: identifier
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: display_name
                  type: VARCHAR(256)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: is_active
                  type: BOOLEAN
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - createTable:
            tableName: agent_version
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: agent_definition_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: provider_type
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: provider_id
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: model_id
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: system_prompt
                  type: TEXT
              - column:
                  name: default_options
                  type: JSONB
              - column:
                  name: tool_bindings
                  type: JSONB
              - column:
                  name: cost_profile
                  type: JSONB
              - column:
                  name: sync_only
                  type: BOOLEAN
                  defaultValueBoolean: true
                  constraints:
                    nullable: false
              - column:
                  name: max_tokens
                  type: INT
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: published_at
                  type: TIMESTAMP WITH TIME ZONE
        - addForeignKeyConstraint:
            baseTableName: agent_version
            baseColumnNames: agent_definition_id
            referencedTableName: agent_definition
            referencedColumnNames: id
            constraintName: fk_agent_version_definition
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: agent_version
            columnNames: agent_definition_id, version
            constraintName: uq_agent_version_definition_version
        - createTable:
            tableName: agent_capability
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: agent_version_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: capability
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: payload
                  type: JSONB
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: agent_capability
            baseColumnNames: agent_version_id
            referencedTableName: agent_version
            referencedColumnNames: id
            constraintName: fk_agent_capability_version
            onDelete: CASCADE
        - createTable:
            tableName: flow_definition
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: name
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: is_active
                  type: BOOLEAN
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: definition
                  type: JSONB
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: updated_by
                  type: VARCHAR(128)
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: published_at
                  type: TIMESTAMP WITH TIME ZONE
        - addUniqueConstraint:
            tableName: flow_definition
            columnNames: name, version
            constraintName: uq_flow_definition_name_version
        - createIndex:
            tableName: flow_definition
            indexName: idx_flow_definition_active
            columns:
              - column:
                  name: is_active
        - createTable:
            tableName: flow_definition_history
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_definition_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: definition
                  type: JSONB
                  constraints:
                    nullable: false
              - column:
                  name: change_notes
                  type: TEXT
              - column:
                  name: created_by
                  type: VARCHAR(128)
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_definition_history
            baseColumnNames: flow_definition_id
            referencedTableName: flow_definition
            referencedColumnNames: id
            constraintName: fk_flow_definition_history_definition
            onDelete: CASCADE
        - createTable:
            tableName: flow_session
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_definition_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: flow_definition_version
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: current_step_id
                  type: VARCHAR(128)
              - column:
                  name: state_version
                  type: BIGINT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: current_memory_version
                  type: BIGINT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: launch_parameters
                  type: JSONB
              - column:
                  name: shared_context
                  type: JSONB
              - column:
                  name: telemetry
                  type: JSONB
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: started_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: completed_at
                  type: TIMESTAMP WITH TIME ZONE
        - addForeignKeyConstraint:
            baseTableName: flow_session
            baseColumnNames: flow_definition_id
            referencedTableName: flow_definition
            referencedColumnNames: id
            constraintName: fk_flow_session_definition
        - createIndex:
            tableName: flow_session
            indexName: idx_flow_session_status
            columns:
              - column:
                  name: status
        - createTable:
            tableName: flow_step_execution
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: step_id
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: step_name
                  type: VARCHAR(256)
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: attempt
                  type: INT
                  defaultValueNumeric: 1
                  constraints:
                    nullable: false
              - column:
                  name: agent_version_id
                  type: UUID
              - column:
                  name: prompt
                  type: TEXT
              - column:
                  name: input_payload
                  type: JSONB
              - column:
                  name: output_payload
                  type: JSONB
              - column:
                  name: usage
                  type: JSONB
              - column:
                  name: cost
                  type: JSONB
              - column:
                  name: error_code
                  type: VARCHAR(64)
              - column:
                  name: error_message
                  type: TEXT
              - column:
                  name: started_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: completed_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_step_execution
            baseColumnNames: flow_session_id
            referencedTableName: flow_session
            referencedColumnNames: id
            constraintName: fk_flow_step_execution_session
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: flow_step_execution
            baseColumnNames: agent_version_id
            referencedTableName: agent_version
            referencedColumnNames: id
            constraintName: fk_flow_step_execution_agent_version
        - createIndex:
            tableName: flow_step_execution
            indexName: idx_flow_step_execution_session_step
            columns:
              - column:
                  name: flow_session_id
              - column:
                  name: step_id
        - createTable:
            tableName: flow_memory_version
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: channel
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: data
                  type: JSONB
                  constraints:
                    nullable: false
              - column:
                  name: parent_version_id
                  type: BIGINT
              - column:
                  name: created_by_step_id
                  type: UUID
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_memory_version
            baseColumnNames: flow_session_id
            referencedTableName: flow_session
            referencedColumnNames: id
            constraintName: fk_flow_memory_session
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: flow_memory_version
            columnNames: flow_session_id, channel, version
            constraintName: uq_flow_memory_session_channel_version
        - createIndex:
            tableName: flow_memory_version
            indexName: idx_flow_memory_session_channel_version
            columns:
              - column:
                  name: flow_session_id
              - column:
                  name: channel
              - column:
                  name: version
                  descending: true
        - createTable:
            tableName: flow_event
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: flow_step_execution_id
                  type: UUID
              - column:
                  name: event_type
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
              - column:
                  name: payload
                  type: JSONB
              - column:
                  name: cost
                  type: NUMERIC(19, 8)
              - column:
                  name: tokens_prompt
                  type: INT
              - column:
                  name: tokens_completion
                  type: INT
              - column:
                  name: trace_id
                  type: VARCHAR(128)
              - column:
                  name: span_id
                  type: VARCHAR(128)
              - column:
                  name: usage_source
                  type: VARCHAR(32)
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_event
            baseColumnNames: flow_session_id
            referencedTableName: flow_session
            referencedColumnNames: id
            constraintName: fk_flow_event_session
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: flow_event
            baseColumnNames: flow_step_execution_id
            referencedTableName: flow_step_execution
            referencedColumnNames: id
            constraintName: fk_flow_event_step_execution
        - createIndex:
            tableName: flow_event
            indexName: idx_flow_event_session_created_at
            columns:
              - column:
                  name: flow_session_id
              - column:
                  name: created_at
        - createIndex:
            tableName: flow_event
            indexName: idx_flow_event_step_created_at
            columns:
              - column:
                  name: flow_step_execution_id
              - column:
                  name: created_at
        - createTable:
            tableName: flow_job
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_session_id
                  type: UUID
              - column:
                  name: flow_step_execution_id
                  type: UUID
              - column:
                  name: payload
                  type: JSONB
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: retry_count
                  type: INT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: scheduled_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: locked_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: locked_by
                  type: VARCHAR(128)
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_job
            baseColumnNames: flow_session_id
            referencedTableName: flow_session
            referencedColumnNames: id
            constraintName: fk_flow_job_session
        - addForeignKeyConstraint:
            baseTableName: flow_job
            baseColumnNames: flow_step_execution_id
            referencedTableName: flow_step_execution
            referencedColumnNames: id
            constraintName: fk_flow_job_step_execution
        - createIndex:
            tableName: flow_job
            indexName: idx_flow_job_status_scheduled
            columns:
              - column:
                  name: status
              - column:
                  name: scheduled_at

  - changeSet:
      id: 0010-add-agent-audit-fields
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: agent_definition
            columns:
              - column:
                  name: created_by
                  type: VARCHAR(128)
              - column:
                  name: updated_by
                  type: VARCHAR(128)
        - addColumn:
            tableName: agent_version
            columns:
              - column:
                  name: created_by
                  type: VARCHAR(128)
              - column:
                  name: updated_by
                  type: VARCHAR(128)
  - changeSet:
      id: 0011-add-flow-session-launch-overrides
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: flow_session
            columns:
              - column:
                  name: launch_overrides
                  type: JSONB
