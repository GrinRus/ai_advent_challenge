databaseChangeLog:
  - changeSet:
      id: 0001-create-help-table
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: CREATE EXTENSION IF NOT EXISTS "vector";
        - createTable:
            tableName: help_content
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: message
                  type: TEXT
                  constraints:
                    nullable: false
  - changeSet:
      id: 0002-insert-initial-help-message
      author: ai-advent
      context: local,prod
      changes:
        - insert:
            tableName: help_content
            columns:
              - column:
                  name: message
                  value: 'AI Advent Challenge: explore available endpoints via /help.'
  - changeSet:
      id: 0003-update-help-message-api-prefix
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            sql: >
              UPDATE help_content
              SET message = 'AI Advent Challenge: explore available endpoints via /api/help.'
              WHERE message = 'AI Advent Challenge: explore available endpoints via /help.';
  - changeSet:
      id: 0004-create-chat-tables
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: CREATE EXTENSION IF NOT EXISTS "pgcrypto";
        - createTable:
            tableName: chat_session
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - createTable:
            tableName: chat_message
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: role
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: content
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: sequence_number
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: chat_message
            baseColumnNames: session_id
            referencedTableName: chat_session
            referencedColumnNames: id
            constraintName: fk_chat_message_session
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: chat_message
            columnNames: session_id, sequence_number
            constraintName: uq_chat_message_session_sequence
        - createIndex:
            tableName: chat_message
            indexName: idx_chat_message_session_sequence
            columns:
              - column:
                  name: session_id
              - column:
                  name: sequence_number
  - changeSet:
      id: 0005-create-chat-memory-window
      author: ai-advent
      context: local,prod
      changes:
        - createTable:
            tableName: chat_memory_message
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: message_order
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: role
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: content
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: metadata
                  type: TEXT
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: chat_memory_message
            baseColumnNames: session_id
            referencedTableName: chat_session
            referencedColumnNames: id
            constraintName: fk_chat_memory_session
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: chat_memory_message
            columnNames: session_id, message_order
            constraintName: uq_chat_memory_session_order
        - createIndex:
            tableName: chat_memory_message
            indexName: idx_chat_memory_session_order
            columns:
              - column:
                  name: session_id
              - column:
                  name: message_order
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              INSERT INTO chat_memory_message (id, session_id, message_order, role, content, metadata, created_at)
              SELECT gen_random_uuid(), session_id, message_order, role, content, metadata, created_at
              FROM (
                SELECT
                  cm.session_id,
                  cm.role,
                  cm.content,
                  '{}' AS metadata,
                  cm.created_at,
                  ROW_NUMBER() OVER (PARTITION BY cm.session_id ORDER BY cm.sequence_number ASC) AS message_order,
                  ROW_NUMBER() OVER (PARTITION BY cm.session_id ORDER BY cm.sequence_number DESC) AS rn
                FROM chat_message cm
              ) latest
              WHERE latest.rn <= 20
              ORDER BY latest.session_id, latest.message_order;
  - changeSet:
      id: 0006-extend-chat-message-with-provider
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: chat_message
            columns:
              - column:
                  name: provider
                  type: VARCHAR(64)
              - column:
                  name: model
                  type: VARCHAR(128)
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              UPDATE chat_message
              SET provider = COALESCE(provider, 'z.ai'),
                  model = COALESCE(model, 'glm-4.6');
  - changeSet:
      id: 0007-add-structured-payload-to-chat-message
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: chat_message
            columns:
              - column:
                  name: structured_payload
                  type: JSONB
        - createIndex:
            tableName: chat_message
            indexName: idx_chat_message_session_created_at
            columns:
              - column:
                  name: session_id
              - column:
                  name: created_at
  - changeSet:
      id: 0008-add-usage-cost-to-chat-message
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: chat_message
            columns:
              - column:
                  name: prompt_tokens
                  type: BIGINT
              - column:
                  name: completion_tokens
                  type: BIGINT
              - column:
                  name: total_tokens
                  type: BIGINT
              - column:
                  name: input_cost
                  type: NUMERIC(19, 8)
              - column:
                  name: output_cost
                  type: NUMERIC(19, 8)
              - column:
                  name: currency
                  type: VARCHAR(8)

  - changeSet:
      id: 0009-create-flow-orchestration-tables
      author: ai-advent
      context: local,prod
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: CREATE EXTENSION IF NOT EXISTS "pgcrypto";
        - createTable:
            tableName: agent_definition
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: identifier
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: display_name
                  type: VARCHAR(256)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: is_active
                  type: BOOLEAN
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - createTable:
            tableName: agent_version
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: agent_definition_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: provider_type
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: provider_id
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: model_id
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: system_prompt
                  type: TEXT
              - column:
                  name: default_options
                  type: JSONB
              - column:
                  name: tool_bindings
                  type: JSONB
              - column:
                  name: cost_profile
                  type: JSONB
              - column:
                  name: sync_only
                  type: BOOLEAN
                  defaultValueBoolean: true
                  constraints:
                    nullable: false
              - column:
                  name: max_tokens
                  type: INT
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: published_at
                  type: TIMESTAMP WITH TIME ZONE
        - addForeignKeyConstraint:
            baseTableName: agent_version
            baseColumnNames: agent_definition_id
            referencedTableName: agent_definition
            referencedColumnNames: id
            constraintName: fk_agent_version_definition
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: agent_version
            columnNames: agent_definition_id, version
            constraintName: uq_agent_version_definition_version
        - createTable:
            tableName: agent_capability
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: agent_version_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: capability
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: payload
                  type: JSONB
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: agent_capability
            baseColumnNames: agent_version_id
            referencedTableName: agent_version
            referencedColumnNames: id
            constraintName: fk_agent_capability_version
            onDelete: CASCADE
        - createTable:
            tableName: flow_definition
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: name
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: is_active
                  type: BOOLEAN
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: definition
                  type: JSONB
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: updated_by
                  type: VARCHAR(128)
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: published_at
                  type: TIMESTAMP WITH TIME ZONE
        - addUniqueConstraint:
            tableName: flow_definition
            columnNames: name, version
            constraintName: uq_flow_definition_name_version
        - createIndex:
            tableName: flow_definition
            indexName: idx_flow_definition_active
            columns:
              - column:
                  name: is_active
        - createTable:
            tableName: flow_definition_history
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_definition_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: definition
                  type: JSONB
                  constraints:
                    nullable: false
              - column:
                  name: change_notes
                  type: TEXT
              - column:
                  name: created_by
                  type: VARCHAR(128)
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_definition_history
            baseColumnNames: flow_definition_id
            referencedTableName: flow_definition
            referencedColumnNames: id
            constraintName: fk_flow_definition_history_definition
            onDelete: CASCADE
        - createTable:
            tableName: flow_session
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_definition_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: flow_definition_version
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: current_step_id
                  type: VARCHAR(128)
              - column:
                  name: state_version
                  type: BIGINT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: current_memory_version
                  type: BIGINT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: launch_parameters
                  type: JSONB
              - column:
                  name: shared_context
                  type: JSONB
              - column:
                  name: telemetry
                  type: JSONB
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: started_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: completed_at
                  type: TIMESTAMP WITH TIME ZONE
        - addForeignKeyConstraint:
            baseTableName: flow_session
            baseColumnNames: flow_definition_id
            referencedTableName: flow_definition
            referencedColumnNames: id
            constraintName: fk_flow_session_definition
        - createIndex:
            tableName: flow_session
            indexName: idx_flow_session_status
            columns:
              - column:
                  name: status
        - createTable:
            tableName: flow_step_execution
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: step_id
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: step_name
                  type: VARCHAR(256)
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: attempt
                  type: INT
                  defaultValueNumeric: 1
                  constraints:
                    nullable: false
              - column:
                  name: agent_version_id
                  type: UUID
              - column:
                  name: prompt
                  type: TEXT
              - column:
                  name: input_payload
                  type: JSONB
              - column:
                  name: output_payload
                  type: JSONB
              - column:
                  name: usage
                  type: JSONB
              - column:
                  name: cost
                  type: JSONB
              - column:
                  name: error_code
                  type: VARCHAR(64)
              - column:
                  name: error_message
                  type: TEXT
              - column:
                  name: started_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: completed_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_step_execution
            baseColumnNames: flow_session_id
            referencedTableName: flow_session
            referencedColumnNames: id
            constraintName: fk_flow_step_execution_session
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: flow_step_execution
            baseColumnNames: agent_version_id
            referencedTableName: agent_version
            referencedColumnNames: id
            constraintName: fk_flow_step_execution_agent_version
        - createIndex:
            tableName: flow_step_execution
            indexName: idx_flow_step_execution_session_step
            columns:
              - column:
                  name: flow_session_id
              - column:
                  name: step_id
        - createTable:
            tableName: flow_memory_version
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: channel
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: data
                  type: JSONB
                  constraints:
                    nullable: false
              - column:
                  name: parent_version_id
                  type: BIGINT
              - column:
                  name: created_by_step_id
                  type: UUID
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_memory_version
            baseColumnNames: flow_session_id
            referencedTableName: flow_session
            referencedColumnNames: id
            constraintName: fk_flow_memory_session
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: flow_memory_version
            columnNames: flow_session_id, channel, version
            constraintName: uq_flow_memory_session_channel_version
        - createIndex:
            tableName: flow_memory_version
            indexName: idx_flow_memory_session_channel_version
            columns:
              - column:
                  name: flow_session_id
              - column:
                  name: channel
              - column:
                  name: version
                  descending: true
        - createTable:
            tableName: flow_event
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: flow_step_execution_id
                  type: UUID
              - column:
                  name: event_type
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
              - column:
                  name: payload
                  type: JSONB
              - column:
                  name: cost
                  type: NUMERIC(19, 8)
              - column:
                  name: tokens_prompt
                  type: INT
              - column:
                  name: tokens_completion
                  type: INT
              - column:
                  name: trace_id
                  type: VARCHAR(128)
              - column:
                  name: span_id
                  type: VARCHAR(128)
              - column:
                  name: usage_source
                  type: VARCHAR(32)
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_event
            baseColumnNames: flow_session_id
            referencedTableName: flow_session
            referencedColumnNames: id
            constraintName: fk_flow_event_session
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: flow_event
            baseColumnNames: flow_step_execution_id
            referencedTableName: flow_step_execution
            referencedColumnNames: id
            constraintName: fk_flow_event_step_execution
        - createIndex:
            tableName: flow_event
            indexName: idx_flow_event_session_created_at
            columns:
              - column:
                  name: flow_session_id
              - column:
                  name: created_at
        - createIndex:
            tableName: flow_event
            indexName: idx_flow_event_step_created_at
            columns:
              - column:
                  name: flow_step_execution_id
              - column:
                  name: created_at
        - createTable:
            tableName: flow_job
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_session_id
                  type: UUID
              - column:
                  name: flow_step_execution_id
                  type: UUID
              - column:
                  name: payload
                  type: JSONB
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: retry_count
                  type: INT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: scheduled_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: locked_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: locked_by
                  type: VARCHAR(128)
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_job
            baseColumnNames: flow_session_id
            referencedTableName: flow_session
            referencedColumnNames: id
            constraintName: fk_flow_job_session
        - addForeignKeyConstraint:
            baseTableName: flow_job
            baseColumnNames: flow_step_execution_id
            referencedTableName: flow_step_execution
            referencedColumnNames: id
            constraintName: fk_flow_job_step_execution
        - createIndex:
            tableName: flow_job
            indexName: idx_flow_job_status_scheduled
            columns:
              - column:
                  name: status
              - column:
                  name: scheduled_at

  - changeSet:
      id: 0010-add-agent-audit-fields
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: agent_definition
            columns:
              - column:
                  name: created_by
                  type: VARCHAR(128)
              - column:
                  name: updated_by
                  type: VARCHAR(128)
        - addColumn:
            tableName: agent_version
            columns:
              - column:
                  name: created_by
                  type: VARCHAR(128)
              - column:
                  name: updated_by
                  type: VARCHAR(128)
  - changeSet:
      id: 0011-add-flow-session-launch-overrides
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: flow_session
            columns:
              - column:
                  name: launch_overrides
                  type: JSONB
  - changeSet:
      id: 0012-create-flow-interaction-tables
      author: ai-advent
      context: local,prod
      changes:
        - createTable:
            tableName: flow_interaction_request
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: flow_step_execution_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: chat_session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: agent_version_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: type
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: title
                  type: VARCHAR(512)
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: payload_schema
                  type: JSONB
              - column:
                  name: suggested_actions
                  type: JSONB
              - column:
                  name: due_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_interaction_request
            baseColumnNames: flow_session_id
            referencedTableName: flow_session
            referencedColumnNames: id
            constraintName: fk_flow_interaction_session
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: flow_interaction_request
            baseColumnNames: flow_step_execution_id
            referencedTableName: flow_step_execution
            referencedColumnNames: id
            constraintName: fk_flow_interaction_step_execution
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: flow_interaction_request
            baseColumnNames: agent_version_id
            referencedTableName: agent_version
            referencedColumnNames: id
            constraintName: fk_flow_interaction_agent_version
        - createIndex:
            tableName: flow_interaction_request
            indexName: idx_flow_interaction_session_status
            columns:
              - column:
                  name: flow_session_id
              - column:
                  name: status
        - createIndex:
            tableName: flow_interaction_request
            indexName: idx_flow_interaction_step
            columns:
              - column:
                  name: flow_step_execution_id
        - createTable:
            tableName: flow_interaction_response
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: request_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: chat_session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: responded_by
                  type: UUID
              - column:
                  name: payload
                  type: JSONB
              - column:
                  name: source
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_interaction_response
            baseColumnNames: request_id
            referencedTableName: flow_interaction_request
            referencedColumnNames: id
            constraintName: fk_flow_interaction_response_request
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: flow_interaction_response
            columnNames: request_id
            constraintName: uq_flow_interaction_response_request
        - createIndex:
            tableName: flow_interaction_response
            indexName: idx_flow_interaction_response_request
            columns:
              - column:
                  name: request_id
  - changeSet:
      id: 0013-add-flow-session-chat-session-id
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: flow_session
            columns:
              - column:
                  name: chat_session_id
                  type: UUID
        - createIndex:
            tableName: flow_session
            indexName: idx_flow_session_chat_session_id
            columns:
              - column:
                  name: chat_session_id
  - changeSet:
      id: 0014-add-interaction-request-reference-to-step
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: flow_step_execution
            columns:
              - column:
                  name: interaction_request_id
                  type: UUID
        - addForeignKeyConstraint:
            baseTableName: flow_step_execution
            baseColumnNames: interaction_request_id
            referencedTableName: flow_interaction_request
            referencedColumnNames: id
            constraintName: fk_flow_step_execution_interaction
            onDelete: SET NULL
        - addUniqueConstraint:
            tableName: flow_step_execution
            columnNames: interaction_request_id
            constraintName: uq_flow_step_execution_interaction
  - changeSet:
      id: 0015-create-chat-memory-summary
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: chat_session
            columns:
              - column:
                  name: summary_until_order
                  type: INT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: summary_metadata
                  type: JSONB
        - createTable:
            tableName: chat_memory_summary
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: source_start_order
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: source_end_order
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: summary_text
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: token_count
                  type: BIGINT
              - column:
                  name: language
                  type: VARCHAR(16)
              - column:
                  name: metadata
                  type: JSONB
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: chat_memory_summary
            baseColumnNames: session_id
            referencedTableName: chat_session
            referencedColumnNames: id
            constraintName: fk_chat_memory_summary_session
            onDelete: CASCADE
        - createIndex:
            tableName: chat_memory_summary
            indexName: idx_chat_memory_summary_session_range
            columns:
              - column:
                  name: session_id
              - column:
                  name: source_start_order
              - column:
                  name: source_end_order
  - changeSet:
      id: 0016-create-flow-memory-summary
      author: ai-advent
      context: local,prod
      changes:
        - createTable:
            tableName: flow_memory_summary
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: flow_session_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: channel
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: step_id
                  type: VARCHAR(128)
              - column:
                  name: agent_version_id
                  type: UUID
              - column:
                  name: attempt_start
                  type: INT
              - column:
                  name: attempt_end
                  type: INT
              - column:
                  name: source_version_start
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: source_version_end
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: summary_text
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: token_count
                  type: BIGINT
              - column:
                  name: language
                  type: VARCHAR(16)
              - column:
                  name: metadata
                  type: JSONB
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: flow_memory_summary
            baseColumnNames: flow_session_id
            referencedTableName: flow_session
            referencedColumnNames: id
            constraintName: fk_flow_memory_summary_session
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: flow_memory_summary
            baseColumnNames: agent_version_id
            referencedTableName: agent_version
            referencedColumnNames: id
            constraintName: fk_flow_memory_summary_agent_version
        - createIndex:
            tableName: flow_memory_summary
            indexName: idx_flow_memory_summary_session_channel
            columns:
              - column:
                  name: flow_session_id
              - column:
                  name: channel
        - createIndex:
            tableName: flow_memory_summary
            indexName: idx_flow_memory_summary_step_attempt
            columns:
              - column:
                  name: step_id
              - column:
                  name: attempt_start
              - column:
                  name: attempt_end
  - changeSet:
      id: 0017-extend-flow-memory-version-metadata
      author: ai-advent
      context: local,prod
      changes:
        - addColumn:
            tableName: flow_memory_version
            columns:
              - column:
                  name: source_type
                  type: VARCHAR(32)
              - column:
                  name: step_id
                  type: VARCHAR(128)
              - column:
                  name: step_attempt
                  type: INT
              - column:
                  name: agent_version_id
                  type: UUID
  - changeSet:
      id: 20240608-agent-invocation-options
      author: codex
      context: local,prod
      changes:
        - addColumn:
            tableName: agent_version
            columns:
              - column:
                  name: agent_invocation_options
                  type: JSONB
                  defaultValueComputed: "'{}'::jsonb"
                  constraints:
                    nullable: false
        - dropColumn:
            tableName: agent_version
            columnName: default_options
        - dropColumn:
            tableName: agent_version
            columnName: tool_bindings
        - dropColumn:
            tableName: agent_version
            columnName: cost_profile
        - createTable:
            tableName: tool_schema_version
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: tool_code
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: request_schema
                  type: JSONB
              - column:
                  name: response_schema
                  type: JSONB
              - column:
                  name: schema_checksum
                  type: VARCHAR(64)
              - column:
                  name: examples
                  type: JSONB
              - column:
                  name: mcp_server
                  type: VARCHAR(128)
              - column:
                  name: mcp_tool_name
                  type: VARCHAR(128)
              - column:
                  name: transport
                  type: VARCHAR(64)
              - column:
                  name: auth_scope
                  type: VARCHAR(128)
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addUniqueConstraint:
            tableName: tool_schema_version
            columnNames: tool_code, version
            constraintName: uq_tool_schema_version_code_version
        - createTable:
            tableName: tool_definition
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: code
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: display_name
                  type: VARCHAR(160)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: provider_hint
                  type: VARCHAR(64)
              - column:
                  name: call_type
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: tags
                  type: JSONB
              - column:
                  name: capabilities
                  type: JSONB
              - column:
                  name: cost_hint
                  type: VARCHAR(128)
              - column:
                  name: icon_url
                  type: VARCHAR(256)
              - column:
                  name: default_timeout_ms
                  type: BIGINT
              - column:
                  name: schema_version_id
                  type: UUID
        - addForeignKeyConstraint:
            baseTableName: tool_definition
            baseColumnNames: schema_version_id
            referencedTableName: tool_schema_version
            referencedColumnNames: id
            constraintName: fk_tool_definition_schema_version
            onDelete: SET NULL
        - sql:
            splitStatements: false
            sql: |
              TRUNCATE TABLE flow_event,
                              flow_step_execution,
                              flow_job,
                              flow_memory_version,
                              flow_session,
                              flow_definition_history,
                              flow_definition,
                              agent_capability,
                              agent_version,
                              agent_definition
              RESTART IDENTITY CASCADE;
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              INSERT INTO tool_schema_version (tool_code, version, request_schema, response_schema, schema_checksum, examples, mcp_server, mcp_tool_name, transport, auth_scope)
              VALUES
                ('openai-gpt-4o', 1, '{}'::jsonb, '{}'::jsonb, 'checksum-openai-gpt-4o-v1', '[]'::jsonb, NULL, NULL, 'https', NULL),
                ('perplexity-research', 1, '{"type":"object","properties":{"query":{"type":"string"},"locale":{"type":"string"}},"required":["query"]}'::jsonb, '{"type":"object","properties":{"answer":{"type":"string"},"sources":{"type":"array","items":{"type":"object","properties":{"title":{"type":"string"},"url":{"type":"string"}}}}}}'::jsonb, 'checksum-perplexity-v1', '[]'::jsonb, 'perplexity', 'perplexity_research', 'stdio', 'perplexity');

              INSERT INTO tool_definition (code, display_name, description, provider_hint, call_type, tags, capabilities, cost_hint, icon_url, default_timeout_ms, schema_version_id)
              VALUES
                ('openai-gpt-4o', 'OpenAI GPT-4o', 'General purpose chat completion model', 'openai', 'AUTO', '["llm","chat"]'::jsonb, '["completion"]'::jsonb, 'See OpenAI pricing', NULL, 30000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'openai-gpt-4o' AND version = 1)),
                ('perplexity-research', 'Perplexity Research', 'Live research via MCP server', 'perplexity', 'AUTO', '["research","search"]'::jsonb, '["web-search"]'::jsonb, 'Usage billed by Perplexity', NULL, 60000,
                 (SELECT id FROM tool_schema_version WHERE tool_code = 'perplexity-research' AND version = 1));

              INSERT INTO agent_definition (id, identifier, display_name, description, is_active, created_at, updated_at, updated_by)
              VALUES
                (gen_random_uuid(), 'demo-openai-chat', 'Demo OpenAI Chat', 'Sample agent using OpenAI GPT-4o', true, now(), now(), 'seed'),
                (gen_random_uuid(), 'demo-researcher', 'Demo Researcher', 'Research agent leveraging Perplexity MCP tool', true, now(), now(), 'seed');

              WITH defs AS (
                SELECT id, identifier FROM agent_definition
              )
              INSERT INTO agent_version (
                id,
                agent_definition_id,
                version,
                status,
                provider_type,
                provider_id,
                model_id,
                system_prompt,
                agent_invocation_options,
                sync_only,
                max_tokens,
                created_by,
                updated_by,
                created_at,
                published_at)
              VALUES
                (gen_random_uuid(),
                 (SELECT id FROM defs WHERE identifier = 'demo-openai-chat'),
                 1,
                 'PUBLISHED',
                 'OPENAI',
                 'openai',
                 'gpt-4o',
                 'You are a helpful assistant that answers concisely.',
                 '{"provider":{"type":"OPENAI","id":"openai","modelId":"gpt-4o","mode":"SYNC"},"prompt":{"templateId":null,"system":null,"variables":[],"generation":{"temperature":0.2,"topP":0.9,"maxOutputTokens":800}},"memoryPolicy":{"channels":["shared","conversation"],"retentionDays":14,"maxEntries":100,"summarizationStrategy":"TAIL_WITH_SUMMARY","overflowAction":"TRIM_OLDEST"},"retryPolicy":{"maxAttempts":3,"initialDelayMs":250,"multiplier":2.0,"retryableStatuses":[429,500,502,503,504],"timeoutMs":30000,"overallDeadlineMs":90000,"jitterMs":100},"advisorSettings":{"telemetry":{"enabled":true},"audit":{"enabled":true,"redactPii":true},"routing":{"enabled":false}},"tooling":{"bindings":[]},"costProfile":{"inputPer1KTokens":0.01,"outputPer1KTokens":0.03,"currency":"USD"}}'::jsonb,
                 true,
                 1200,
                 'seed',
                 'seed',
                 now(),
                 now()),
                (gen_random_uuid(),
                 (SELECT id FROM defs WHERE identifier = 'demo-researcher'),
                 1,
                 'PUBLISHED',
                 'OPENAI',
                 'openai',
                 'gpt-4o-mini',
                 'You are an analyst that performs web research and summarizes findings.',
                 '{"provider":{"type":"OPENAI","id":"openai","modelId":"gpt-4o-mini","mode":"SYNC"},"prompt":{"templateId":null,"system":null,"variables":[],"generation":{"temperature":0.1,"topP":0.9,"maxOutputTokens":900}},"memoryPolicy":{"channels":["shared","conversation"],"retentionDays":30,"maxEntries":200,"summarizationStrategy":"TAIL_WITH_SUMMARY","overflowAction":"TRIM_OLDEST"},"retryPolicy":{"maxAttempts":4,"initialDelayMs":300,"multiplier":2.0,"retryableStatuses":[429,500,502,503,504],"timeoutMs":45000,"overallDeadlineMs":120000,"jitterMs":150},"advisorSettings":{"telemetry":{"enabled":true},"audit":{"enabled":true,"redactPii":true},"routing":{"enabled":false}},"tooling":{"bindings":[{"toolCode":"perplexity-research","schemaVersion":1,"executionMode":"AUTO"}]},"costProfile":{"inputPer1KTokens":0.008,"outputPer1KTokens":0.028,"currency":"USD","latencyFee":0.001}}'::jsonb,
                 true,
                 1400,
                 'seed',
                 'seed',
                 now(),
                 now());

              WITH openai_agent AS (
                SELECT id FROM agent_version
                WHERE version = 1
                  AND agent_definition_id = (SELECT id FROM agent_definition WHERE identifier = 'demo-openai-chat')
              ),
              researcher_agent AS (
                SELECT id FROM agent_version
                WHERE version = 1
                  AND agent_definition_id = (SELECT id FROM agent_definition WHERE identifier = 'demo-researcher')
              )
              INSERT INTO flow_definition (id, name, version, status, definition, is_active, created_at, updated_at, updated_by)
              SELECT
                gen_random_uuid(),
                'demo-lead-qualify',
                1,
                'PUBLISHED',
                jsonb_build_object(
                  'schemaVersion', 1,
                  'metadata', jsonb_build_object('title', 'Demo Lead Qualification', 'description', 'Example flow that gathers lead context and performs research.'),
                  'startStepId', 'gather_context',
                  'syncOnly', true,
                  'launchParameters', jsonb_build_array(jsonb_build_object('name','company','label','Company','type','string','required', true)),
                  'memory', jsonb_build_object('shared', jsonb_build_object('enabled', true)),
                  'steps', jsonb_build_array(
                      jsonb_build_object(
                        'id','gather_context',
                        'name','Gather Context',
                        'agentVersionId', (SELECT id FROM openai_agent),
                        'prompt','Capture the lead details and summarize them.',
                        'overrides', jsonb_build_object('maxTokens', 600),
                        'memoryWrites', jsonb_build_array(jsonb_build_object('channel','shared','mode','AGENT_OUTPUT')),
                        'transitions', jsonb_build_object('onSuccess', jsonb_build_object('next','perform_research'))
                      ),
                      jsonb_build_object(
                        'id','perform_research',
                        'name','Perform Research',
                        'agentVersionId', (SELECT id FROM researcher_agent),
                        'prompt','Use the research tool to find latest mentions and summarize findings.',
                        'memoryReads', jsonb_build_array(jsonb_build_object('channel','shared','limit',5)),
                        'memoryWrites', jsonb_build_array(jsonb_build_object('channel','shared','mode','AGENT_OUTPUT')),
                        'transitions', jsonb_build_object('onSuccess', jsonb_build_object('complete', true))
                      )
                  )
                ),
                true,
                now(),
                now(),
                'seed'
              FROM openai_agent, researcher_agent;
