databaseChangeLog:
  - changeSet:
      id: 0219-create-profile-audit
      author: codex
      context: local,prod
      changes:
        - createTable:
            tableName: profile_audit_event
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_profile_audit_event
              - column:
                  name: profile_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: event_type
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: source
                  type: VARCHAR(64)
              - column:
                  name: channel
                  type: VARCHAR(64)
              - column:
                  name: metadata
                  type: JSONB
                  defaultValueComputed: "'{}'::jsonb"
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: profile_audit_event
            baseColumnNames: profile_id
            referencedTableName: user_profile
            referencedColumnNames: id
            constraintName: fk_profile_audit_profile
            onDelete: CASCADE
        - createIndex:
            tableName: profile_audit_event
            indexName: idx_profile_audit_profile_created_at
            columns:
              - column:
                  name: profile_id
              - column:
                  name: created_at
            descending: true
