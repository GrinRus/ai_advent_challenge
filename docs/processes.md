# Процессы разработки

Документ описывает, как мы поддерживаем качество продукта, тестирование и документацию.

## Разработка
- Базовая ветка — `main`; для фич создавайте короткоживущие ветки с понятными именами.
- Коммиты атомарны, описывают изменения в утверждённом формате (`type: short summary`).
- Pull Request сопровождается ссылкой на задачу из `docs/backlog.md` или трекера.

## Тестирование
- Backend — запускайте `./gradlew test` и интеграционные сценарии перед PR.
- Frontend — `npm run test` (юнит-тесты) и визуальные проверки в Storybook/e2e по мере развития.
- При изменении LLM-клиента добавляйте регрессионные тесты (mock/stub), чтобы проверять модельные параметры и поток SSE.
- Изменения в памяти чата сопровождайте модульными и интеграционными проверками окна `ChatMemory` (SSE, восстановление диалога, очистка).
- Для plain sync (`/api/llm/chat/sync`) проверяйте сохранение текстовых сообщений, прокинутые usage/cost и обработку 429/5xx/пустых ответов.
- Для structured sync (`/api/llm/chat/sync/structured`) обязательны:
  - unit-тесты сериализации/десериализации и конфигурации `RetryTemplate` (проверяем попытки, статусы, exponential backoff);
  - интеграционные проверки сохранения `chat_message.structured_payload`, поведения при 422/429/5xx и лимита попыток.
- В e2e сценариях (Playwright/Cypress) проверяйте переключение вкладок чата, отображение структурированного ответа (summary/items/usage) и корректную обработку ошибок сервера.
- При работе с fallback-токенизацией добавляйте модульные тесты на `TokenUsageEstimator` и проверяйте кэш Redis (TTL, graceful degradation). В потоковых тестах фиксируйте значение `usageSource` (`native|fallback`), чтобы исключить регрессии в UI.

## CI/CD
- Workflow `.github/workflows/ci.yml` обязан проходить без модификации.
- Секреты деплоя хранятся в GitHub Secrets; локальные `.env` не коммитим.
- При обновлении пайплайнов обязательно документируйте изменения в `docs/infra.md`.

## Документация
- Перед слиянием проверяйте, что затронутые разделы обновлены.
- Если появился новый раздел, добавьте ссылку в `docs/overview.md`.
- В `docs/CONTRIBUTING.md` содержится чек-лист по проверке документации.
- При добавлении LLM-провайдеров или моделей обязательно синхронизируйте `application.yaml`, `.env.example`, `docker-compose.yml` и описание в `docs/infra.md` (таблица моделей, переменные окружения).

## Наблюдаемость
- При включении structured sync (`/sync/structured`) логируйте latency и значения `promptTokens/completionTokens/totalTokens`, чтобы быть готовыми к интеграции метрик в последующих волнах.
- Ошибки схемы фиксируйте на уровне WARN/ERROR с указанием провайдера, модели и `requestId`; при повторных провалах добавляйте fallback-инструкцию или эскалацию.
- StructuredSyncService уже пишет DEBUG/INFO с номером попытки и причиной остановки (429/5xx, schema). Не гасите эти логи в проде — по ним строится отчёт о стабильности провайдеров.
- Для внешних провайдеров без строгого JSON Schema внимательно анализируйте ретраи: указывайте в логах счётчик попыток и причину остановки.
- Стоимость и usage:
  - Spring AI отдаёт usage через `ChatResponseMetadata.getUsage()` — проверяйте, что провайдер возвращает значения, иначе стоимость будет равна `null`.
  - После релиза проверяйте `GET /api/llm/sessions/{id}/usage` и сравнивайте with billing dashboard провайдера; расхождения >5 % фиксируйте как баг.
  - Следите за валютой (`currency` из `ChatProvidersProperties.Model.pricing`). Если провайдер переключается на другую валюту, обновляйте конфигурацию и документацию.
  - В фронтенде не доверяйте кешу: при смене сессии запрашивайте usage повторно (см. `fetchSessionUsage`).
  - Если провайдер не возвращает usage, контролируйте fallback: в логах и API должно отображаться `usageSource=fallback`, а Redis-хит/мисс собирается метриками (см. Wave 8).
  - Метрики Micrometer: `chat.usage.native.count`/`chat.usage.fallback.count` (теги `provider`, `model`), `chat.usage.fallback.delta.tokens` (тег `segment = total|prompt|completion`) и `chat.token.cache.requests`/`chat.token.cache.latency` (тег `result = hit|miss|error|write|write_error`). Настройте алерты на рост доли `result=error` и абсолютное значение `fallback.delta`.

## Управление задачами
- Волны (Wave) фиксируются в `docs/backlog.md`.
- По завершении задачи отмечайте статус и указывайте дату/версию, если критично.
- Крупные изменения сопровождайте коротким пост-мортем или заметками в `docs/overview.md`.
