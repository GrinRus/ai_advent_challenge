databaseChangeLog:
  - changeSet:
      id: github-rag-0001
      author: ai-advent
      context: github-rag
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: CREATE EXTENSION IF NOT EXISTS "pgcrypto";
        - sql:
            splitStatements: false
            stripComments: true
            sql: CREATE EXTENSION IF NOT EXISTS "vector";
        - createTable:
            tableName: repo_rag_index_job
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: repo_owner
                  type: VARCHAR(180)
                  constraints:
                    nullable: false
              - column:
                  name: repo_name
                  type: VARCHAR(180)
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: attempt
                  type: INTEGER
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: max_attempts
                  type: INTEGER
                  defaultValueNumeric: 5
                  constraints:
                    nullable: false
              - column:
                  name: queued_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: started_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: completed_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: files_total
                  type: BIGINT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: files_processed
                  type: BIGINT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: chunks_total
                  type: BIGINT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: chunks_processed
                  type: BIGINT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: last_error
                  type: JSONB
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addUniqueConstraint:
            tableName: repo_rag_index_job
            columnNames: repo_owner, repo_name, queued_at
            constraintName: uq_repo_rag_index_job_repo_time
        - createIndex:
            tableName: repo_rag_index_job
            indexName: idx_repo_rag_job_repo
            columns:
              - column:
                  name: repo_owner
              - column:
                  name: repo_name
        - createIndex:
            tableName: repo_rag_index_job
            indexName: idx_repo_rag_job_status
            columns:
              - column:
                  name: status
        - createTable:
            tableName: repo_rag_vector_store
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: namespace
                  type: VARCHAR(256)
                  constraints:
                    nullable: false
              - column:
                  name: file_path
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: chunk_index
                  type: INTEGER
                  constraints:
                    nullable: false
              - column:
                  name: chunk_hash
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: language
                  type: VARCHAR(32)
              - column:
                  name: summary
                  type: TEXT
              - column:
                  name: content
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: metadata
                  type: JSONB
              - column:
                  name: embedding
                  type: VECTOR(1536)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addUniqueConstraint:
            tableName: repo_rag_vector_store
            columnNames: namespace, chunk_hash
            constraintName: uq_repo_rag_vector_store_namespace_hash
        - createIndex:
            tableName: repo_rag_vector_store
            indexName: idx_repo_rag_vector_store_namespace_path
            columns:
              - column:
                  name: namespace
              - column:
                  name: file_path
        - sql:
            splitStatements: false
            stripComments: true
            sql: CREATE INDEX IF NOT EXISTS idx_repo_rag_vector_store_embedding ON repo_rag_vector_store USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
  - changeSet:
      id: github-rag-0005-local-embedding
      author: ai-advent
      context: github-rag-local
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: DROP INDEX IF EXISTS idx_repo_rag_vector_store_embedding;
        - sql:
            splitStatements: false
            stripComments: true
            sql: ALTER TABLE repo_rag_vector_store ALTER COLUMN embedding TYPE VECTOR(1024);
        - sql:
            splitStatements: false
            stripComments: true
            sql: CREATE INDEX IF NOT EXISTS idx_repo_rag_vector_store_embedding ON repo_rag_vector_store USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
  - changeSet:
      id: github-rag-0002
      author: ai-advent
      context: github-rag
      changes:
        - dropUniqueConstraint:
            constraintName: uq_repo_rag_vector_store_namespace_hash
            tableName: repo_rag_vector_store
        - addUniqueConstraint:
            tableName: repo_rag_vector_store
            columnNames: namespace, file_path, chunk_index
            constraintName: uq_repo_rag_vector_store_namespace_path_idx
  - changeSet:
      id: github-rag-0003
      author: ai-advent
      context: github-rag
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              CREATE OR REPLACE FUNCTION repo_rag_vector_store_sync_columns()
              RETURNS trigger AS $$
              BEGIN
                NEW.namespace := COALESCE(NEW.metadata ->> 'namespace', NEW.namespace);
                NEW.file_path := COALESCE(NEW.metadata ->> 'file_path', NEW.file_path);
                NEW.chunk_index := COALESCE((NEW.metadata ->> 'chunk_index')::INT, NEW.chunk_index);
                NEW.chunk_hash := COALESCE(NEW.metadata ->> 'chunk_hash', NEW.chunk_hash);
                NEW.language := COALESCE(NEW.metadata ->> 'language', NEW.language);
                NEW.summary := COALESCE(NEW.metadata ->> 'summary', NEW.summary);
                RETURN NEW;
              END;
              $$ LANGUAGE plpgsql;

              DROP TRIGGER IF EXISTS repo_rag_vector_store_sync_columns ON repo_rag_vector_store;

              CREATE TRIGGER repo_rag_vector_store_sync_columns
              BEFORE INSERT OR UPDATE ON repo_rag_vector_store
              FOR EACH ROW EXECUTE FUNCTION repo_rag_vector_store_sync_columns();
  - changeSet:
      id: github-rag-0004
      author: ai-advent
      context: github-rag
      changes:
        - addColumn:
            tableName: repo_rag_index_job
            columns:
              - column:
                  name: files_skipped
                  type: BIGINT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
        - createTable:
            tableName: repo_rag_file_state
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: namespace
                  type: VARCHAR(256)
                  constraints:
                    nullable: false
              - column:
                  name: file_path
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: file_hash
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: chunk_count
                  type: INTEGER
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addUniqueConstraint:
            tableName: repo_rag_file_state
            columnNames: namespace, file_path
            constraintName: uq_repo_rag_file_state_namespace_path
        - createIndex:
            tableName: repo_rag_file_state
            indexName: idx_repo_rag_file_state_namespace
            columns:
              - column:
                  name: namespace
        - createTable:
            tableName: repo_rag_namespace_state
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: namespace
                  type: VARCHAR(256)
                  constraints:
                    nullable: false
              - column:
                  name: repo_owner
                  type: VARCHAR(180)
                  constraints:
                    nullable: false
              - column:
                  name: repo_name
                  type: VARCHAR(180)
                  constraints:
                    nullable: false
              - column:
                  name: source_ref
                  type: VARCHAR(256)
              - column:
                  name: commit_sha
                  type: VARCHAR(64)
              - column:
                  name: workspace_id
                  type: VARCHAR(64)
              - column:
                  name: files_total
                  type: BIGINT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: chunks_total
                  type: BIGINT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: files_skipped
                  type: BIGINT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: workspace_size_bytes
                  type: BIGINT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: fetched_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: last_indexed_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: is_ready
                  type: BOOLEAN
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: last_job_id
                  type: UUID
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - addUniqueConstraint:
            tableName: repo_rag_namespace_state
            columnNames: namespace
            constraintName: uq_repo_rag_namespace_state_namespace
        - createIndex:
            tableName: repo_rag_namespace_state
            indexName: idx_repo_rag_namespace_owner_repo
            columns:
              - column:
                  name: repo_owner
              - column:
                  name: repo_name
        - addForeignKeyConstraint:
            baseTableName: repo_rag_namespace_state
            baseColumnNames: last_job_id
            referencedTableName: repo_rag_index_job
            referencedColumnNames: id
            constraintName: fk_repo_rag_namespace_state_job
            onDelete: SET NULL
  - changeSet:
      id: github-rag-0005
      author: ai-advent
      context: github-rag
      changes:
        - createTable:
            tableName: repo_rag_symbol_graph
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
              - column:
                  name: namespace
                  type: VARCHAR(256)
                  constraints:
                    nullable: false
              - column:
                  name: file_path
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: chunk_index
                  type: INTEGER
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: chunk_hash
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: symbol_fqn
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: symbol_kind
                  type: VARCHAR(64)
              - column:
                  name: referenced_symbol_fqn
                  type: TEXT
              - column:
                  name: relation
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - createIndex:
            tableName: repo_rag_symbol_graph
            indexName: idx_repo_rag_symbol_graph_symbol
            columns:
              - column:
                  name: namespace
              - column:
                  name: symbol_fqn
        - createIndex:
            tableName: repo_rag_symbol_graph
            indexName: idx_repo_rag_symbol_graph_referenced
            columns:
              - column:
                  name: namespace
              - column:
                  name: referenced_symbol_fqn
  - changeSet:
      id: github-rag-0006
      author: ai-advent
      context: github-rag
      changes:
        - createTable:
            tableName: repo_rag_metadata_schema
            columns:
              - column:
                  name: version
                  type: INTEGER
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - insert:
            tableName: repo_rag_metadata_schema
            columns:
              - column:
                  name: version
                  valueNumeric: 2
              - column:
                  name: description
                  value: 'AST-aware chunk metadata schema'
  - changeSet:
      id: github-rag-0007
      author: ai-advent
      context: github-rag
      changes:
        - addColumn:
            tableName: repo_rag_namespace_state
            columns:
              - column:
                  name: ast_schema_version
                  type: INTEGER
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: ast_ready_at
                  type: TIMESTAMP WITH TIME ZONE
