server:
  port: ${GITHUB_MCP_HTTP_PORT:${SERVER_PORT:8080}}

spring:
  autoconfigure:
    exclude: []
  datasource:
    url: ${GITHUB_MCP_DB_URL:jdbc:postgresql://localhost:5432/ai_advent}
    username: ${GITHUB_MCP_DB_USER:ai_advent}
    password: ${GITHUB_MCP_DB_PASSWORD:ai_advent}
    driver-class-name: org.postgresql.Driver
  jpa:
    open-in-view: false
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
  liquibase:
    change-log: classpath:db/changelog/github/db.changelog-master.yaml
    contexts: github-rag
  ai:
    mcp:
      server:
        enabled: true
        stdio: false
        protocol: STREAMABLE
        name: github-mcp
        version: 0.1.0
        type: SYNC
        annotation-scanner:
          enabled: false
        instructions: |
          GitHub MCP предоставляет инструменты для чтения дерева репозитория и содержимого файлов.
          Убедитесь, что Personal Access Token имеет права чтения репозитория (pull requests, contents, checks).
        capabilities:
          tool: true
          resource: false
          prompt: false
          completion: false
      streamable-http:
        mcp-endpoint: /mcp
        keep-alive-interval: 30s
    openai:
      enabled: true
      api-key: ${OPENAI_API_KEY:demo-openai-key}
      base-url: ${OPENAI_BASE_URL:https://api.openai.com/v1}
      embedding:
        options:
          model: ${GITHUB_RAG_EMBEDDING_MODEL:text-embedding-3-small}
          dimensions: ${GITHUB_RAG_EMBEDDING_DIMENSIONS:1536}

github:
  backend:
    base-url: ${GITHUB_API_BASE_URL:https://api.github.com}
    personal-access-token: ${GITHUB_PAT:}
    connect-timeout: ${GITHUB_CONNECT_TIMEOUT:PT15S}
    read-timeout: ${GITHUB_READ_TIMEOUT:PT45S}
    tree-cache-ttl: ${GITHUB_TREE_CACHE_TTL:PT2M}
    file-cache-ttl: ${GITHUB_FILE_CACHE_TTL:PT2M}
    tree-max-depth: ${GITHUB_TREE_MAX_DEPTH:4}
    tree-max-entries: ${GITHUB_TREE_MAX_ENTRIES:500}
    file-max-size-bytes: ${GITHUB_FILE_MAX_SIZE_BYTES:524288}
    user-agent: ${GITHUB_USER_AGENT:AI Advent GitHub MCP/0.1}
  rag:
    namespace-prefix: ${GITHUB_RAG_NAMESPACE_PREFIX:repo}
    max-concurrency: ${GITHUB_RAG_MAX_CONCURRENCY:2}
    chunking:
      strategy: ${GITHUB_RAG_CHUNKING_STRATEGY:line}
      overlap-lines: ${GITHUB_RAG_CHUNKING_OVERLAP_LINES:20}
      overlap-tokens: ${GITHUB_RAG_CHUNKING_OVERLAP_TOKENS:120}
      line:
        max-lines: ${GITHUB_RAG_CHUNKING_LINE_MAX_LINES:160}
        max-bytes: ${GITHUB_RAG_CHUNKING_LINE_MAX_BYTES:2048}
      byte-strategy:
        max-bytes: ${GITHUB_RAG_CHUNKING_BYTE_MAX_BYTES:4096}
      token:
        chunk-size-tokens: ${GITHUB_RAG_CHUNKING_TOKEN_CHUNK_SIZE:800}
        min-chunk-chars: ${GITHUB_RAG_CHUNKING_TOKEN_MIN_CHARS:200}
        min-chunk-length-to-embed: ${GITHUB_RAG_CHUNKING_TOKEN_MIN_EMBED:40}
        max-num-chunks: ${GITHUB_RAG_CHUNKING_TOKEN_MAX_CHUNKS:10000}
      semantic:
        enabled: ${GITHUB_RAG_CHUNKING_SEMANTIC_ENABLED:false}
        splitter-class: ${GITHUB_RAG_CHUNKING_SEMANTIC_SPLITTER:org.springframework.ai.transformer.splitter.SemanticTextSplitter}
        chunk-size-tokens: ${GITHUB_RAG_CHUNKING_SEMANTIC_CHUNK_SIZE:1024}
    ast:
      enabled: ${GITHUB_RAG_AST_ENABLED:false}
      languages:
        - java
        - kotlin
        - typescript
        - javascript
        - python
        - go
      library-path: ${GITHUB_RAG_AST_LIBRARY_PATH:classpath:treesitter}
      health:
        failure-threshold: ${GITHUB_RAG_AST_FAILURE_THRESHOLD:3}
    retry:
      max-attempts: ${GITHUB_RAG_MAX_ATTEMPTS:5}
      initial-backoff: ${GITHUB_RAG_INITIAL_BACKOFF:PT15S}
    embedding:
      model: ${GITHUB_RAG_EMBEDDING_MODEL:text-embedding-3-small}
      dimensions: ${GITHUB_RAG_EMBEDDING_DIMENSIONS:1536}
    rerank:
      top-n: ${GITHUB_RAG_RERANK_TOP_N:8}
      score-weight: ${GITHUB_RAG_RERANK_SCORE_WEIGHT:0.8}
      line-span-weight: ${GITHUB_RAG_RERANK_LINE_SPAN_WEIGHT:0.2}
      max-snippet-lines: ${GITHUB_RAG_MAX_SNIPPET_LINES:8}
      code-aware:
        enabled: ${GITHUB_RAG_RERANK_CODE_AWARE_ENABLED:true}
        default-head-multiplier: ${GITHUB_RAG_RERANK_CODE_AWARE_HEAD_MULTIPLIER:2.0}
        max-head-multiplier: ${GITHUB_RAG_RERANK_CODE_AWARE_MAX_HEAD_MULTIPLIER:4.0}
        score:
          weight: ${GITHUB_RAG_RERANK_CODE_AWARE_SCORE_WEIGHT:0.75}
          span-weight: ${GITHUB_RAG_RERANK_CODE_AWARE_SPAN_WEIGHT:0.25}
        diversity:
          max-per-file: ${GITHUB_RAG_RERANK_CODE_AWARE_DIVERSITY_MAX_PER_FILE:3}
          max-per-symbol: ${GITHUB_RAG_RERANK_CODE_AWARE_DIVERSITY_MAX_PER_SYMBOL:2}
        path-penalty:
          penalty-multiplier: ${GITHUB_RAG_RERANK_CODE_AWARE_PATH_PENALTY:0.6}
          deny-prefixes:
            - generated/
            - testdata/
            - node_modules/
          allow-prefixes: []
        language-bonus: {}
        symbol-priority: {}
    query-transformers:
      enabled: ${GITHUB_RAG_QUERY_TRANSFORMERS_ENABLED:true}
      max-history-tokens: ${GITHUB_RAG_QUERY_TRANSFORMERS_MAX_HISTORY_TOKENS:1600}
      default-target-language: ${GITHUB_RAG_QUERY_TRANSFORMERS_DEFAULT_TARGET_LANGUAGE:ru}
      model: ${GITHUB_RAG_QUERY_TRANSFORMERS_MODEL:gpt-4o-mini}
      temperature: ${GITHUB_RAG_QUERY_TRANSFORMERS_TEMPERATURE:0.0}
    multi-query:
      enabled: ${GITHUB_RAG_MULTI_QUERY_ENABLED:true}
      default-queries: ${GITHUB_RAG_MULTI_QUERY_DEFAULT_QUERIES:3}
      max-queries: ${GITHUB_RAG_MULTI_QUERY_MAX_QUERIES:6}
    post-processing:
      max-context-tokens: ${GITHUB_RAG_POST_MAX_CONTEXT_TOKENS:4000}
      llm-compression-enabled: ${GITHUB_RAG_POST_LLM_COMPRESSION_ENABLED:true}
      llm-compression-model: ${GITHUB_RAG_POST_LLM_COMPRESSION_MODEL:gpt-4o-mini}
      llm-compression-temperature: ${GITHUB_RAG_POST_LLM_COMPRESSION_TEMPERATURE:0.1}
      neighbor:
        enabled: ${GITHUB_RAG_POST_NEIGHBOR_ENABLED:true}
        default-radius: ${GITHUB_RAG_POST_NEIGHBOR_DEFAULT_RADIUS:1}
        default-limit: ${GITHUB_RAG_POST_NEIGHBOR_DEFAULT_LIMIT:6}
        max-radius: ${GITHUB_RAG_POST_NEIGHBOR_MAX_RADIUS:5}
        max-limit: ${GITHUB_RAG_POST_NEIGHBOR_MAX_LIMIT:12}
        strategy: ${GITHUB_RAG_POST_NEIGHBOR_STRATEGY:LINEAR}
        auto-call-graph-enabled: ${GITHUB_RAG_POST_NEIGHBOR_AUTO_CALL_GRAPH_ENABLED:false}
        call-graph-limit: ${GITHUB_RAG_POST_NEIGHBOR_CALL_GRAPH_LIMIT:8}
    generation:
      allow-empty-context: ${GITHUB_RAG_GENERATION_ALLOW_EMPTY_CONTEXT:true}
      prompt-template: classpath:prompts/github-rag-context.st
      empty-context-template: classpath:prompts/github-rag-empty-context.st
      summary-template: classpath:prompts/github-rag-summary.st
      no-results-reason: ${GITHUB_RAG_GENERATION_NO_RESULTS_REASON:CONTEXT_NOT_FOUND}
      empty-context-message: "${GITHUB_RAG_GENERATION_EMPTY_MESSAGE:Индекс не содержит подходящих документов}"
    default-profile: ${GITHUB_RAG_DEFAULT_PROFILE:balanced}
    parameter-profiles:
      - name: conservative
        top-k: 15
        top-k-per-query: 15
        min-score: 0.65
        min-score-fallback: 0.5
        min-score-classifier: overview
        overview-boost-keywords:
          - overview
          - project overview
          - описание проекта
          - что за проект
          - docs/backlog.md
        multi-query:
          enabled: false
          queries: 1
          max-queries: 3
        neighbor:
          strategy: OFF
          radius: 0
          limit: 0
        code-aware-enabled: true
        code-aware-head-multiplier: 1.5
      - name: balanced
        top-k: 24
        top-k-per-query: 24
        min-score: 0.55
        min-score-fallback: 0.35
        min-score-classifier: overview
        overview-boost-keywords:
          - overview
          - project overview
          - описание проекта
          - что за проект
          - docs/backlog.md
        multi-query:
          enabled: true
          queries: 3
          max-queries: 4
        neighbor:
          strategy: LINEAR
          radius: 1
          limit: 6
        code-aware-enabled: true
        code-aware-head-multiplier: 2.0
      - name: aggressive
        top-k: 35
        top-k-per-query: 35
        min-score: 0.5
        min-score-fallback: 0.35
        min-score-classifier: overview
        overview-boost-keywords:
          - overview
          - project overview
          - описание проекта
          - что за проект
          - docs/backlog.md
          - readme
        multi-query:
          enabled: true
          queries: 4
          max-queries: 6
        neighbor:
          strategy: CALL_GRAPH
          radius: 2
          limit: 10
        code-aware-enabled: true
        code-aware-head-multiplier: 2.5
